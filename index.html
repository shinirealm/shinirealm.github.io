<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shinigami Realm</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* --- CSS Variables for Theming --- */
    :root {
      --primary: #00ccff;
      /* Bright Cyan */
      --primary-dark: #0099cc;
      /* Darker Cyan */
      --secondary: #00ff88;
      /* Vibrant Green */
      --secondary-dark: #00e676;
      /* Darker Vibrant Green */
      --background: #0a0a0a;
      /* Deep Dark Background */
      --card-bg: #1a1a1a;
      /* Slightly Lighter Dark for Cards */
      --text: #e0f7ff;
      /* Light Blue-White for Primary Text */
      --text-secondary: #b0b0b0;
      /* Grey for Secondary Text */
      --border: rgba(0, 204, 255, 0.3);
      /* Semi-transparent Primary Border */
      --mythical: #ff00ff;
      /* Magenta for Mythical Rarity */
      --legendary: #ffaa00;
      /* Orange for Legendary Rarity */
      --rare: #5555ff;
      /* Blue for Rare Rarity */
      --uncommon: #55ff55;
      /* Green for Uncommon Rarity */
      --common: #e0f7ff;
      /* Light Blue-White for Common Rarity */
      --error: #ff4d4d;
      /* Red for Error Messages */
      --claim-ready: #00ff88;
      /* Bright Green for Claim Button */
      --claim-ready-shadow: rgba(0, 255, 136, 0.5);
      /* Green Shadow for Claim Button */
      --warning: #ffcc00;
      /* Yellow for Warning Messages */
      --accept-color: #28a745;
      /* Dark Green for Accept Button */
      --decline-color: #dc3545;
      /* Dark Red for Decline Button */
      --success-msg-bg: rgba(0, 255, 136, 0.2);
      /* Light Green for Success Message Background */
      --error-msg-bg: rgba(255, 77, 77, 0.2);
      /* Light Red for Error Message Background */
      --info-msg-bg: rgba(0, 204, 255, 0.2);
      /* Light Cyan for Info Message Background */
    }

    /* --- Global Styles --- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }

    body {
      background: linear-gradient(to bottom, var(--background) 0%, #050505 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      overflow-x: hidden;
      line-height: 1.6;
      /* Add padding-bottom to prevent fixed bar from overlapping footer */
      padding-bottom: 70px;
      /* Adjust this value if the total-display height changes significantly */
    }

    /* --- Canvas Background --- */
    #backgroundCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.2;
      /* Subtler background */
      background-color: #000;
      /* Fallback */
    }

    /* --- Header & Navigation --- */
    header {
      background-color: var(--card-bg);
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: flex-start;
      /* Align items to the start */
      align-items: center;
      flex-wrap: wrap;
      position: relative;
      z-index: 100;
      /* Increased z-index for header to be above content */
      box-shadow: 0 4px 20px rgba(0, 204, 255, 0.4);
      /* Stronger shadow */
    }

    .logo {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
      text-shadow: 0 0 8px var(--primary), 0 0 15px rgba(0, 204, 255, 0.6);
      text-decoration: none;
      transition: text-shadow 0.3s ease;
      cursor: pointer;
      /* Added for redirect */
    }

    .logo:hover {
      text-shadow: 0 0 10px var(--primary), 0 0 20px rgba(0, 204, 255, 0.8);
    }

    /* Realm Coin Display in Header (Left Side) */
    .realm-coin-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background-color: rgba(0, 255, 136, 0.1);
      border: 1px solid var(--secondary);
      border-radius: 20px;
      padding: 0.4rem 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
      margin-left: 1.5rem;
      /* Space from logo */
    }

    .realm-coin-display:hover {
      background-color: rgba(0, 255, 136, 0.2);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
    }

    .realm-coin-icon {
      font-size: 1.2em; /* Adjusted for better diamond look */
      color: #e0f7ff; /* A subtle diamond color */
      text-shadow: 0 0 5px rgba(0, 204, 255, 0.5);
    }

    .realm-coin-amount {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--secondary);
    }

    /* Spacer to push hamburger to the right */
    .header-spacer {
      flex-grow: 1;
    }

    /* Hamburger Icon */
    .nav-toggle {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 30px;
      height: 24px;
      /* Adjusted height for 3 bars */
      background: none;
      border: none;
      cursor: pointer;
      z-index: 11;
      transition: transform 0.3s ease;
      padding: 0;
      /* Ensure no padding affects height */
    }

    .nav-toggle span {
      display: block;
      height: 4px;
      /* Height of each bar */
      background-color: var(--primary);
      border-radius: 3px;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
      box-shadow: 0 0 6px var(--primary);
      width: 100%;
      /* Ensure bars take full width */
    }

    .nav-toggle.active span:nth-child(1) {
      transform: translateY(10px) rotate(45deg);
      /* Move down and rotate */
    }

    .nav-toggle.active span:nth-child(2) {
      opacity: 0;
      /* Hide middle bar */
    }

    .nav-toggle.active span:nth-child(3) {
      transform: translateY(-10px) rotate(-45deg);
      /* Move up and rotate */
    }

    /* Navigation Content (Vertical List) */
    nav {
      display: none;
      /* Hidden by default */
      flex-direction: column;
      position: absolute;
      top: 100%;
      /* Position below header */
      right: 0;
      /* Align to the right */
      width: 100%;
      /* Full width on mobile */
      max-width: 300px;
      /* Max width for desktop dropdown */
      background-color: var(--card-bg);
      border-top: 1px solid var(--border);
      box-shadow: 0 8px 20px rgba(0, 204, 255, 0.3);
      animation: slideDown 0.3s ease-out forwards;
      padding: 1.5rem 2rem;
      gap: 1rem;
      /* Space between nav items */
      z-index: 999;
      /* Increased z-index to overlay everything else */
    }

    nav.active {
      display: flex;
      /* Show when active */
    }

    nav ul {
      list-style: none;
      display: flex;
      flex-direction: column;
      /* Always vertical */
      gap: 1rem;
      width: 100%;
      align-items: flex-start;
      /* Align links to the left */
    }

    nav a {
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease, text-shadow 0.3s ease, transform 0.2s ease;
      padding: 0.6rem 0;
      white-space: nowrap;
      position: relative;
      width: 100%;
      /* Make links take full width for better click area */
      text-align: left;
      /* Align text to left */
    }

    nav a:hover,
    nav a.active {
      color: var(--primary);
      text-shadow: 0 0 6px var(--primary);
      transform: translateY(-2px);
    }

    nav a.active::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 2px;
      background-color: var(--primary);
      box-shadow: 0 0 8px var(--primary);
      animation: underlineGrow 0.3s forwards;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes underlineGrow {
      from {
        transform: scaleX(0);
      }
      to {
        transform: scaleX(1);
      }
    }

    /* Auth Status & Buttons within Nav (Hamburger Menu) */
    .nav-utility-items {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(0, 204, 255, 0.1);
      align-items: flex-start;
      /* Align to left */
    }

    .auth-status {
      color: var(--text-secondary);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      /* Ensure it doesn't overflow */
      text-align: left;
    }

    .nav-utility-items button {
      background-color: var(--primary);
      color: var(--background);
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 6px 15px rgba(0, 204, 255, 0.4);
      text-decoration: none;
      display: inline-block;
      text-align: center;
      letter-spacing: 0.5px;
      width: auto;
      /* Allow buttons to size naturally */
    }

    .nav-utility-items button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0, 204, 255, 0.6);
    }


    /* --- Main Content Area --- */
    main {
      flex-grow: 1;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    section {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      /* More rounded corners */
      padding: 2.5rem;
      /* More padding */
      margin-bottom: 2.5rem;
      /* More margin */
      box-shadow: 0 8px 25px rgba(0, 204, 255, 0.3);
      /* Stronger shadow */
      animation: fadeIn 0.6s ease-out;
      display: none;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      /* Add transition for hover */
    }

    section:hover {
      transform: translateY(-5px);
      /* Lift on hover */
      box-shadow: 0 12px 35px rgba(0, 204, 255, 0.3);
      /* Enhance shadow on hover */
    }

    section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h1,
    h2,
    h3 {
      color: var(--primary);
      margin-bottom: 1.2rem;
      text-shadow: 0 0 8px rgba(0, 204, 255, 0.4);
      font-weight: 700;
    }

    h1 {
      font-size: 2.8rem;
    }

    h2 {
      font-size: 2rem;
    }

    h3 {
      font-size: 1.6rem;
    }

    p {
      line-height: 1.8;
      margin-bottom: 1.2rem;
      color: var(--text);
    }

    /* --- Buttons --- */
    .button,
    button {
      background-color: var(--primary);
      color: var(--background);
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      /* More rounded */
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 6px 15px rgba(0, 204, 255, 0.4);
      /* Stronger shadow */
      text-decoration: none;
      display: inline-block;
      text-align: center;
      letter-spacing: 0.5px;
    }

    .button:hover,
    button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-3px);
      /* More lift */
      box-shadow: 0 10px 25px rgba(0, 204, 255, 0.6);
      /* Stronger hover shadow */
    }

    .button:active,
    button:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(0, 204, 255, 0.3);
    }

    .secondary-button {
      background-color: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
      box-shadow: none;
      /* Remove default shadow */
    }

    .secondary-button:hover {
      background-color: rgba(0, 204, 255, 0.1);
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.4);
      /* Add subtle glow on hover */
    }

    .danger-button {
      background-color: var(--decline-color);
      box-shadow: 0 6px 15px rgba(220, 53, 69, 0.4);
    }

    .danger-button:hover {
      background-color: #c82333;
      box-shadow: 0 10px 25px rgba(220, 53, 69, 0.6);
    }

    /* --- Forms & Inputs --- */
    form {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      /* More space between fields */
      margin-top: 1.8rem;
    }

    form label {
      font-weight: bold;
      color: var(--primary);
      font-size: 1.05rem;
    }

    form input[type="text"],
    form input[type="email"],
    form input[type="password"],
    form input[type="number"],
    form input[type="url"],
    form textarea,
    form select {
      background-color: rgba(26, 26, 26, 0.8);
      /* Slightly transparent card-bg */
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.9rem;
      color: var(--text);
      font-size: 1rem;
      width: 100%;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    form input[type="text"]:focus,
    form input[type="email"]:focus,
    form input[type="password"]:focus,
    form input[type="number"]:focus,
    form input[type="url"]:focus,
    form textarea:focus,
    form select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 12px rgba(0, 204, 255, 0.6);
    }

    #auth-section {
      text-align: center;
    }

    #auth-form {
      max-width: 450px;
      /* Slightly wider */
      margin: 0 auto;
      padding: 2.5rem;
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 204, 255, 0.2);
    }

    #login-form,
    #register-form {
      display: none;
    }

    #login-form.active,
    #register-form.active {
      display: flex;
    }

    #auth-mode-toggle {
      margin-top: 1.5rem;
      font-size: 1rem;
      color: var(--text-secondary);
      cursor: pointer;
      text-decoration: underline;
      transition: color 0.3s ease;
    }

    #auth-mode-toggle:hover {
      color: var(--primary);
    }

    #admin-panel {
      margin-top: 2.5rem;
      text-align: left;
    }

    /* --- Message Boxes --- */
    .message-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 550px;
      z-index: 9999; /* Ensures it overlays ALL other UI */
      display: flex;
      flex-direction: column;
      gap: 12px;
      /* More space between messages */
    }

    .message {
      padding: 1.2rem;
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: slideInFromTop 0.4s ease-out forwards;
    }

    @keyframes slideInFromTop {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.success {
      background-color: var(--success-msg-bg);
      border: 1px solid var(--claim-ready);
      color: var(--claim-ready);
    }

    .message.error {
      background-color: var(--error-msg-bg);
      border: 1px solid var(--error);
      color: var(--error);
    }

    .message.info {
      background-color: var(--info-msg-bg);
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .message.warning {
      background-color: rgba(255, 204, 0, 0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    .message-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      /* Larger close button */
      color: inherit;
      cursor: pointer;
      margin-left: 1.5rem;
      transition: transform 0.2s ease;
    }

    .message-close:hover {
      transform: scale(1.2);
    }

    /* --- Search Input Containers (New Styles) --- */
    .search-input-group {
      position: relative;
      width: 100%;
      max-width: 350px;
      /* Adjust as needed */
      margin-right: 1rem;
      /* Space from other header elements */
    }

    .search-input-group input {
      padding-left: 2.5rem;
      /* Space for icon */
      padding-right: 2.5rem;
      /* Space for clear button */
      border-radius: 20px;
      border: 1px solid var(--border);
      background-color: rgba(26, 26, 26, 0.7);
      color: var(--text);
      font-size: 0.95rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 204, 255, 0.1);
    }

    .search-input-group input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.5);
      transform: translateY(-2px);
    }

    .search-input-group input::placeholder {
      color: var(--text-secondary);
      opacity: 0.7;
    }

    .search-input-group .search-icon,
    .search-input-group .clear-search-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 1rem;
      pointer-events: none;
      /* Allow clicks to pass through to input */
      transition: color 0.3s ease;
    }

    .search-input-group .search-icon {
      left: 1rem;
    }

    .search-input-group .clear-search-button {
      right: 1rem;
      pointer-events: auto;
      /* Make button clickable */
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--error);
      display: none;
      /* Hidden by default */
      transition: transform 0.2s ease, color 0.3s ease;
      /* Added animation */
    }

    .search-input-group .clear-search-button:hover {
      color: var(--primary);
      transform: translateY(-50%) scale(1.1);
      /* Added animation */
    }

    /* Search results dropdown styling */
    .user-search-results {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      z-index: 20;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      /* Hidden by default */
    }

    .user-search-results.active {
      display: block;
    }

    .user-search-result-item {
      padding: 0.8rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      color: var(--text);
      cursor: pointer;
      transition: background-color 0.2s ease;
      border-bottom: 1px solid rgba(0, 204, 255, 0.1);
    }

    .user-search-result-item:last-child {
      border-bottom: none;
    }

    .user-search-result-item:hover {
      background-color: rgba(0, 204, 255, 0.08);
    }

    .user-search-result-item img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid var(--primary);
    }

    /* --- Trade Calculator Specific Styles --- */
    .fruit-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      /* Slightly larger cards */
      gap: 1.8rem;
      /* More space */
      margin-top: 2rem;
    }

    .fruit-card {
      background-color: var(--background);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.15);
    }

    .fruit-card:hover {
      transform: translateY(-8px);
      /* More lift */
      box-shadow: 0 0 25px rgba(0, 204, 255, 0.3);
      /* Stronger glow */
      background-color: rgba(26, 26, 26, 0.9);
      /* Darken slightly */
    }

    .fruit-card img {
      max-width: 110px;
      /* Slightly larger images */
      height: auto;
      margin-bottom: 1rem;
      border-radius: 8px;
      /* Rounded image corners */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .fruit-name {
      font-weight: bold;
      font-size: 1.25rem;
      /* Larger font */
      margin-bottom: 0.6rem;
      color: var(--primary);
    }

    .fruit-rarity {
      font-size: 0.95rem;
      margin-bottom: 0.8rem;
      padding: 0.3rem 0.8rem;
      border-radius: 5px;
      display: inline-block;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .rarity-common {
      background-color: rgba(224, 247, 255, 0.1);
      color: var(--common);
      border: 1px solid rgba(224, 247, 255, 0.3);
    }

    .rarity-uncommon {
      background-color: rgba(85, 255, 85, 0.1);
      color: var(--uncommon);
      border: 1px solid rgba(85, 255, 85, 0.3);
    }

    .rarity-rare {
      background-color: rgba(85, 85, 255, 0.1);
      color: var(--rare);
      border: 1px solid rgba(85, 85, 255, 0.3);
    }

    .rarity-legendary {
      background-color: rgba(255, 170, 0, 0.1);
      color: var(--legendary);
      border: 1px solid rgba(255, 170, 0, 0.3);
    }

    .rarity-mythical {
      background-color: rgba(255, 0, 255, 0.1);
      color: var(--mythical);
      border: 1px solid rgba(255, 0, 255, 0.3);
    }

    .fruit-values p {
      font-size: 1rem;
      margin-bottom: 0.3rem;
      color: var(--text-secondary);
    }

    .fruit-quantity-control {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 1rem;
    }

    .fruit-quantity-control button {
      background-color: var(--primary-dark);
      color: var(--text);
      border: none;
      padding: 0.4rem 0.9rem;
      border-radius: 50%;
      /* Circular buttons */
      cursor: pointer;
      font-size: 1.4rem;
      line-height: 1;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 204, 255, 0.3);
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }

    .fruit-quantity-control button:hover {
      background-color: var(--primary);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 204, 255, 0.5);
    }

    .fruit-quantity-control span {
      margin: 0 1rem;
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--primary);
      min-width: 30px;
      text-align: center;
    }

    /* Floating Total Display Styles - Bottom Bar, Centered Content */
    .total-display {
      background: rgba(10, 10, 10, 0.98);
      /* More opaque for a solid bar */
      padding: 1rem 2rem;
      /* Adjusted padding for bar height */
      border-top: 2px solid var(--primary);
      /* Top border for bar effect */
      border-radius: 0;
      /* Remove rounded corners for bar effect */
      box-shadow: 0 -5px 20px rgba(0, 204, 255, 0.6);
      /* Shadow pointing upwards */
      display: none;
      /* HIDDEN BY DEFAULT, SHOWN ONLY WHEN TRADE CALCULATOR IS ACTIVE */
      justify-content: center;
      /* Center content horizontally */
      align-items: center;
      /* Center content vertically */
      position: fixed;
      /* Make it float relative to the viewport */
      bottom: 0;
      /* Position at the very bottom */
      left: 0;
      /* Align to the left edge */
      width: 100%;
      /* Make it a full-width bar */
      z-index: 50;
      /* Ensure it's on top */
      flex-direction: row;
      /* Default to row for better bar layout */
      gap: 2rem;
      /* Space between the two total values */
      transition: opacity 0.3s ease-in-out;
      /* Smooth transitions */
    }

    .total-display p {
      font-size: 1.2rem;
      /* Slightly smaller for bar fit */
      margin-bottom: 0;
      color: var(--text);
      white-space: nowrap;
      /* Prevent text wrapping */
    }

    .total-display strong {
      font-size: 1.8rem;
      /* Adjusted for bar fit */
      color: var(--secondary);
      text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
    }

    /* Media query for smaller screens to stack content if needed */
    @media (max-width: 600px) {
      .total-display {
        flex-direction: column;
        /* Stack items vertically on smaller screens */
        gap: 0.5rem;
        /* Reduce gap when stacked */
        padding: 0.8rem 1rem;
        /* Adjust padding for smaller height */
      }

      .total-display p {
        font-size: 1rem;
      }

      .total-display strong {
        font-size: 1.5rem;
      }
    }


    /* --- Daily Claim & Leaderboard --- */
    #daily-claim-button {
      display: block;
      margin: 2.5rem auto 1.5rem;
      width: fit-content;
      font-size: 1.5rem;
      padding: 1.2rem 3rem;
      border-radius: 10px;
    }

    #daily-claim-status {
      text-align: center;
      font-size: 1.2rem;
      color: var(--text-secondary);
      margin-top: 1.2rem;
      font-weight: 500;
    }

    #daily-claim-status.claim-ready {
      color: var(--claim-ready);
      font-weight: bold;
      text-shadow: 0 0 10px var(--claim-ready-shadow);
      animation: pulse-green 1.8s infinite alternate;
    }

    @keyframes pulse-green {
      0% {
        transform: scale(1);
        box-shadow: 0 0 10px var(--claim-ready-shadow);
      }

      50% {
        transform: scale(1.03);
        box-shadow: 0 0 25px var(--claim-ready-shadow);
      }

      100% {
        transform: scale(1);
        box-shadow: 0 0 10px var(--claim-ready-shadow);
      }
    }

    #daily-claim-button.claimed {
      background-color: var(--primary-dark);
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
    }

    .countdown-display {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 1.3em;
      color: var(--primary);
      text-shadow: 0 0 5px var(--primary);
    }

    /* --- Post Items (Changelogs, Bulletins, Blogs) --- */
    .post-item {
      background-color: var(--background);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.1);
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .post-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 0 30px rgba(0, 204, 255, 0.2);
    }

    .post-item h3 {
      color: var(--primary);
      margin-bottom: 0.8rem;
      font-size: 1.8rem;
    }

    .post-item p {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
      word-wrap: break-word;
    }

    .blog-meta {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .blog-meta .pfp-small {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--secondary);
      cursor: pointer;
    }

    .blog-meta .author-name {
      font-weight: bold;
      color: var(--secondary);
      cursor: pointer;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .blog-meta .author-name:hover {
      color: var(--secondary-dark);
      text-decoration: underline;
    }

    .delete-button {
      background-color: var(--decline-color);
      color: white;
      border: none;
      padding: 0.7rem 1.4rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      position: absolute;
      bottom: 1.5rem;
      right: 1.5rem;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
    }

    .delete-button:hover {
      background-color: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(220, 53, 69, 0.5);
    }

    .add-form-container {
      margin-top: 2.5rem;
      padding: 2rem;
      background-color: var(--background);
      border: 1px solid var(--primary);
      border-radius: 12px;
      box-shadow: 0 0 25px rgba(0, 204, 255, 0.4);
    }

    /* Blog Pagination Controls */
    .blog-pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(0, 204, 255, 0.1);
    }

    .blog-pagination button {
      background-color: var(--primary-dark);
      color: var(--text);
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 204, 255, 0.3);
    }

    .blog-pagination button:hover:not(:disabled) {
      background-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 204, 255, 0.5);
    }

    .blog-pagination button:disabled {
      background-color: #333;
      color: #777;
      cursor: not-allowed;
      box-shadow: none;
    }

    .blog-pagination span {
      font-size: 1.1rem;
      color: var(--text-secondary);
    }

    /* --- Footer --- */
    footer {
      background: linear-gradient(to right, var(--card-bg), rgba(26, 26, 26, 0.9), var(--card-bg));
      color: var(--text-secondary);
      text-align: center;
      padding: 2.5rem;
      /* Increased padding */
      border-top: 2px solid var(--primary);
      /* Glowing border */
      box-shadow: 0 -8px 25px rgba(0, 204, 255, 0.5);
      /* Stronger shadow */
      margin-top: 3rem;
      /* More space from content */
      position: relative;
      z-index: 10;
      font-size: 1.1rem;
      /* Slightly larger font */
      font-weight: 500;
      letter-spacing: 0.5px;
      text-shadow: 0 0 5px rgba(0, 204, 255, 0.2);
      /* Subtle text glow */
      transition: all 0.3s ease;
    }

    footer:hover {
      box-shadow: 0 -12px 35px rgba(0, 204, 255, 0.7);
      /* Enhanced glow on hover */
    }

    .email-verify-banner {
      background-color: var(--warning);
      color: var(--background);
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 2rem;
      border-radius: 10px;
      display: none;
      font-size: 1.1rem;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
    }

    .email-verify-banner.active {
      display: block;
    }

    .email-verify-banner button {
      background-color: var(--background);
      color: var(--warning);
      border: 1px solid var(--background);
      margin-left: 1.5rem;
      padding: 0.7rem 1.4rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s, color 0.3s, transform 0.2s;
      box-shadow: none;
    }

    .email-verify-banner button:hover {
      background-color: var(--warning);
      color: var(--background);
      transform: translateY(-2px);
    }

    /* --- Home Section Specifics (New Channels Grid) --- */
    #home-section .main-title {
      font-size: 3.5rem;
      font-weight: 700;
      color: var(--primary);
      text-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
      margin-bottom: 2rem;
      animation: glow 2s infinite alternate;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary);
      }

      to {
        text-shadow: 0 0 20px var(--primary), 0 0 30px var(--primary-dark);
      }
    }

    #home-section .clan-description {
      background-color: var(--background);
      padding: 1.8rem 2.5rem;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 204, 255, 0.1);
      line-height: 1.6;
      font-size: 1.2rem;
      max-width: 900px;
      margin: 2.5rem auto;
      text-align: center;
      border: 1px solid rgba(0, 204, 255, 0.2);
    }

    .home-channels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      margin-top: 3rem;
    }

    .channel-card {
      background-color: var(--card-bg);
      padding: 2rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 6px 20px rgba(0, 204, 255, 0.15);
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
      text-align: left;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .channel-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 40px rgba(0, 204, 255, 0.4);
      background-color: #2a2a2a;
    }

    .channel-card h3 {
      color: var(--secondary);
      font-size: 1.6rem;
      margin-bottom: 0.8rem;
      border-bottom: 2px solid rgba(0, 255, 136, 0.4);
      padding-bottom: 0.8rem;
      text-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
    }

    .channel-card p {
      color: var(--text-secondary);
      font-size: 1rem;
      flex-grow: 1;
      margin-bottom: 0;
    }

    .coming-soon {
      color: var(--primary);
      font-style: italic;
      font-weight: 600;
      font-size: 1.3rem;
      text-align: center;
      margin-top: 1rem;
    }

    /* --- Trade Section Specific Styles --- */
    #trade-section .trade-forms-container {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      margin-bottom: 3rem;
    }

    #trade-section .trade-form-group {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1.5rem;
      border: 1px solid rgba(0, 255, 136, 0.3);
      border-radius: 10px;
      background-color: rgba(0, 255, 136, 0.05);
      box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
    }

    #trade-section .trade-form-group h3 {
      color: var(--secondary);
      margin-bottom: 0.5rem;
    }

    #trade-section .fruit-selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }

    #trade-section .fruit-select-card {
      background-color: var(--background);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.8rem;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    #trade-section .fruit-select-card img {
      width: 60px;
      height: 60px;
      border-radius: 4px;
    }

    #trade-section .fruit-select-card .fruit-name {
      font-size: 0.9rem;
      font-weight: bold;
      color: var(--text);
    }

    #trade-section .fruit-select-card .fruit-quantity-control {
      margin-top: 0.5rem;
    }

    #trade-section #post-trade-button {
      margin-top: 2rem;
      width: fit-content;
      align-self: center;
    }

    /* Trade Listings */
    .trade-listing-card {
      background-color: var(--background);
      border: 1px solid var(--primary);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.2);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      /* Enhanced transition */
    }

    .trade-listing-card:hover {
      transform: translateY(-8px);
      /* More pronounced lift */
      box-shadow: 0 0 40px rgba(0, 204, 255, 0.4);
      /* Stronger glow */
    }

    .trade-listing-card .trade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(0, 204, 255, 0.2);
      padding-bottom: 1rem;
      margin-bottom: 1rem;
    }

    .trade-listing-card .trade-header .poster-info {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .trade-listing-card .trade-header .poster-info .pfp-small {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary);
    }

    .trade-listing-card .trade-header .poster-info .poster-name {
      font-weight: bold;
      color: var(--primary);
      font-size: 1.1rem;
    }

    .trade-listing-card .trade-fruits {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .trade-listing-card .trade-fruits .fruit-item {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.6rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      color: var(--text);
    }

    .trade-listing-card .trade-fruits .fruit-item img {
      width: 30px;
      height: 30px;
      border-radius: 4px;
    }

    .trade-listing-card .trade-fruits .fruit-item .quantity {
      font-weight: bold;
      color: var(--secondary);
    }

    .trade-listing-card .trade-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1rem;
      align-items: center;
      /* Align buttons and W/L counts */
    }

    .trade-listing-card .trade-actions button {
      padding: 0.8rem 1.5rem;
      font-size: 0.95rem;
      border-radius: 6px;
    }

    .trade-rating-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-right: 1rem;
      /* Space between chat button and W/L */
    }

    .trade-rating-buttons button {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      font-weight: bold;
      border-radius: 5px;
      transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
      /* Added animation */
    }

    .trade-rating-buttons .w-button {
      background-color: var(--accept-color);
      color: white;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .trade-rating-buttons .w-button:hover:not(:disabled) {
      background-color: #218838;
      transform: translateY(-1px) scale(1.05);
      /* Added animation */
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.5);
    }

    .trade-rating-buttons .w-button.active-vote {
      border: 2px solid var(--secondary);
      background-color: var(--secondary-dark);
    }

    .trade-rating-buttons .l-button {
      background-color: var(--decline-color);
      color: white;
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    }

    .trade-rating-buttons .l-button:hover:not(:disabled) {
      background-color: #c82333;
      transform: translateY(-1px) scale(1.05);
      /* Added animation */
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.5);
    }

    .trade-rating-buttons .l-button.active-vote {
      border: 2px solid var(--error);
      background-color: var(--error);
    }

    .trade-rating-buttons span {
      font-weight: bold;
      font-size: 1.1rem;
      margin: 0 0.2rem;
    }

    /* Private Chat Section */
    #private-chat-section {
      margin-top: 3rem;
      padding: 2.5rem;
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 204, 255, 0.2);
    }

    #private-chat-section h2 {
      margin-bottom: 1.5rem;
    }

    /* Main chat search input group */
    #private-chat-section .search-input-group {
      margin-bottom: 1.5rem;
      max-width: none;
      /* Allow full width in this section */
      margin-right: 0;
    }

    #user-search-results-main {
      /* Renamed to avoid conflict with header search */
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .user-search-item {
      padding: 0.8rem 1.2rem;
      border-bottom: 1px solid rgba(0, 204, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text);
    }

    .user-search-item:last-child {
      border-bottom: none;
    }

    .user-search-item:hover {
      background-color: rgba(0, 204, 255, 0.05);
    }

    .user-search-item button {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    #current-chats-list {
      list-style: none;
      padding: 0;
    }

    .chat-list-item {
      background-color: var(--background);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin-bottom: 0.8rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease;
      /* Added animation */
      position: relative;
      /* For notification dot */
    }

    .chat-list-item:hover {
      background-color: rgba(26, 26, 26, 0.9);
      transform: translateX(5px);
      /* Added animation */
    }

    .chat-list-item .chat-partner-name {
      font-weight: bold;
      color: var(--primary);
    }

    .chat-list-item .last-message {
      font-size: 0.9rem;
      color: var(--text-secondary);
      flex-grow: 1;
      margin-left: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-list-item .chat-timestamp {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .chat-list-item .unread-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 10px;
      height: 10px;
      background-color: var(--error);
      border-radius: 50%;
      box-shadow: 0 0 5px var(--error);
      animation: pulse-red 1.5s infinite alternate;
    }


    /* Chat Window Modal */
    .chat-window-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease-out;
    }

    .chat-window-modal.active {
      display: flex;
    }

    .chat-content {
      background-color: var(--card-bg);
      padding: 2rem;
      border-radius: 12px;
      border: 1px solid var(--primary);
      box-shadow: 0 0 30px rgba(0, 204, 255, 0.6);
      width: 90%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .chat-header h3 {
      margin: 0;
      color: var(--secondary);
    }

    .chat-close-button {
      background: none;
      border: none;
      color: var(--text);
      font-size: 2rem;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .chat-close-button:hover {
      color: var(--error);
    }

    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding-right: 10px;
      margin-bottom: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    /* Custom Scrollbar for chat messages */
    .chat-messages::-webkit-scrollbar {
      width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: var(--background);
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--primary-dark);
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    .chat-message {
      padding: 0.8rem 1.2rem;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
    }

    .chat-message.sent {
      background-color: rgba(0, 204, 255, 0.2);
      align-self: flex-end;
      color: var(--text);
      border-bottom-right-radius: 2px;
    }

    .chat-message.received {
      background-color: rgba(0, 255, 136, 0.2);
      align-self: flex-start;
      color: var(--text);
      border-bottom-left-radius: 2px;
    }

    .chat-message .message-meta {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.3rem;
      text-align: right;
    }

    .chat-input-area {
      display: flex;
      gap: 1rem;
      margin-top: auto;
    }

    .chat-input-area input {
      flex-grow: 1;
      border-radius: 8px;
      padding: 0.8rem;
    }

    .chat-input-area button {
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
    }

    /* --- My Profile Section Styles --- */
    #my-profile-section .profile-details {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      margin-bottom: 2.5rem;
      padding: 2rem;
      background-color: var(--background);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 204, 255, 0.1);
    }

    #my-profile-section .pfp-large {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--primary);
      margin-bottom: 1.5rem;
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.6);
    }

    #my-profile-section h2 {
      font-size: 2.2rem;
      margin-bottom: 0.8rem;
      color: var(--primary);
    }

    #my-profile-section p {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    #my-profile-section strong {
      color: var(--text);
    }

    /* --- Shop Section Styles --- */
    #shop-section .shop-items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 2rem;
      margin-top: 2rem;
    }

    .shop-item-card {
      background-color: var(--background);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
      /* Enhanced transition */
      box-shadow: 0 0 15px rgba(0, 255, 136, 0.15);
      /* Greenish glow for shop items */
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .shop-item-card:hover {
      transform: translateY(-8px);
      /* More lift */
      box-shadow: 0 0 30px rgba(0, 255, 136, 0.4);
      /* Stronger glow */
      background-color: rgba(26, 26, 26, 0.9);
    }

    .shop-item-card img {
      max-width: 100px;
      height: auto;
      margin: 0 auto 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .shop-item-card h3 {
      color: var(--secondary);
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }

    .shop-item-card p {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      flex-grow: 1;
      /* Allow description to take space */
    }

    .shop-item-card .price-stock {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      margin-bottom: 1.5rem;
      border-top: 1px solid rgba(0, 255, 136, 0.2);
      padding-top: 1rem;
    }

    .shop-item-card .price {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary);
    }

    .shop-item-card .stock {
      font-size: 1rem;
      color: var(--text);
    }

    .shop-item-card button {
      width: 100%;
      padding: 0.8rem;
      font-size: 1rem;
      border-radius: 6px;
      background-color: var(--secondary);
      /* Green buy button */
      color: var(--background);
      box-shadow: 0 4px 10px rgba(0, 255, 136, 0.4);
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      /* Added animation */
    }

    .shop-item-card button:hover:not(:disabled) {
      background-color: var(--secondary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 255, 136, 0.6);
    }

    .shop-item-card button:disabled {
      background-color: #333;
      color: #777;
      cursor: not-allowed;
      box-shadow: none;
    }


    /* --- Responsive Adjustments --- */
    @media (max-width: 768px) {
      header {
        padding: 1rem 1.5rem;
        flex-direction: row;
        /* Keep row for main elements */
        flex-wrap: wrap;
        /* Allow wrapping */
        justify-content: space-between;
        /* Distribute items */
      }

      .logo {
        font-size: 1.6rem;
        flex-shrink: 0;
      }

      .realm-coin-display {
        margin-left: 0.5rem;
        padding: 0.3rem 0.8rem;
        flex-shrink: 0;
      }

      .realm-coin-amount {
        font-size: 0.9rem;
      }

      /* User search in header on small screens */
      .search-input-group {
        width: 100%;
        /* Full width */
        order: 3;
        /* Push to new row below logo/coins */
        margin-top: 1rem;
        margin-right: 0;
      }

      .nav-toggle {
        margin-left: auto;
        /* Push to right */
        order: 2;
        /* Keep it right */
      }

      nav {
        width: 100%;
        left: 0;
        right: auto;
        /* Reset right alignment */
      }

      nav ul {
        align-items: flex-start;
        gap: 0.8rem;
      }

      .nav-utility-items {
        align-items: flex-start;
      }

      main {
        padding: 1rem;
      }

      section {
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      h1 {
        font-size: 2.2rem;
      }

      h2 {
        font-size: 1.6rem;
      }

      h3 {
        font-size: 1.3rem;
      }

      .fruit-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1rem;
      }

      .fruit-card img {
        max-width: 90px;
      }

      .fruit-name {
        font-size: 1.1rem;
      }

      .fruit-quantity-control button {
        width: 30px;
        height: 30px;
        font-size: 1.2rem;
      }

      .fruit-quantity-control span {
        font-size: 1.1rem;
        margin: 0 0.6rem;
      }

      /* Total display on small screens: remains fixed and centered */
      .total-display {
        padding: 0.8rem 1rem;
      }

      .total-display p {
        font-size: 1rem;
      }

      .total-display strong {
        font-size: 1.5rem;
      }

      #daily-claim-button {
        font-size: 1.2rem;
        padding: 1rem 2rem;
      }

      #daily-claim-status {
        font-size: 1rem;
      }

      .trade-listing-card {
        padding: 1.5rem;
      }

      .trade-listing-card .trade-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .trade-listing-card .trade-actions {
        flex-direction: column;
        align-items: flex-start;
      }

      .trade-rating-buttons {
        margin-right: 0;
        margin-bottom: 1rem;
        /* Space when stacked */
      }

      .chat-content {
        padding: 1rem;
      }

      .chat-header h3 {
        font-size: 1.5rem;
      }

      .chat-close-button {
        font-size: 1.5rem;
      }

      #my-profile-section .pfp-large {
        width: 90px;
        height: 90px;
      }

      #my-profile-section h2 {
        font-size: 1.8rem;
      }

      #my-profile-section p {
        font-size: 1rem;
      }

      .shop-items-grid {
        grid-template-columns: 1fr;
      }

      .shop-item-card {
        padding: 1rem;
      }

      .shop-item-card h3 {
        font-size: 1.2rem;
      }

      .shop-item-card p {
        font-size: 0.85rem;
      }

      .shop-item-card .price-stock {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .shop-item-card button {
        font-size: 0.9rem;
        padding: 0.7rem;
      }
    }
  </style>
</head>

<body>
  <canvas id="backgroundCanvas"></canvas>

  <header>
    <a href="#" class="logo" id="shinigami-realm-logo">Shinigami Realm</a>
    <div class="realm-coin-display" onclick="displaySection('daily-realm-coin-section')">
      <i class="fas fa-diamond realm-coin-icon"></i>
      <span class="realm-coin-amount" id="current-realm-coin">0</span>
    </div>
    <div class="search-input-group">
      <i class="fas fa-search search-icon"></i>
      <input type="text" id="header-user-search-input" class="search-input" placeholder="Search user for chat..." />
      <button class="clear-search-button" data-target-input="header-user-search-input">&times;</button>
      <div id="header-user-search-results" class="user-search-results">
      </div>
    </div>
    <div class="header-spacer"></div> <button class="nav-toggle" id="nav-toggle">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <nav id="nav-menu">
      <ul>
        <li><a href="#home-section" class="nav-link active">Home</a></li>
        <li><a href="#about-section" class="nav-link">About Us</a></li>
        <li><a href="#changelogs-section" class="nav-link">Changelogs</a></li>
        <li><a href="#bulletins-section" class="nav-link">Bulletins</a></li>
        <li><a href="#trade-calculator-section" class="nav-link">Trade Calculator</a></li>
        <li><a href="#trade-section" class="nav-link">Trade</a></li>
        <li><a href="#daily-realm-coin-section" class="nav-link">Daily Realm Coin</a></li>
        <li><a href="#shop-section" class="nav-link">Shop</a></li>
        <li><a href="#blogs-section" class="nav-link">Blogs</a></li>
        <li><a href="#giveaways-section" class="nav-link">Giveaways</a></li>
        <li id="my-profile-nav-item" style="display: none;"><a href="#my-profile-section" class="nav-link">My Profile</a></li>
        <li id="admin-nav-item" style="display: none;"><a href="#admin-section" class="nav-link">Admin</a></li>
      </ul>
      <div class="nav-utility-items">
        <li id="auth-status-nav-item" style="display: none;">
          <p class="auth-status" id="auth-status-text"></p>
        </li>
        <li id="login-nav-item"><button id="login-nav-button">Login / Register</button></li>
        <li id="logout-nav-item" style="display: none;"><button id="logout-button">Logout</button></li>
      </div>
    </nav>
  </header>

  <main>
    <div id="message-container" class="message-container"></div>
    <div id="email-verify-banner" class="email-verify-banner">
      Please verify your email to access all features.
      <button id="send-verify-email-button">Resend Verification Email</button>
    </div>

    <section id="home-section" class="active">
      <h1 class="main-title">Welcome to Shinigami Realm</h1>
      <div class="clan-description">
        <p>Your ultimate community hub for Blox Fruits! Join us to trade, share news, track values, and connect with
          other players in the vast and exciting world of Blox Fruits. Our realm is built for transparency, fairness,
          and fun.</p>
      </div>

      <h2>Explore Our Channels</h2>
      <div class="home-channels-grid">
        <div class="channel-card" onclick="displaySection('trade-calculator-section')">
          <h3>Trade Calculator</h3>
          <p>Instantly calculate fruit values and ensure fair trades. No more guesswork!</p>
        </div>
        <div class="channel-card" onclick="displaySection('trade-section')">
          <h3>Trade Center</h3>
          <p>Post your trade offers and find other players to trade with!</p>
        </div>
        <div class="channel-card" onclick="displaySection('changelogs-section')">
          <h3>Changelogs</h3>
          <p>Stay updated with all the new features, bug fixes, and improvements in Shinigami Realm.</p>
        </div>
        <div class="channel-card" onclick="displaySection('bulletins-section')">
          <h3>Bulletins</h3>
          <p>Important announcements and news from the Shinigami Realm administration.</p>
        </div>
        <div class="channel-card" onclick="displaySection('daily-realm-coin-section')">
          <h3>Daily Realm Coin</h3>
          <p>Claim your daily bonus coins and boost your in-game economy. Consistency is key!</p>
          </p>
        </div>
        <div class="channel-card" onclick="displaySection('blogs-section')">
          <h3>Community Blogs</h3>
          <p>Read and share amazing content from our community members. Your stories, guides, and insights matter!</p>
        </div>
        <div class="channel-card" onclick="displaySection('shop-section')">
          <h3>Shop</h3>
          <p>Discover items and upgrades for your journey. Purchase with your Realm Coins!</p>
        </div>
        <div class="channel-card" onclick="displaySection('about-section')">
          <h3>About Us</h3>
          <p>Learn more about Shinigami Realm, our mission, and meet the dedicated staff behind the community.</p>
        </div>
        <div class="channel-card" onclick="displaySection('giveaways-section')">
          <h3>Giveaways</h3>
          <p>Participate in exciting giveaways for a chance to win amazing prizes!</p>
        </div>
        <div class="channel-card" onclick="displaySection('my-profile-section')" id="my-profile-home-card" style="display: none;">
          <h3>My Profile</h3>
          <p>View and edit your personal details, profile picture, and display name.</p>
        </div>
        <div class="channel-card" onclick="displaySection('admin-section')" id="admin-home-card" style="display: none;">
          <h3>Admin Panel</h3>
          <p>Access administrative tools to manage content and users (Admin access only).</p>
        </div>
      </div>
    </section>

    <section id="about-section">
      <h1>About Us</h1>
      <p>Shinigami Realm is a dedicated Blox Fruits community, striving to provide valuable resources and a fun
        environment for all players.</p>
      <p>Our goal is to help you maximize your Blox Fruits experience with accurate trade values, timely updates, and
        engaging content.</p>
      <div class="staff-section">
        <h2>Our Dedicated Staff</h2>
        <div class="staff-list">
          <p><strong>Owner:</strong> mud</p>
          <p><strong>Co-Owner:</strong> aq.17d , Batman</p>
          <p><strong>Moderator:</strong> rip_gojo</p>
          <p><strong>Community Manager:</strong> GREED , chicken</p>
        </div>
      </div>
      <p style="margin-top: 1.5rem;">For support, suggestions, or to report issues, please join our Discord server:</p>
      <a href="https://discord.gg/NgbcrWSVm5" target="_blank" class="button secondary-button">Join Our Discord!</a>
    </section>

    <section id="changelogs-section">
      <h1>Changelogs</h1>
      <div id="changelogs-container">
      </div>
    </section>

    <section id="bulletins-section">
      <h1>Bulletins</h1>
      <div id="bulletins-container">
      </div>
    </section>

    <section id="trade-calculator-section">
      <h1>Blox Fruits Trade Calculator</h1>
      <p>Easily calculate the Beli and trade values of your fruits.</p>
      <div class="search-input-group" style="max-width: 400px; margin: 20px auto;">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="fruit-search" class="search-input" placeholder="Search for a fruit..." />
        <button class="clear-search-button" data-target-input="fruit-search">&times;</button>
      </div>
      <div id="fruit-list" class="fruit-grid">
      </div>
    </section>
    <div class="total-display">
      <p>Total Beli Value: <strong id="total-beli">0</strong></p>
      <p>Total Trade Value: <strong id="total-trade-value">0</strong></p>
    </div>

    <section id="trade-section">
      <h1>Trade Center</h1>
      <p>Post your trade offers or browse existing ones. Connect with other players to make fair trades!</p>

      <div class="add-form-container" id="post-trade-container">
        <h2>Post a New Trade</h2>
        <form id="post-trade-form">
          <div class="trade-form-group">
            <h3>Fruits I Offer</h3>
            <div id="offer-fruits-selection" class="fruit-selection-grid">
            </div>
          </div>

          <div class="trade-form-group">
            <h3>Fruits I Want</h3>
            <div id="want-fruits-selection" class="fruit-selection-grid">
            </div>
          </div>

          <button type="submit" id="post-trade-button" disabled>Post Trade</button>
        </form>
      </div>

      <h2 style="margin-top: 3rem;">Active Trade Listings</h2>
      <div id="trade-listings-container">
        <p>No active trades yet. Be the first to post one!</p>
      </div>

      <div id="private-chat-section">
        <h2>Private Chats</h2>
        <p>Search for users to start a private conversation or continue existing chats.</p>

        <div class="search-input-group">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="user-search-input-main" class="search-input" placeholder="Search users by name or email..." />
          <button class="clear-search-button" data-target-input="user-search-input-main">&times;</button>
        </div>
        <div id="user-search-results-main">
        </div>

        <h3 style="margin-top: 2rem;">Your Conversations</h3>
        <ul id="current-chats-list">
          <p>You have no active conversations.</p>
        </ul>
      </div>
    </section>

    <div id="chat-window-modal" class="chat-window-modal">
      <div class="chat-content">
        <div class="chat-header">
          <h3 id="chat-partner-name"></h3>
          <button id="chat-close-button" class="chat-close-button">&times;</button>
        </div>
        <div id="chat-messages" class="chat-messages">
        </div>
        <div class="chat-input-area">
          <input type="text" id="chat-message-input" placeholder="Type your message..." />
          <button id="send-chat-message-button">Send</button>
        </div>
      </div>
    </div>


    <section id="daily-realm-coin-section">
      <h1>Daily Realm Coin</h1>
      <p>Claim your daily Realm Coins to boost your balance!</p>
      <button id="daily-claim-button">Claim Daily Realm Coin</button>
      <p id="daily-claim-status"></p>
    </section>

    <section id="shop-section">
      <h1>Shinigami Realm Shop</h1>
      <p>Spend your hard-earned Realm Coins on exclusive items!</p>
      <div id="shop-items-container" class="shop-items-grid">
        <p>No items in the shop yet. Check back later!</p>
      </div>
    </section>

    <section id="blogs-section">
      <h1>Community Blogs</h1>
      <div id="add-blog-container" class="add-form-container">
        <h2>Add New Blog Post</h2>
        <form id="add-blog-form">
          <label for="blog-title">Title:</label>
          <input type="text" id="blog-title" maxlength="100" required />
          <label for="blog-content">Content:</label>
          <textarea id="blog-content" rows="10" maxlength="2000" required></textarea>
          <button type="submit">Publish Blog Post</button>
        </form>
      </div>
      <div id="blogs-container">
      </div>
      <div id="blog-pagination-controls" class="blog-pagination" style="display: none;">
        <button id="prev-blog-page">Previous</button>
        <span id="blog-page-info">Page 1 of 1</span>
        <button id="next-blog-page">Next</button>
      </div>
    </section>

    <section id="giveaways-section">
      <h1>Giveaways</h1>
      <p class="coming-soon">Waiting for sauce..</p>
    </section>

    <section id="admin-section">
      <h1>Admin Panel</h1>
      <div id="admin-panel">
        <h2>Add New Changelog</h2>
        <form id="add-changelog-form">
          <label for="changelog-title">Title:</label>
          <input type="text" id="changelog-title" maxlength="100" required />
          <label for="changelog-content">Content:</label>
          <textarea id="changelog-content" rows="5" maxlength="1000" required></textarea>
          <button type="submit">Add Changelog</button>
        </form>

        <h2>Add New Bulletin</h2>
        <form id="add-bulletin-form">
          <label for="bulletin-title">Title:</label>
          <input type="text" id="bulletin-title" maxlength="100" required />
          <label for="bulletin-content">Content:</label>
          <textarea id="bulletin-content" rows="5" maxlength="1000" required></textarea>
          <button type="submit">Add Bulletin</button>
        </form>

        <h2>Add/Update Shop Item</h2>
        <form id="add-shop-item-form">
          <label for="shop-item-name">Item Name:</label>
          <input type="text" id="shop-item-name" maxlength="50" required />
          <label for="shop-item-description">Description:</label>
          <textarea id="shop-item-description" rows="3" maxlength="200" required></textarea>
          <label for="shop-item-price">Price (Realm Coins):</label>
          <input type="number" id="shop-item-price" min="1" required />
          <label for="shop-item-stock">Initial Stock:</label>
          <input type="number" id="shop-item-stock" min="0" required />
          <button type="submit">Add/Update Item</button>
        </form>
      </div>
    </section>

    <section id="my-profile-section">
      <h1>My Profile</h1>
      <div class="profile-details">
        <img id="profile-avatar" src="https://placehold.co/120/00ccff/000000?text=PFP" alt="Profile Picture" class="pfp-large">
        <h2 id="profile-display-name">Loading...</h2>
        <p><strong>Email:</strong> <span id="profile-email">Loading...</span></p>
        <p><strong>Realm Coins:</strong> <span id="profile-coins">0</span></p>
      </div>

      <div class="add-form-container" style="margin-top: 2.5rem;">
        <h2>Edit Profile</h2>
        <form id="update-profile-form">
          <label for="update-display-name">Display Name:</label>
          <input type="text" id="update-display-name" maxlength="50" required />
          <label for="update-profile-pic">Profile Picture URL:</label>
          <input type="url" id="update-profile-pic" placeholder="e.g., https://example.com/your-image.jpg" />
          <button type="submit">Save Profile</button>
        </form>
      </div>
    </section>

    <section id="auth-section">
      <h1>Authentication</h1>
      <div id="auth-form">
        <form id="login-form" class="active">
          <h2>Login</h2>
          <label for="login-email">Email:</label>
          <input type="email" id="login-email" required />
          <label for="login-password">Password:</label>
          <input type="password" id="login-password" required />
          <button type="submit">Login</button>
        </form>

        <form id="register-form">
          <h2>Register</h2>
          <label for="register-display-name">Display Name:</label>
          <input type="text" id="register-display-name" maxlength="50" required />
          <label for="register-email">Email:</label>
          <input type="email" id="register-email" required />
          <label for="register-password">Password:</label>
          <input type="password" id="register-password" required />
          <button type="submit">Register</button>
        </form>
        <p id="auth-mode-toggle">Switch to <span id="toggle-text">Register</span></p>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Shinigami Realm. All rights reserved.</p>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase Configuration ---
    // IMPORTANT: These are your actual Firebase project settings.
    const firebaseConfig = {
      apiKey: "AIzaSyDa22uXbbmUb2CWU9AEbvqb90nsLZeul4M",
      authDomain: "shinigami-realm-c5b79.firebaseapp.com",
      projectId: "shinigami-realm-c5b79",
      storageBucket: "shinigami-realm-c5b79.firebasestorage.app",
      messagingSenderId: "540557371652",
      appId: "1:540557371652:web:67a3f100b1d4c2964b8851",
      measurementId: "G-G4YV145Q71"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Explicitly set appId for consistent data paths on GitHub Pages
    // This value MUST match the 'appId' in your firebaseConfig above AND the {appId} in your Firestore Security Rules.
    const appId = firebaseConfig.appId.split(':')[2]; // Extracts the web app ID part
    console.log('Using hardcoded appId for GitHub Pages:', appId);

    // REMINDER: This is your actual admin email!
    const ADMIN_EMAIL = "daiwikmjith90@gmail.com";
    let isAdmin = false;
    let currentUser = null;

    // REMINDER: Ensure this URL is stable or upload your own default PFP to Firebase Storage!
    const DEFAULT_PFP = "https://placehold.co/100/00ccff/000000?text=PFP";


    // --- UI Elements ---
    const navToggle = document.getElementById('nav-toggle');
    const navMenu = document.getElementById('nav-menu'); // This is now the vertical menu container
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('section');
    const messageContainer = document.getElementById('message-container');
    const emailVerifyBanner = document.getElementById('email-verify-banner');
    const sendVerifyEmailButton = document.getElementById('send-verify-email-button');

    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const authModeToggle = document.getElementById('auth-mode-toggle');
    const toggleText = document.getElementById('toggle-text');
    const logoutButton = document.getElementById('logout-button');
    const loginNavButton = document.getElementById('login-nav-button'); // New button for login/register in nav

    const adminNavItem = document.getElementById('admin-nav-item');
    const loginNavItem = document.getElementById('login-nav-item');
    const logoutNavItem = document.getElementById('logout-nav-item');
    const realmCoinDisplay = document.querySelector('.realm-coin-display'); // Moved to top level
    const authStatusNavItem = document.getElementById('auth-status-nav-item');
    const authStatusText = document.getElementById('auth-status-text');

    // Profile related DOM elements (restored)
    const myProfileNavItem = document.getElementById('my-profile-nav-item');
    const myProfileHomeCard = document.getElementById('my-profile-home-card');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileDisplayName = document.getElementById('profile-display-name');
    const profileEmail = document.getElementById('profile-email');
    const profileCoins = document.getElementById('profile-coins');
    const updateProfileForm = document.getElementById('update-profile-form');
    const updateDisplayNameInput = document.getElementById('update-display-name');
    const updateProfilePicInput = document.getElementById('update-profile-pic');


    const currentRealmCoin = document.getElementById('current-realm-coin'); // For nav bar display

    const addChangelogForm = document.getElementById('add-changelog-form');
    const changelogTitleInput = document.getElementById('changelog-title'); // Corrected typo
    const changelogContentInput = document.getElementById('changelog-content');
    const changelogsContainer = document.getElementById('changelogs-container');

    const addBulletinForm = document.getElementById('add-bulletin-form');
    const bulletinTitleInput = document.getElementById('bulletin-title');
    const bulletinContentInput = document = document.getElementById('bulletin-content');
    const bulletinsContainer = document.getElementById('bulletins-container');

    const addBlogForm = document.getElementById('add-blog-form');
    const blogTitleInput = document.getElementById('blog-title');
    const blogContentInput = document.getElementById('blog-content');
    const blogsContainer = document.getElementById('blogs-container');
    const addBlogContainer = document.getElementById('add-blog-container');
    const blogPaginationControls = document.getElementById('blog-pagination-controls');
    const prevBlogPageButton = document.getElementById('prev-blog-page');
    const nextBlogPageButton = document.getElementById('next-blog-page');
    const blogPageInfoSpan = document.getElementById('blog-page-info');

    const dailyClaimButton = document.getElementById('daily-claim-button');
    const dailyClaimStatus = document.getElementById('daily-claim-status');
    // Removed leaderboardList as the leaderboard section is removed

    const fruitSearchInput = document.getElementById('fruit-search');
    const fruitListContainer = document.getElementById('fruit-list');
    const totalBeliSpan = document.getElementById('total-beli');
    const totalTradeValueSpan = document.getElementById('total-trade-value');
    const totalDisplay = document.querySelector('.total-display'); // Get the total display element

    const adminHomeCard = document.getElementById('admin-home-card');
    const shinigamiRealmLogo = document.getElementById('shinigami-realm-logo'); // Added for title click

    // --- New Trade Section UI Elements ---
    const postTradeContainer = document.getElementById('post-trade-container');
    const postTradeForm = document.getElementById('post-trade-form');
    const offerFruitsSelection = document.getElementById('offer-fruits-selection');
    const wantFruitsSelection = document.getElementById('want-fruits-selection');
    const postTradeButton = document.getElementById('post-trade-button');
    const tradeListingsContainer = document.getElementById('trade-listings-container');

    // --- New Private Chat UI Elements ---
    const privateChatSection = document.getElementById('private-chat-section');
    const userSearchInputMain = document.getElementById('user-search-input-main'); // Renamed for main chat search
    const userSearchResultsMain = document.getElementById('user-search-results-main'); // Renamed for main chat search
    const currentChatsList = document.getElementById('current-chats-list');
    const chatWindowModal = document.getElementById('chat-window-modal');
    const chatCloseButton = document.getElementById('chat-close-button');
    const chatPartnerName = document.getElementById('chat-partner-name');
    const chatMessagesContainer = document.getElementById('chat-messages');
    const chatMessageInput = document.getElementById('chat-message-input');
    const sendChatMessageButton = document.getElementById('send-chat-message-button');

    // Header Search Elements (restored and renamed for clarity)
    const headerUserSearchInput = document.getElementById('header-user-search-input');
    const headerUserSearchResults = document.getElementById('header-user-search-results');

    // Shop Section UI Elements (New)
    const shopItemsContainer = document.getElementById('shop-items-container');
    const addShopItemForm = document.getElementById('add-shop-item-form');
    const shopItemNameInput = document.getElementById('shop-item-name');
    const shopItemDescriptionInput = document.getElementById('shop-item-description');
    const shopItemPriceInput = document.getElementById('shop-item-price');
    const shopItemStockInput = document.getElementById('shop-item-stock');


    // --- Utility Functions ---

    /**
     * Displays a temporary message to the user.
     * @param {string} msg - The message to display.
     * @param {'success'|'error'|'info'|'warning'} type - The type of message.
     */
    function showMessage(msg, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.innerHTML = `
        <span>${msg}</span>
        <button class="message-close">&times;</button>
      `;
      messageContainer.prepend(messageDiv);

      messageDiv.querySelector('.message-close').addEventListener('click', () => {
        messageDiv.remove();
      });

      setTimeout(() => {
        messageDiv.remove();
      }, 5000); // Message disappears after 5 seconds
    }

    /**
     * Displays the selected section and hides others.
     * Fetches content relevant to the section.
     * @param {string} sectionId - The ID of the section to display (e.g., 'home-section').
     */
    function displaySection(sectionId) {
      sections.forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(sectionId).classList.add('active');

      // Update active nav link
      navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === `#${sectionId}`) {
          link.classList.add('active');
        }
      });

      // Close mobile nav if open
      if (navMenu.classList.contains('active')) {
        navMenu.classList.remove('active');
        navToggle.classList.remove('active'); // Reset hamburger icon
      }

      // Hide header search results when navigating away
      headerUserSearchResults.classList.remove('active');
      headerUserSearchInput.value = ''; // Clear search input
      document.querySelector(`[data-target-input="header-user-search-input"]`).style.display = 'none'; // Hide clear button

      // --- Control visibility of total-display ---
      if (sectionId === 'trade-calculator-section') {
        totalDisplay.style.display = 'flex'; // Show it when trade calculator is active
      } else {
        totalDisplay.style.display = 'none'; // Hide it for all other sections
      }
      // --- End control visibility ---

      // Load content based on section
      switch (sectionId) {
        case 'changelogs-section':
          fetchChangelogs();
          break;
        case 'bulletins-section':
          fetchBulletins();
          break;
        case 'trade-calculator-section':
          renderFruits(); // Re-render fruits on section display
          calculateTotals();
          break;
        case 'trade-section':
          setupTradeForm();
          fetchTrades();
          fetchPublicUserProfiles(); // Fetch users for chat search
          fetchCurrentChats(); // Fetch user's current chats
          break;
        case 'daily-realm-coin-section':
          // Removed fetchLeaderboard() call
          updateDailyClaimUI();
          break;
        case 'blogs-section':
          currentBlogPage = 1; // Reset to first page when navigating to blogs
          fetchBlogs();
          break;
        case 'shop-section':
          fetchShopItems(); // Fetch shop items when shop section is displayed
          break;
        case 'my-profile-section': // Restored
          fetchUserProfile(currentUser ? currentUser.uid : null);
          break;
        case 'admin-section':
          if (!isAdmin) {
            // No showMessage here, as it's a passive navigation
            displaySection('home-section'); // Redirect if not admin
          }
          break;
        case 'giveaways-section':
          // No specific data fetch for giveaways, just display the content
          break;
      }
    }


    // --- Authentication ---

    // Handles user login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = loginForm['login-email'].value;
      const password = loginForm['login-password'].value;

      try {
        await auth.signInWithEmailAndPassword(email, password);
        showMessage('Logged in successfully!', 'success');
        loginForm.reset();
        // displaySection('home-section'); // Handled by onAuthStateChanged
      } catch (error) {
        console.error("Login Error:", error.message);
        showMessage(`Login failed: ${error.message}`, 'error');
      }
    });

    // Handles user registration
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const displayName = registerForm['register-display-name'].value;
      const email = registerForm['register-email'].value;
      const password = registerForm['register-password'].value;

      // Basic input validation
      if (displayName.trim() === '' || displayName.length > 50) {
        showMessage('Display Name is required and must be 50 characters or less.', 'error');
        return;
      }
      if (password.length < 6) { // Firebase Auth requires at least 6 characters
        showMessage('Password must be at least 6 characters long.', 'error');
        return;
      }

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // Send email verification
        await user.sendEmailVerification();
        showMessage('Registration successful! Please verify your email!', 'success');

        // Set display name in Auth
        await user.updateProfile({
          displayName: displayName
        });

        // Create initial profile data in Firestore (restored)
        await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('profile').doc('data').set({
          displayName: displayName,
          profilePictureUrl: DEFAULT_PFP,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastPublicChatVisitTimestamp: firebase.firestore.Timestamp.fromDate(new Date(0)) // Initialize chat visit time
        });

        // Create initial currency data in Firestore
        await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('currency').doc('data').set({
          realmCoins: 0,
          lastClaimTime: null,
        });

        // Create public user profile for chat search
        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('userPublicProfiles').doc(user.uid).set({
          displayName: displayName,
          uid: user.uid,
          email: user.email, // Store full email for search
          emailPrefix: user.email.substring(0, 5) // Store prefix for easy display
        });


        registerForm.reset();
        // displaySection('home-section'); // Handled by onAuthStateChanged
      } catch (error) {
        console.error("Registration Error:", error.message);
        showMessage(`Registration failed: ${error.message}`, 'error');
      }
    });

    // Toggles between login and registration forms
    authModeToggle.addEventListener('click', () => {
      if (loginForm.classList.contains('active')) {
        loginForm.classList.remove('active');
        registerForm.classList.add('active');
        toggleText.textContent = 'Login';
      } else {
        loginForm.classList.add('active');
        registerForm.classList.remove('active');
        toggleText.textContent = 'Register';
      }
    });

    // Handle Login/Register button in nav
    loginNavButton.addEventListener('click', () => {
      displaySection('auth-section');
    });

    // Send email verification
    sendVerifyEmailButton.addEventListener('click', async () => {
      if (currentUser && !currentUser.emailVerified) {
        try {
          await currentUser.sendEmailVerification();
          showMessage('Verification email sent! Please check your inbox!', 'info');
        } catch (error) {
          console.error("Email Verification Error:", error.message);
          showMessage(`Failed to send verification email: ${error.message}`, 'error');
        }
      }
    });

    // Auth state change listener
    auth.onAuthStateChanged(async user => {
      currentUser = user;
      if (user) {
        // User is signed in.
        loginNavItem.style.display = 'none';
        logoutNavItem.style.display = 'list-item';
        authStatusNavItem.style.display = 'list-item';
        myProfileNavItem.style.display = 'list-item'; // Show My Profile nav item (restored)
        myProfileHomeCard.style.display = 'flex'; // Show My Profile card on home (restored)

        // Fetch user profile and currency data (restored)
        await fetchUserProfile(user.uid);

        // Check for admin status
        isAdmin = (user.email === ADMIN_EMAIL);
        adminNavItem.style.display = isAdmin ? 'list-item' : 'none';
        adminHomeCard.style.display = isAdmin ? 'flex' : 'none'; // Show admin card on home

        // Check email verification status
        if (!user.emailVerified) {
          emailVerifyBanner.classList.add('active');
          // If email not verified, force to auth section and prevent access to other sections
          displaySection('auth-section');
        } else {
          emailVerifyBanner.classList.remove('active');
          // If email verified, load user data and navigate to home
          updateDailyClaimUI(); // Update daily claim status
          // Removed fetchLeaderboard() call
          fetchChangelogs(); // Fetch public data
          fetchBulletins();
          fetchBlogs(); // Fetch blogs (now accessible by all verified)
          fetchTrades(); // Fetch trades
          fetchPublicUserProfiles(); // Fetch for chat search
          fetchCurrentChats(); // Fetch user's current chats
          fetchShopItems(); // Fetch shop items

          // Only navigate to home if not already on a specific section (e.g., if user refreshed on profile page)
          const currentActiveSection = document.querySelector('section.active');
          if (!currentActiveSection || currentActiveSection.id === 'auth-section') {
            displaySection('home-section');
          }
        }
        // Update post trade button status after auth state changes
        updatePostTradeButtonStatus();

      } else {
        // User is signed out.
        loginNavItem.style.display = 'list-item';
        logoutNavItem.style.display = 'none';
        authStatusNavItem.style.display = 'none';
        myProfileNavItem.style.display = 'none'; // Hide My Profile nav item (restored)
        myProfileHomeCard.style.display = 'none'; // Hide My Profile card on home (restored)
        adminNavItem.style.display = 'none';
        adminHomeCard.style.display = 'none';
        isAdmin = false;
        emailVerifyBanner.classList.remove('active');

        // Clear display name in nav
        authStatusText.textContent = '';
        currentRealmCoin.textContent = '0'; // Reset nav bar coins

        displaySection('auth-section'); // Redirect to auth section
        fetchChangelogs(); // Still fetch public data
        fetchBulletins();
        fetchBlogs();
        // Removed fetchLeaderboard() call
        fetchTrades(); // Fetch trades (can be public)
        fetchPublicUserProfiles(); // Fetch for chat search (can be public)
        fetchShopItems(); // Fetch shop items (can be public)
        // No need to fetch current chats if not logged in

        // Update post trade button status after auth state changes
        updatePostTradeButtonStatus();
      }
    });


    // --- User Profile Management (Restored) ---

    /**
     * Fetches user profile data and currency, then updates the UI.
     * @param {string} uid - The user's UID.
     */
    async function fetchUserProfile(uid) {
      if (!uid) {
        // If no user is logged in, reset profile UI
        updateProfileUI({}, {});
        return;
      }

      const profileRef = db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('profile').doc('data');
      const currencyRef = db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('currency').doc('data');

      try {
        const [profileDoc, currencyDoc] = await Promise.all([
          profileRef.get(),
          currencyRef.get()
        ]);

        const profileData = profileDoc.exists ? profileDoc.data() : {};
        const currencyData = currencyDoc.exists ? currencyDoc.data() : {};

        // Update global currentUser object with profile data for easy access
        if (currentUser) {
          currentUser.displayName = profileData.displayName || currentUser.email.substring(0, 5);
          currentUser.photoURL = profileData.profilePictureUrl || DEFAULT_PFP;
          currentUser.realmCoins = currencyData.realmCoins || 0;
          currentUser.lastPublicChatVisitTimestamp = profileData.lastPublicChatVisitTimestamp || firebase.firestore.Timestamp.fromDate(new Date(0)); // Initialize chat visit time
        }

        updateProfileUI(profileData, currencyData);
        // Update header Realm Coin display
        currentRealmCoin.textContent = (currencyData.realmCoins || 0).toLocaleString();
        // Update nav status text with full display name
        authStatusText.textContent = `Logged in as: ${profileData.displayName || currentUser.email.substring(0, 5)}`;

      } catch (error) {
        console.error("Error fetching user profile or currency:", error.message);
        showMessage("Failed to load profile data.", "error");
        // Fallback for header display if profile fetch fails
        if (currentUser) {
          currentRealmCoin.textContent = '0';
          authStatusText.textContent = `Logged in as: ${currentUser.email.substring(0, 5)}`;
        }
      }
    }

    /**
     * Updates the My Profile section UI with fetched data.
     * @param {object} profileData - User's profile data.
     * @param {object} currencyData - User's currency data.
     */
    function updateProfileUI(profileData, currencyData) {
      profileAvatar.src = profileData.profilePictureUrl || DEFAULT_PFP;
      profileDisplayName.textContent = profileData.displayName || (currentUser ? currentUser.email.substring(0, 5) : 'Guest');
      profileEmail.textContent = currentUser ? currentUser.email : 'N/A';
      profileCoins.textContent = (currencyData.realmCoins || 0).toLocaleString();

      // Populate edit form
      updateDisplayNameInput.value = profileData.displayName || (currentUser ? currentUser.email.substring(0, 5) : '');
      updateProfilePicInput.value = profileData.profilePictureUrl || '';
    }

    // Event listener for updating profile
    updateProfileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showMessage("Please login to update your profile.", "error");
        return;
      }
      if (!currentUser.emailVerified) {
        showMessage("Please verify your email to update your profile.", "warning");
        return;
      }

      const newDisplayName = updateDisplayNameInput.value.trim();
      const newProfilePicUrl = updateProfilePicInput.value.trim();

      if (newDisplayName === '' || newDisplayName.length > 50) {
        showMessage('Display Name is required and must be 50 characters or less.', 'error');
        return;
      }

      const profileRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('profile').doc('data');
      const publicProfileRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('userPublicProfiles').doc(currentUser.uid);


      try {
        await profileRef.set({
          displayName: newDisplayName,
          profilePictureUrl: newProfilePicUrl || DEFAULT_PFP // Store default if empty
        }, {
          merge: true
        }); // Use merge to update existing fields without overwriting others

        // Also update the Firebase Auth profile for consistency (though not directly used for display here)
        await currentUser.updateProfile({
          displayName: newDisplayName,
          photoURL: newProfilePicUrl || DEFAULT_PFP
        });

        // Update public profile for search/chat
        await publicProfileRef.set({
          displayName: newDisplayName,
          uid: currentUser.uid,
          email: currentUser.email, // Store full email for search
          emailPrefix: currentUser.email.substring(0, 5)
        }, {
          merge: true
        });


        showMessage('Profile updated successfully!', 'success');
        fetchUserProfile(currentUser.uid); // Refresh UI
        fetchBlogs(); // Refresh blogs to show new author name/pfp
        fetchTrades(); // Refresh trades to show new poster name
        fetchPublicUserProfiles(); // Refresh public user profiles for search
      } catch (error) {
        console.error("Error updating profile:", error.message);
        showMessage(`Failed to update profile: ${error.message}`, 'error');
      }
    });


    // --- Content Management (Admin Functions) ---

    // Add Changelog
    addChangelogForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isAdmin) {
        showMessage("Permission denied.", "error");
        return;
      }

      const title = changelogTitleInput.value.trim();
      const content = changelogContentInput.value.trim();

      // Input validation
      if (title === '' || title.length > 100) {
        showMessage('Changelog Title is required and must be 100 characters or less.', 'error');
        return;
      }
      if (content === '' || content.length > 1000) {
        showMessage('Changelog Content is required and must be 1000 characters or less.', 'error');
        return;
      }

      try {
        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('changelogs').add({
          title: title,
          content: content,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          authorEmail: currentUser ? currentUser.email : 'Admin'
        });
        showMessage('Changelog added successfully!', 'success');
        addChangelogForm.reset();
        fetchChangelogs();
      } catch (error) {
        console.error("Add Changelog Error:", error.message);
        showMessage(`Failed to add changelog: ${error.message}`, 'error');
      }
    });

    // Fetch Changelogs
    async function fetchChangelogs() {
      try {
        const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('changelogs').orderBy('timestamp', 'desc').get();
        renderChangelogs(snapshot.docs);
      } catch (error) {
        console.error("Error fetching changelogs:", error.message);
        // Removed showMessage(`Failed to load changelogs: ${error.message}`, 'error');
      }
    }

    // Render Changelogs
    function renderChangelogs(docs) {
      changelogsContainer.innerHTML = ''; // Clear existing
      if (docs.length === 0) {
        changelogsContainer.innerHTML = '<p>No changelogs yet.</p>';
        return;
      }
      docs.forEach(doc => {
        const changelog = doc.data();
        const changelogItem = document.createElement('div');
        changelogItem.classList.add('post-item');
        const postDate = changelog.timestamp ? new Date(changelog.timestamp.toDate()).toLocaleString() : 'Unknown Date';

        changelogItem.innerHTML = `
          <h3>${changelog.title}</h3>
          <p class="blog-meta">Posted by ${changelog.authorEmail ? changelog.authorEmail.substring(0, 5) : 'Anonymous'} on ${postDate}</p>
          <p>${changelog.content}</p>
          ${isAdmin ? `<button class="delete-button danger-button" data-id="${doc.id}" data-type="changelog">Delete</button>` : ''}
        `;
        changelogsContainer.appendChild(changelogItem);
      });

      if (isAdmin) {
        changelogsContainer.querySelectorAll('.delete-button').forEach(button => {
          button.addEventListener('click', (e) => {
            const docId = e.target.dataset.id;
            deleteContent('changelog', docId);
          });
        });
      }
    }

    // Add Bulletin
    addBulletinForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isAdmin) {
        showMessage("Permission denied.", "error");
        return;
      }

      const title = bulletinTitleInput.value.trim();
      const content = bulletinContentInput.value.trim();

      // Input validation
      if (title === '' || title.length > 100) {
        showMessage('Bulletin Title is required and must be 100 characters or less.', 'error');
        return;
      }
      if (content === '' || content.length > 1000) {
        showMessage('Bulletin Content is required and must be 1000 characters or less.', 'error');
        return;
      }

      try {
        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bulletins').add({
          title: title,
          content: content,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          authorEmail: currentUser ? currentUser.email : 'Admin'
        });
        showMessage('Bulletin added successfully!', 'success');
        addBulletinForm.reset();
        fetchBulletins();
      } catch (error) {
        console.error("Add Bulletin Error:", error.message);
        showMessage(`Failed to add bulletin: ${error.message}`, 'error');
      }
    });

    // Fetch Bulletins
    async function fetchBulletins() {
      try {
        const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bulletins').orderBy('timestamp', 'desc').get();
        renderBulletins(snapshot.docs);
      } catch (error) {
        console.error("Error fetching bulletins:", error.message);
        // Removed showMessage(`Failed to load bulletins: ${error.message}`, 'error');
      }
    }

    // Render Bulletins
    function renderBulletins(docs) {
      bulletinsContainer.innerHTML = ''; // Clear existing
      if (docs.length === 0) {
        bulletinsContainer.innerHTML = '<p>No bulletins yet.</p>';
        return;
      }
      docs.forEach(doc => {
        const bulletin = doc.data();
        const bulletinItem = document.createElement('div');
        bulletinItem.classList.add('post-item');
        const postDate = bulletin.timestamp ? new Date(bulletin.timestamp.toDate()).toLocaleString() : 'Unknown Date';

        bulletinItem.innerHTML = `
          <h3>${bulletin.title}</h3>
          <p class="blog-meta">Posted by ${bulletin.authorEmail ? bulletin.authorEmail.substring(0, 5) : 'Anonymous'} on ${postDate}</p>
          <p>${bulletin.content}</p>
          ${isAdmin ? `<button class="delete-button danger-button" data-id="${doc.id}" data-type="bulletin">Delete</button>` : ''}
        `;
        bulletinsContainer.appendChild(bulletinItem);
      });

      if (isAdmin) {
        bulletinsContainer.querySelectorAll('.delete-button').forEach(button => {
          button.addEventListener('click', (e) => {
            const docId = e.target.dataset.id;
            deleteContent('bulletin', docId);
          });
        });
      }
    }

    // Generic Delete Content Function
    async function deleteContent(type, docId) {
      // For blogs and trades, allow author to delete their own. For others, only admin.
      let canDelete = isAdmin;
      if (type === 'blog' && currentUser) {
        const blogDoc = await db.collection(`artifacts/${appId}/public/data/blogs`).doc(docId).get();
        if (blogDoc.exists && blogDoc.data().authorUid === currentUser.uid) {
          canDelete = true;
        }
      } else if (type === 'trade' && currentUser) {
        const tradeDoc = await db.collection(`artifacts/${appId}/public/data/trades`).doc(docId).get();
        if (tradeDoc.exists && tradeDoc.data().posterUid === currentUser.uid) {
          canDelete = true;
        }
      }

      if (!canDelete) {
        showMessage("Permission denied.", "error");
        return;
      }

      // Custom confirmation dialog
      const confirmDelete = await new Promise(resolve => {
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
        `;
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: var(--card-bg);
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 0 15px rgba(0,204,255,0.5);
          text-align: center;
          color: var(--text);
        `;
        modalContent.innerHTML = `
          <p style="margin-bottom: 20px;">Are you sure you want to delete this ${type}?</p>
          <button id="confirmDeleteBtn" style="background-color: var(--decline-color); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Yes, Delete</button>
          <button id="cancelDeleteBtn" style="background-color: var(--primary); color: black; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
        `;
        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        document.getElementById('confirmDeleteBtn').onclick = () => {
          document.body.removeChild(modal);
          resolve(true);
        };
        document.getElementById('cancelDeleteBtn').onclick = () => {
          document.body.removeChild(modal);
          resolve(false);
        };
      });

      if (!confirmDelete) {
        showMessage(`${type.charAt(0).toUpperCase() + type.slice(1)} deletion cancelled.`, 'info');
        return;
      }

      try {
        const collectionPath = `artifacts/${appId}/public/data/${type}s`; // e.g., 'bulletins', 'changelogs'
        await db.collection(collectionPath).doc(docId).delete();
        showMessage(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully!`, 'success');
        if (type === 'changelog') fetchChangelogs();
        else if (type === 'bulletin') fetchBulletins();
        else if (type === 'blog') fetchBlogs(); // Added for blog deletion
        else if (type === 'trade') fetchTrades(); // Added for trade deletion
        else if (type === 'shopItem') fetchShopItems(); // Added for shop item deletion
      } catch (error) {
        console.error(`Error deleting ${type}:`, error.message);
        showMessage(`Failed to delete ${type}: ${error.message}`, 'error');
      }
    }


    // --- Blog Management ---
    let allBlogs = [];
    const blogsPerPage = 10;
    let currentBlogPage = 1;
    let totalBlogPages = 1;

    // Add Blog Post
    addBlogForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showMessage("Please login to create a blog post.", "error");
        return;
      }
      if (!currentUser.emailVerified) {
        showMessage("Please verify your email to create blog posts.", "warning");
        return;
      }

      const blogTitle = blogTitleInput.value.trim();
      const blogContent = blogContentInput.value.trim();

      // Input validation
      if (blogTitle === '' || blogTitle.length > 100) {
        showMessage('Blog Title is required and must be 100 characters or less.', 'error');
        return;
      }
      if (blogContent === '' || blogContent.length > 2000) {
        showMessage('Blog Content is required and must be 2000 characters or less.', 'error');
        return;
      }


      try {
        // Fetch current user's profile data for blog post (restored)
        const profileRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('profile').doc('data');
        const profileDoc = await profileRef.get();
        const profileData = profileDoc.exists ? profileDoc.data() : {};

        const authorDisplayName = profileData.displayName || currentUser.email.substring(0, 5);
        const authorPfpUrl = profileData.profilePictureUrl || DEFAULT_PFP;

        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('blogs').add({
          title: blogTitle,
          content: blogContent,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          authorUid: currentUser.uid,
          authorEmail: currentUser.email,
          authorDisplayName: authorDisplayName, // Use actual display name
          authorPfpUrl: authorPfpUrl // Use actual PFP URL
        });
        showMessage('Blog post published successfully!', 'success');
        addBlogForm.reset();
        currentBlogPage = 1; // Reset to first page after adding new blog
        fetchBlogs();
      } catch (error) {
        console.error("Add Blog Error:", error.message);
        showMessage(`Failed to publish blog post: ${error.message}`, 'error');
      }
    });

    // Fetch Blogs
    async function fetchBlogs() {
      try {
        const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('blogs').orderBy('timestamp', 'desc').get();
        allBlogs = snapshot.docs; // Store all docs for pagination
        totalBlogPages = Math.ceil(allBlogs.length / blogsPerPage);

        renderBlogs(); // Render current page of blogs
        updateBlogPaginationUI(); // Update pagination controls

        // Show/hide add blog form based on user login/verification status
        if (currentUser && currentUser.emailVerified) {
          addBlogContainer.style.display = 'block';
        } else {
          addBlogContainer.style.display = 'none';
        }
      } catch (error) {
        console.error("Error fetching blogs:", error.message);
        // Removed showMessage(`Failed to load blogs: ${error.message}`, 'error');
      }
    }

    // Render Blogs for the current page
    function renderBlogs() {
      blogsContainer.innerHTML = ''; // Clear existing
      const startIndex = (currentBlogPage - 1) * blogsPerPage;
      const endIndex = startIndex + blogsPerPage;
      const blogsToDisplay = allBlogs.slice(startIndex, endIndex);

      if (blogsToDisplay.length === 0) {
        blogsContainer.innerHTML = '<p>No blog posts yet.</p>';
        return;
      }
      blogsToDisplay.forEach(doc => {
        const blog = doc.data();
        const blogItem = document.createElement('div');
        blogItem.classList.add('post-item');
        const postDate = blog.timestamp ? new Date(blog.timestamp.toDate()).toLocaleString() : 'Unknown Date';

        const isAuthor = currentUser && blog.authorUid === currentUser.uid;
        const canDelete = isAdmin || isAuthor;

        // Use stored display name and PFP from blog document
        const displayAuthorName = blog.authorDisplayName || (blog.authorEmail ? blog.authorEmail.substring(0, 5) : 'Anonymous');
        const displayAuthorPfp = blog.authorPfpUrl || DEFAULT_PFP;


        blogItem.innerHTML = `
          <p class="blog-meta">
            <img src="${displayAuthorPfp}" alt="Author PFP" class="pfp-small">
            Posted by <span class="author-name">${displayAuthorName}</span> on ${postDate}
          </p>
          <h3>${blog.title}</h3>
          <p>${blog.content}</p>
          ${canDelete ? `<button class="delete-button danger-button" data-id="${doc.id}" data-type="blog">Delete</button>` : ''}
        `;
        blogsContainer.appendChild(blogItem);
      });

      blogsContainer.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', (e) => {
          const docId = e.target.dataset.id;
          deleteContent('blog', docId); // Use generic deleteContent for blogs
        });
      });

      // Removed event listeners for PFP/Author Name clicks as there's no profile section
    }

    // Update Blog Pagination UI
    function updateBlogPaginationUI() {
      if (totalBlogPages > 1) {
        blogPaginationControls.style.display = 'flex';
        blogPageInfoSpan.textContent = `Page ${currentBlogPage} of ${totalBlogPages}`;
        prevBlogPageButton.disabled = (currentBlogPage === 1);
        nextBlogPageButton.disabled = (currentBlogPage === totalBlogPages);
      } else {
        blogPaginationControls.style.display = 'none';
      }
    }

    // Pagination button event listeners
    prevBlogPageButton.addEventListener('click', () => {
      if (currentBlogPage > 1) {
        currentBlogPage--;
        renderBlogs();
        updateBlogPaginationUI();
      }
    });

    nextBlogPageButton.addEventListener('click', () => {
      if (currentBlogPage < totalBlogPages) {
        currentBlogPage++;
        renderBlogs();
        updateBlogPaginationUI();
      }
    });

    // Delete Blog Post (now handled by generic deleteContent)
    // async function deleteBlogPost(docId) { ... }


    // --- Daily Realm Coin & Leaderboard ---

    // Claim Daily Realm Coin (Uses Firestore Transaction for atomicity)
    dailyClaimButton.addEventListener('click', async () => {
      if (!currentUser) {
        showMessage("Please login to claim daily Realm Coins.", "error");
        return;
      }
      if (!currentUser.emailVerified) {
        showMessage("Please verify your email to claim daily Realm Coins.", "warning");
        return;
      }

      const userId = currentUser.uid;
      const userCurrencyRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('currency').doc('data');
      const COIN_REWARD = 5; // Amount of coins per claim - UPDATED TO 5
      const COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

      try {
        await db.runTransaction(async (transaction) => {
          const userDoc = await transaction.get(userCurrencyRef);

          if (!userDoc.exists) {
            // If currency doc doesn't exist, create it with initial values
            transaction.set(userCurrencyRef, {
              realmCoins: COIN_REWARD,
              lastClaimTime: firebase.firestore.FieldValue.serverTimestamp()
            });
            showMessage(`Successfully claimed ${COIN_REWARD} Realm Coins!`, 'success');
            return; // Transaction successful
          }

          const userData = userDoc.data();
          const lastClaimTime = userData.lastClaimTime ? userData.lastClaimTime.toDate().getTime() : 0;
          const currentTime = Date.now();

          if (currentTime - lastClaimTime < COOLDOWN_MS) {
            const timeLeftMs = COOLDOWN_MS - (currentTime - lastClaimTime);
            const hours = Math.floor(timeLeftMs / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeftMs % (1000 * 60 * 60)) / (1000 * 60));
            throw new Error(`You can claim again in ${hours}h ${minutes}m.`);
          }

          // Update user's coins and last claim time
          const newRealmCoins = (userData.realmCoins || 0) + COIN_REWARD;
          transaction.update(userCurrencyRef, {
            realmCoins: newRealmCoins,
            lastClaimTime: firebase.firestore.FieldValue.serverTimestamp()
          });

          showMessage(`Successfully claimed ${COIN_REWARD} Realm Coins!`, 'success');
        });
      } catch (error) {
        console.error("Claim Daily Coin Error:", error.message);
        showMessage(`Claim failed: ${error.message}`, 'error');
      } finally {
        updateDailyClaimUI(); // Always re-check status after attempt
        // Removed fetchLeaderboard() call
        fetchUserProfile(currentUser.uid); // Refresh user profile to update coins (restored)
      }
    });

    let claimTimerInterval = null;

    function updateDailyClaimUI() {
      if (!currentUser || !currentUser.emailVerified) {
        dailyClaimStatus.textContent = "Login & Verify Email to Claim.";
        dailyClaimButton.disabled = true;
        dailyClaimButton.classList.add('claimed');
        dailyClaimStatus.classList.remove('claim-ready');
        clearInterval(claimTimerInterval);
        currentRealmCoin.textContent = '0'; // Reset nav bar coins
        return;
      }

      db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('currency').doc('data').get().then(doc => {
        if (doc.exists) {
          const userData = doc.data();
          const lastClaimTime = userData.lastClaimTime ? userData.lastClaimTime.toDate().getTime() : 0;
          const currentTime = Date.now();
          const COOLDOWN_MS = 24 * 60 * 60 * 1000;

          currentRealmCoin.textContent = userData.realmCoins ? userData.realmCoins.toLocaleString() : '0';

          if (currentTime - lastClaimTime < COOLDOWN_MS) {
            dailyClaimButton.disabled = true;
            dailyClaimButton.classList.add('claimed');
            dailyClaimStatus.classList.remove('claim-ready');
            startClaimCooldownTimer(COOLDOWN_MS - (currentTime - lastClaimTime));
          } else {
            dailyClaimButton.disabled = false;
            dailyClaimButton.classList.remove('claimed');
            dailyClaimStatus.textContent = "Ready to claim!";
            dailyClaimStatus.classList.add('claim-ready');
            clearInterval(claimTimerInterval);
          }
        } else {
          // User currency doc not found, assume never claimed
          dailyClaimButton.disabled = false;
          dailyClaimButton.classList.remove('claimed');
          dailyClaimStatus.textContent = "Ready to claim!";
          dailyClaimStatus.classList.add('claim-ready');
          clearInterval(claimTimerInterval);
          currentRealmCoin.textContent = '0'; // Default if no currency doc
        }
      }).catch(error => {
        console.error("Error updating daily claim UI:", error.message);
        // Removed showMessage("Failed to load claim status.", "error");
        dailyClaimButton.disabled = true; // Disable on error
      });
    }

    function startClaimCooldownTimer(initialTimeLeftMs) {
      clearInterval(claimTimerInterval); // Clear any existing timer
      let timeLeft = initialTimeLeftMs;

      if (timeLeft <= 0) {
        updateDailyClaimUI(); // Immediately update if already expired
        return;
      }

      claimTimerInterval = setInterval(() => {
        timeLeft -= 1000; // Decrement by 1 second

        if (timeLeft <= 0) {
          clearInterval(claimTimerInterval);
          updateDailyClaimUI(); // Update UI to "Ready to claim!"
        } else {
          const hours = Math.floor(timeLeft / (1000 * 60 * 60));
          const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
          dailyClaimStatus.innerHTML = `You can claim again in: <span class="countdown-display">${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</span>`;
        }
      }, 1000);
    }

    // Removed fetchLeaderboard and renderLeaderboard functions as requested.

    /**
     * Helper function to parse string values like "1.2b", "960m", "1.5m", "800k" into numbers.
     * @param {string} valueString - The string representation of the value.
     * @returns {number} The parsed numerical value.
     */
    function parseValue(valueString) {
        valueString = valueString.toLowerCase().trim();
        let num = parseFloat(valueString);

        if (isNaN(num)) {
            console.warn(`Could not parse numerical part from: ${valueString}`);
            return 0;
        }

        if (valueString.endsWith('b')) {
            num *= 1000000000;
        } else if (valueString.endsWith('m')) {
            num *= 1000000;
        } else if (valueString.endsWith('k')) {
            num *= 1000;
        }
        return num;
    }

    // --- Blox Fruits Trade Calculator ---
    // Updated fruits array based on user's specific list and values
    const fruits = [
      { name: "Dragon (West)", rarity: "Mythical", beli: 15000000, tradeValue: parseValue("1.2b") },
      { name: "Dragon (East)", rarity: "Mythical", beli: 15000000, tradeValue: parseValue("960m") },
      { name: "Kitsune", rarity: "Mythical", beli: 8000000, tradeValue: parseValue("240m") },
      { name: "Yeti", rarity: "Legendary", beli: 5000000, tradeValue: parseValue("140m") },
      { name: "Gas", rarity: "Legendary", beli: 3200000, tradeValue: parseValue("75m") },
      { name: "Leopard", rarity: "Legendary", beli: 5000000, tradeValue: parseValue("60m") }, // Using 60m for Leopard
      { name: "Gravity", rarity: "Legendary", beli: 2500000, tradeValue: parseValue("45m") },
      { name: "T-Rex", rarity: "Legendary", beli: 2700000, tradeValue: parseValue("20m") },
      { name: "Control", rarity: "Legendary", beli: 3200000, tradeValue: parseValue("12m") },
      { name: "Spirit", rarity: "Legendary", beli: 3400000, tradeValue: parseValue("10m") },
      { name: "Mammoth", rarity: "Legendary", beli: 2700000, tradeValue: parseValue("10m") },
      { name: "Venom", rarity: "Legendary", beli: 3000000, tradeValue: parseValue("10m") },
      { name: "Portal", rarity: "Rare", beli: 1900000, tradeValue: parseValue("10m") },
      { name: "Buddha", rarity: "Rare", beli: 1200000, tradeValue: parseValue("10m") },
      { name: "Rumble", rarity: "Rare", beli: 2100000, tradeValue: parseValue("7m") },
      { name: "Shadow", rarity: "Legendary", beli: 2900000, tradeValue: parseValue("6m") },
      { name: "Blizzard", rarity: "Rare", beli: 2400000, tradeValue: parseValue("6m") },
      { name: "Sound", rarity: "Rare", beli: 1700000, tradeValue: parseValue("4.5m") },
      { name: "Phoenix", rarity: "Rare", beli: 1800000, tradeValue: parseValue("4m") }, // Corrected typo from 'phoneix'
      { name: "Creation", rarity: "Rare", beli: 1400000, tradeValue: parseValue("4m") },
      { name: "Pain", rarity: "Rare", beli: 2300000, tradeValue: parseValue("4m") },
      { name: "Spider", rarity: "Rare", beli: 1500000, tradeValue: parseValue("1.5m") },
      { name: "Diamond", rarity: "Rare", beli: 600000, tradeValue: parseValue("1.5m") },
      { name: "Love", rarity: "Rare", beli: 1300000, tradeValue: parseValue("1.25m") },
      { name: "Magma", rarity: "Uncommon", beli: 960000, tradeValue: parseValue("1.15m") },
      { name: "Quake", rarity: "Rare", beli: 1000000, tradeValue: parseValue("1m") },
      { name: "Light", rarity: "Uncommon", beli: 650000, tradeValue: parseValue("800k") },
      { name: "Ghost", rarity: "Uncommon", beli: 940000, tradeValue: parseValue("800k") },
      { name: "Eagle", rarity: "Uncommon", beli: 550000, tradeValue: parseValue("800k") },
      { name: "Rubber", rarity: "Uncommon", beli: 750000, tradeValue: parseValue("700k") },
      { name: "Ice", rarity: "Uncommon", beli: 350000, tradeValue: parseValue("550k") },
      { name: "Sand", rarity: "Uncommon", beli: 420000, tradeValue: parseValue("420k") },
      { name: "Dark", rarity: "Uncommon", beli: 500000, tradeValue: parseValue("400k") },
      { name: "Flame", rarity: "Uncommon", beli: 250000, tradeValue: parseValue("250k") },
      { name: "Spike", rarity: "Common", beli: 180000, tradeValue: parseValue("180k") },
      { name: "Smoke", rarity: "Common", beli: 100000, tradeValue: parseValue("100k") },
      { name: "Bomb", rarity: "Common", beli: 80000, tradeValue: parseValue("80k") },
      { name: "Spring", rarity: "Common", beli: 60000, tradeValue: parseValue("60k") },
      { name: "Blade", rarity: "Common", beli: 30000, tradeValue: parseValue("50k") },
      { name: "Spin", rarity: "Common", beli: 7500, tradeValue: parseValue("7.5k") },
      { name: "Rocket", rarity: "Common", beli: 5000, tradeValue: parseValue("5k") },
    ];


    let fruitQuantities = {}; // For Trade Calculator
    let tradeOfferQuantities = {}; // For Trade Posting
    let tradeWantQuantities = {}; // For Trade Posting

    // Initialize quantities to 0 for all contexts
    fruits.forEach(fruit => {
      fruitQuantities[fruit.name] = 0;
      tradeOfferQuantities[fruit.name] = 0;
      tradeWantQuantities[fruit.name] = 0;
    });

    // Render fruits to the calculator
    function renderFruits(searchTerm = '') {
      fruitListContainer.innerHTML = '';
      const filteredFruits = fruits.filter(fruit =>
        fruit.name.toLowerCase().includes(searchTerm.toLowerCase())
      );

      if (filteredFruits.length === 0) {
        fruitListContainer.innerHTML = '<p style="text-align: center; width: 100%; color: var(--text-secondary);">No fruits found matching your search.</p>';
        return;
      }

      filteredFruits.forEach(fruit => {
        const fruitCard = document.createElement('div');
        fruitCard.classList.add('fruit-card');
        const rarityClass = `rarity-${fruit.rarity.toLowerCase().replace(' ', '-')}`; // e.g., rarity-mythical

        fruitCard.innerHTML = `
          <img src="https://placehold.co/110x110/1a1a1a/e0f7ff?text=${encodeURIComponent(fruit.name.split(' ')[0])}" alt="${fruit.name} Fruit" onerror="this.onerror=null;this.src='https://placehold.co/110x110/1a1a1a/e0f7ff?text=Fruit';"/>
          <div class="fruit-name">${fruit.name}</div>
          <div class="fruit-rarity ${rarityClass}">${fruit.rarity}</div>
          <div class="fruit-values">
            <p>Beli: ${fruit.beli.toLocaleString()}</p>
            <p>Trade Value: ${fruit.tradeValue.toLocaleString()}</p>
          </div>
          <div class="fruit-quantity-control">
            <button data-fruit="${fruit.name}" data-action="decrease" data-context="calculator">-</button>
            <span id="quantity-calculator-${fruit.name.replace(/[^a-zA-Z0-9]/g, '-')}" class="fruit-quantity">${fruitQuantities[fruit.name]}</span>
            <button data-fruit="${fruit.name}" data-action="increase" data-context="calculator">+</button>
          </div>
        `;
        fruitListContainer.appendChild(fruitCard);
      });

      // Add event listeners for quantity controls
      fruitListContainer.querySelectorAll('.fruit-quantity-control button').forEach(button => {
        button.addEventListener('click', (e) => {
          const fruitName = e.target.dataset.fruit;
          const action = e.target.dataset.action;
          const context = e.target.dataset.context;
          updateFruitQuantity(fruitName, action, context);
        });
      });
    }

    function updateFruitQuantity(fruitName, action, context) {
      let quantitiesMap;
      let quantityElementIdPrefix;

      if (context === 'calculator') {
        quantitiesMap = fruitQuantities;
        quantityElementIdPrefix = 'quantity-calculator-';
      } else if (context === 'offer') {
        quantitiesMap = tradeOfferQuantities;
        quantityElementIdPrefix = 'quantity-offer-';
      } else if (context === 'want') {
        quantitiesMap = tradeWantQuantities;
        quantityElementIdPrefix = 'quantity-want-';
      } else {
        console.error("Invalid context for updateFruitQuantity:", context);
        return;
      }

      if (action === 'increase') {
        quantitiesMap[fruitName]++;
      } else if (action === 'decrease' && quantitiesMap[fruitName] > 0) {
        quantitiesMap[fruitName]--;
      }

      const quantityElement = document.getElementById(`${quantityElementIdPrefix}${fruitName.replace(/[^a-zA-Z0-9]/g, '-')}`);
      if (quantityElement) {
        quantityElement.textContent = quantitiesMap[fruitName];
      }

      if (context === 'calculator') {
        calculateTotals();
      } else if (context === 'offer' || context === 'want') {
        // Update the post trade button status whenever offer/want quantities change
        updatePostTradeButtonStatus();
      }
    }

    function calculateTotals() {
      let totalBeli = 0;
      let totalTradeValue = 0;

      for (const fruit of fruits) {
        const quantity = fruitQuantities[fruit.name] || 0;
        totalBeli += fruit.beli * quantity;
        totalTradeValue += fruit.tradeValue * quantity;
      }

      totalBeliSpan.textContent = totalBeli.toLocaleString();
      totalTradeValueSpan.textContent = totalTradeValue.toLocaleString();
    }

    fruitSearchInput.addEventListener('input', (e) => {
      renderFruits(e.target.value);
      const clearButton = document.querySelector(`[data-target-input="fruit-search"]`);
      if (e.target.value.length > 0) {
        clearButton.style.display = 'block';
      } else {
        clearButton.style.display = 'none';
      }
    });

    // --- Trade Section Logic ---

    function setupTradeForm() {
      // Clear previous selections
      tradeOfferQuantities = {};
      tradeWantQuantities = {};
      fruits.forEach(fruit => {
        tradeOfferQuantities[fruit.name] = 0;
        tradeWantQuantities[fruit.name] = 0;
      });

      renderTradeFruitSelection(offerFruitsSelection, 'offer');
      renderTradeFruitSelection(wantFruitsSelection, 'want');

      // Show/hide post trade form based on user login/verification status
      if (currentUser && currentUser.emailVerified) {
        postTradeContainer.style.display = 'block';
      } else {
        postTradeContainer.style.display = 'none';
      }
      // Initial update of the post trade button status
      updatePostTradeButtonStatus();
    }

    function renderTradeFruitSelection(containerElement, context) {
      containerElement.innerHTML = '';
      fruits.forEach(fruit => {
        const fruitCard = document.createElement('div');
        fruitCard.classList.add('fruit-select-card');
        const quantityMap = (context === 'offer') ? tradeOfferQuantities : tradeWantQuantities;

        fruitCard.innerHTML = `
          <img src="https://placehold.co/60x60/1a1a1a/e0f7ff?text=${encodeURIComponent(fruit.name.split(' ')[0])}" alt="${fruit.name} Fruit" onerror="this.onerror=null;this.src='https://placehold.co/60x60/1a1a1a/e0f7ff?text=Fruit';"/>
          <div class="fruit-name">${fruit.name}</div>
          <div class="fruit-quantity-control">
            <button data-fruit="${fruit.name}" data-action="decrease" data-context="${context}">-</button>
            <span id="quantity-${context}-${fruit.name.replace(/[^a-zA-Z0-9]/g, '-')}" class="fruit-quantity">${quantityMap[fruit.name]}</span>
            <button data-fruit="${fruit.name}" data-action="increase" data-context="${context}">+</button>
          </div>
        `;
        containerElement.appendChild(fruitCard);
      });

      containerElement.querySelectorAll('.fruit-quantity-control button').forEach(button => {
        button.addEventListener('click', (e) => {
          const fruitName = e.target.dataset.fruit;
          const action = e.target.dataset.action;
          const context = e.target.dataset.context;
          updateFruitQuantity(fruitName, action, context);
        });
      });
    }

    /**
     * Updates the disabled state of the "Post Trade" button.
     * The button is enabled only if at least one offer fruit and one request fruit are selected.
     */
    function updatePostTradeButtonStatus() {
      const hasOfferFruits = Object.values(tradeOfferQuantities).some(q => q > 0);
      const hasWantFruits = Object.values(tradeWantQuantities).some(q => q > 0);

      // Button is enabled if user is logged in, email is verified, AND at least one offer and one want fruit are selected
      postTradeButton.disabled = !(currentUser && currentUser.emailVerified && hasOfferFruits && hasWantFruits);
    }


    postTradeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showMessage("Please login to post a trade.", "error");
        return;
      }
      if (!currentUser.emailVerified) {
        showMessage("Please verify your email to post a trade.", "warning");
        return;
      }

      const fruitsOffered = Object.keys(tradeOfferQuantities)
        .filter(name => tradeOfferQuantities[name] > 0)
        .map(name => ({
          name,
          quantity: tradeOfferQuantities[name]
        }));

      const fruitsWanted = Object.keys(tradeWantQuantities)
        .filter(name => tradeWantQuantities[name] > 0)
        .map(name => ({
          name,
          quantity: tradeWantQuantities[name]
        }));

      // Ensure at least one offer fruit and one request fruit are selected
      if (fruitsOffered.length === 0) {
        showMessage("Please select at least one fruit to offer.", "warning");
        return;
      }
      if (fruitsWanted.length === 0) {
        showMessage("Please select at least one fruit you want.", "warning");
        return;
      }

      try {
        const posterDisplayName = currentUser.displayName || currentUser.email.substring(0, 5);
        const posterPfpUrl = currentUser.photoURL || DEFAULT_PFP; // Get PFP from currentUser object
        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('trades').add({
          posterUid: currentUser.uid,
          posterDisplayName: posterDisplayName,
          posterPfpUrl: posterPfpUrl, // Store poster's PFP
          fruitsOffered: fruitsOffered,
          fruitsWanted: fruitsWanted,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'active',
          wins: 0, // Initialize wins
          losses: 0 // Initialize losses
        });
        showMessage('Trade posted successfully!', 'success');
        setupTradeForm(); // Reset form and update button status
      } catch (error) {
        console.error("Error posting trade:", error.message);
        showMessage(`Failed to post trade: ${error.message}`, 'error');
      }
    });

    // Fetch Trades (real-time listener)
    function fetchTrades() {
      db.collection('artifacts').doc(appId).collection('public').doc('data').collection('trades').orderBy('timestamp', 'desc')
        .onSnapshot(snapshot => {
          renderTradeListings(snapshot.docs);
        }, error => {
          console.error("Error fetching trades:", error.message);
          // showMessage(`Failed to load trades: ${error.message}`, 'error');
        });
    }

    async function renderTradeListings(docs) {
      tradeListingsContainer.innerHTML = '';
      if (docs.length === 0) {
        tradeListingsContainer.innerHTML = '<p>No active trades yet. Be the first to post one!</p>';
        return;
      }

      for (const doc of docs) {
        const trade = doc.data();
        const tradeId = doc.id;
        const postDate = trade.timestamp ? new Date(trade.timestamp.toDate()).toLocaleString() : 'Unknown Date';
        const isMyTrade = currentUser && trade.posterUid === currentUser.uid;

        // Fetch user's vote for this trade
        let userVote = null;
        if (currentUser && currentUser.emailVerified && !isMyTrade) {
          const voteDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('trades').doc(tradeId).collection('votes').doc(currentUser.uid).get();
          if (voteDoc.exists) {
            userVote = voteDoc.data().type;
          }
        }

        const tradeCard = document.createElement('div');
        tradeCard.classList.add('trade-listing-card');
        tradeCard.innerHTML = `
          <div class="trade-header">
            <div class="poster-info">
              <img src="${trade.posterPfpUrl || DEFAULT_PFP}" alt="Poster PFP" class="pfp-small">
              <span class="poster-name">${trade.posterDisplayName || 'Anonymous'}</span>
              <span style="font-size: 0.85rem; color: var(--text-secondary);">(${postDate})</span>
            </div>
            ${isMyTrade || isAdmin ? `<button class="danger-button delete-button" data-id="${tradeId}" data-type="trade">Delete Trade</button>` : ''}
          </div>
          <div>
            <p style="font-weight: bold; color: var(--secondary);">Offering:</p>
            <div class="trade-fruits">
              ${trade.fruitsOffered.length > 0 ? trade.fruitsOffered.map(fruit => `
                <div class="fruit-item">
                  <img src="https://placehold.co/30x30/1a1a1a/e0f7ff?text=${encodeURIComponent(fruit.name.split(' ')[0])}" alt="${fruit.name}"/>
                  ${fruit.name} <span class="quantity">x${fruit.quantity}</span>
                </div>
              `).join('') : '<p style="color: var(--text-secondary);">No fruits offered.</p>'}
            </div>
          </div>
          <div>
            <p style="font-weight: bold; color: var(--secondary);">Looking For:</p>
            <div class="trade-fruits">
              ${trade.fruitsWanted.length > 0 ? trade.fruitsWanted.map(fruit => `
                <div class="fruit-item">
                  <img src="https://placehold.co/30x30/1a1a1a/e0f7ff?text=${encodeURIComponent(fruit.name.split(' ')[0])}" alt="${fruit.name}"/>
                  ${fruit.name} <span class="quantity">x${fruit.quantity}</span>
                </div>
              `).join('') : '<p style="color: var(--text-secondary);">No fruits wanted.</p>'}
            </div>
          </div>
          <div class="trade-actions">
            ${!isMyTrade && currentUser && currentUser.emailVerified ? `
              <div class="trade-rating-buttons">
                <button class="w-button ${userVote === 'W' ? 'active-vote' : ''}" data-trade-id="${tradeId}" data-vote-type="W">W</button>
                <span class="w-count">${trade.wins || 0}</span>
                <button class="l-button ${userVote === 'L' ? 'active-vote' : ''}" data-trade-id="${tradeId}" data-vote-type="L">L</button>
                <span class="l-count">${trade.losses || 0}</span>
              </div>
              <button class="button chat-trade-button" data-uid="${trade.posterUid}" data-display-name="${trade.posterDisplayName}">Chat</button>
            ` : ''}
            ${isMyTrade && currentUser && currentUser.emailVerified ? `
              <div class="trade-rating-buttons">
                <span style="color: var(--secondary);">W: ${trade.wins || 0}</span>
                <span style="color: var(--error);">L: ${trade.losses || 0}</span>
              </div>
            ` : ''}
          </div>
        `;
        tradeListingsContainer.appendChild(tradeCard);
      }

      tradeListingsContainer.querySelectorAll('.chat-trade-button').forEach(button => {
        button.addEventListener('click', (e) => {
          const targetUid = e.target.dataset.uid;
          const targetDisplayName = e.target.dataset.displayName;
          openChatWindow(targetUid, targetDisplayName);
        });
      });

      // Add event listeners for W/L buttons
      tradeListingsContainer.querySelectorAll('.trade-rating-buttons button[data-vote-type]').forEach(button => {
        button.addEventListener('click', (e) => {
          const tradeId = e.target.dataset.tradeId;
          const voteType = e.target.dataset.voteType; // Corrected data-type to data-voteType
          castTradeVote(tradeId, voteType);
        });
      });

      // IMPORTANT: Re-attach delete event listeners after rendering new trades
      tradeListingsContainer.querySelectorAll('.delete-button[data-type="trade"]').forEach(button => {
          button.addEventListener('click', (e) => {
            const docId = e.target.dataset.id;
            deleteContent('trade', docId);
          });
        });
    }

    async function castTradeVote(tradeId, voteType) {
      if (!currentUser || !currentUser.emailVerified) {
        showMessage("Please login and verify your email to vote on trades.", "error");
        return;
      }

      const tradeRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('trades').doc(tradeId);
      const userVoteRef = tradeRef.collection('votes').doc(currentUser.uid);

      try {
        await db.runTransaction(async (transaction) => {
          const tradeDoc = await transaction.get(tradeRef);
          const userVoteDoc = await transaction.get(userVoteRef);

          if (!tradeDoc.exists) {
            throw new Error("Trade not found.");
          }

          const tradeData = tradeDoc.data();
          let currentWins = tradeData.wins || 0;
          let currentLosses = tradeData.losses || 0;
          let oldVoteType = null;

          if (userVoteDoc.exists) {
            oldVoteType = userVoteDoc.data().type;
          }

          if (oldVoteType === voteType) {
            // User is clicking the same vote again, effectively un-voting
            if (voteType === 'W') {
              currentWins = Math.max(0, currentWins - 1);
            } else {
              currentLosses = Math.max(0, currentLosses - 1);
            }
            transaction.delete(userVoteRef); // Remove the vote
            showMessage(`Your ${voteType} vote has been removed.`, 'info');
          } else {
            // New vote or changing vote
            if (oldVoteType === 'W') {
              currentWins = Math.max(0, currentWins - 1); // Decrement old vote
            } else if (oldVoteType === 'L') {
              currentLosses = Math.max(0, currentLosses - 1); // Decrement old vote
            }

            if (voteType === 'W') {
              currentWins++;
            } else {
              currentLosses++;
            }
            transaction.set(userVoteRef, {
              type: voteType,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            showMessage(`You voted "${voteType}" on this trade!`, 'success');
          }

          transaction.update(tradeRef, {
            wins: currentWins,
            losses: currentLosses
          });
        });
      } catch (error) {
        console.error("Error casting trade vote:", error.message);
        showMessage(`Failed to cast vote: ${error.message}`, 'error');
      }
    }


    // --- Private Chat Logic ---
    let allPublicUserProfiles = [];
    let currentChatPartnerUid = null;
    let currentChatPartnerDisplayName = null;
    let unsubscribeFromMessages = null; // To manage real-time listener

    // Fetch all public user profiles for search
    function fetchPublicUserProfiles() {
      db.collection('artifacts').doc(appId).collection('public').doc('data').collection('userPublicProfiles')
        .onSnapshot(snapshot => {
          allPublicUserProfiles = snapshot.docs.map(doc => doc.data());
          // Re-render search results if input has value (for both header and main chat search)
          renderHeaderUserSearchResults(headerUserSearchInput.value);
          renderMainUserSearchResults(userSearchInputMain.value);
          // Also update current chats list to reflect latest display names
          fetchCurrentChats();
        }, error => {
          console.error("Error fetching public user profiles:", error.message);
        });
    }

    // Header User Search
    headerUserSearchInput.addEventListener('input', (e) => {
      renderHeaderUserSearchResults(e.target.value);
      const clearButton = document.querySelector(`[data-target-input="header-user-search-input"]`);
      if (e.target.value.length > 0) {
        clearButton.style.display = 'block';
      } else {
        clearButton.style.display = 'none';
      }
    });

    // Clear button for header search
    document.querySelector(`[data-target-input="header-user-search-input"]`).addEventListener('click', () => {
      headerUserSearchInput.value = '';
      headerUserSearchResults.classList.remove('active');
      document.querySelector(`[data-target-input="header-user-search-input"]`).style.display = 'none';
    });


    function renderHeaderUserSearchResults(searchTerm) {
      headerUserSearchResults.innerHTML = ''; // Clear previous results
      headerUserSearchResults.classList.remove('active'); // Hide initially

      if (!currentUser || !currentUser.emailVerified) {
        headerUserSearchResults.innerHTML = '<div style="padding: 10px; color: var(--text-secondary);">Login and verify email to search.</div>';
        headerUserSearchResults.classList.add('active');
        return;
      }

      if (searchTerm.length < 2) { // Require at least 2 characters for search
        headerUserSearchResults.innerHTML = '<div style="padding: 10px; color: var(--text-secondary);">Type at least 2 characters.</div>';
        headerUserSearchResults.classList.add('active');
        return;
      }

      const lowerCaseSearchTerm = searchTerm.toLowerCase();
      const filteredUsers = allPublicUserProfiles.filter(user =>
        user.uid !== currentUser.uid &&
        (user.displayName.toLowerCase().includes(lowerCaseSearchTerm) ||
          (user.email && user.email.toLowerCase().includes(lowerCaseSearchTerm))) // Search by full email
      );

      if (filteredUsers.length === 0) {
        headerUserSearchResults.innerHTML = '<div style="padding: 10px; color: var(--text-secondary);">No users found.</div>';
      } else {
        filteredUsers.forEach(user => {
          const resultItem = document.createElement('div');
          resultItem.classList.add('user-search-result-item');
          resultItem.dataset.uid = user.uid;
          resultItem.innerHTML = `
            <img src="${user.profilePictureUrl || DEFAULT_PFP}" alt="PFP">
            <span>${user.displayName}</span>
            <span style="font-size:0.8em; color:var(--text-secondary); margin-left: auto;">(${user.emailPrefix})</span>
          `;
          resultItem.addEventListener('click', () => {
            openChatWindow(user.uid, user.displayName);
            headerUserSearchResults.classList.remove('active'); // Hide results after selection
            headerUserSearchInput.value = ''; // Clear input
            document.querySelector(`[data-target-input="header-user-search-input"]`).style.display = 'none'; // Hide clear button
          });
          headerUserSearchResults.appendChild(resultItem);
        });
      }
      headerUserSearchResults.classList.add('active'); // Show results
    }

    // Main Chat User Search
    userSearchInputMain.addEventListener('input', (e) => {
      renderMainUserSearchResults(e.target.value);
      const clearButton = document.querySelector(`[data-target-input="user-search-input-main"]`);
      if (e.target.value.length > 0) {
        clearButton.style.display = 'block';
      } else {
        clearButton.style.display = 'none';
      }
    });

    // Clear button for main chat search
    document.querySelector(`[data-target-input="user-search-input-main"]`).addEventListener('click', () => {
      userSearchInputMain.value = '';
      userSearchResultsMain.innerHTML = '';
      document.querySelector(`[data-target-input="user-search-input-main"]`).style.display = 'none';
    });


    function renderMainUserSearchResults(searchTerm) {
      userSearchResultsMain.innerHTML = ''; // Clear previous results

      if (!currentUser || !currentUser.emailVerified) {
        userSearchResultsMain.innerHTML = '<p style="padding: 10px; color: var(--text-secondary);">Login and verify your email to search for users.</p>';
        return;
      }

      if (searchTerm.trim() === '') {
        userSearchResultsMain.innerHTML = '<p style="padding: 10px; color: var(--text-secondary);">Start typing to search for users.</p>';
        return;
      }

      const lowerCaseSearchTerm = searchTerm.toLowerCase();
      const filteredUsers = allPublicUserProfiles.filter(user =>
        user.uid !== currentUser.uid &&
        (user.displayName.toLowerCase().includes(lowerCaseSearchTerm) ||
          (user.email && user.email.toLowerCase().includes(lowerCaseSearchTerm))) // Search by full email
      );

      if (filteredUsers.length === 0) {
        userSearchResultsMain.innerHTML = '<p style="padding: 10px; color: var(--text-secondary);">No users found.</p>';
      } else {
        filteredUsers.forEach(user => {
          const resultItem = document.createElement('div');
          resultItem.classList.add('user-search-item');
          resultItem.innerHTML = `
            <span>${user.displayName} <span style="font-size:0.9em; color:var(--text-secondary);">(${user.emailPrefix})</span></span>
            <button class="button" data-uid="${user.uid}" data-display-name="${user.displayName}">Chat</button>
          `;
          resultItem.addEventListener('click', (e) => {
            const targetUid = e.target.dataset.uid;
            const targetDisplayName = e.target.dataset.displayName;
            openChatWindow(targetUid, targetDisplayName);
          });
          userSearchResultsMain.appendChild(resultItem);
        });
      }
    }

    // Generate a consistent chat room ID
    function getChatRoomId(uid1, uid2) {
      // Sort UIDs to ensure consistent chat room ID regardless of who initiates
      const sortedUids = [uid1, uid2].sort();
      return `chat_${sortedUids[0]}_${sortedUids[1]}`;
    }

    // Open the chat window
    function openChatWindow(targetUid, targetDisplayName) {
      if (!currentUser || !currentUser.emailVerified) {
        showMessage("Please login and verify your email to chat.", "error");
        return;
      }
      if (currentUser.uid === targetUid) {
        showMessage("You cannot chat with yourself.", "warning");
        return;
      }

      currentChatPartnerUid = targetUid;
      currentChatPartnerDisplayName = targetDisplayName;
      chatPartnerName.textContent = `Chat with ${targetDisplayName}`;
      chatWindowModal.classList.add('active');
      chatMessagesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading messages...</p>';
      chatMessageInput.value = ''; // Clear input

      // Mark chat as read when opened
      markChatAsRead(currentChatPartnerUid);

      // Start listening for messages
      fetchMessages(getChatRoomId(currentUser.uid, targetUid));
    }

    // Close the chat window
    chatCloseButton.addEventListener('click', () => {
      chatWindowModal.classList.remove('active');
      currentChatPartnerUid = null;
      currentChatPartnerDisplayName = null;
      if (unsubscribeFromMessages) {
        unsubscribeFromMessages(); // Stop listening to messages
        unsubscribeFromMessages = null;
      }
      fetchCurrentChats(); // Refresh the list of current chats
    });

    // Fetch messages for the current chat
    function fetchMessages(chatRoomId) {
      if (unsubscribeFromMessages) {
        unsubscribeFromMessages(); // Unsubscribe from previous chat's messages
      }

      unsubscribeFromMessages = db.collection('artifacts').doc(appId).collection('chats').doc(chatRoomId).collection('messages').orderBy('timestamp')
        .onSnapshot(snapshot => {
          chatMessagesContainer.innerHTML = ''; // Clear existing messages
          if (snapshot.empty) {
            chatMessagesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No messages yet. Start the conversation!</p>';
            return;
          }

          snapshot.docs.forEach(doc => {
            const message = doc.data();
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            messageDiv.classList.add(message.senderId === currentUser.uid ? 'sent' : 'received');

            const senderDisplayName = message.senderId === currentUser.uid ? 'You' : currentChatPartnerDisplayName;
            const messageTime = message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString([], {
              hour: '2-digit',
              minute: '2-digit'
            }) : '';

            messageDiv.innerHTML = `
              ${message.text}
              <div class="message-meta">${senderDisplayName} ${messageTime}</div>
            `;
            chatMessagesContainer.appendChild(messageDiv);
          });
          // Scroll to bottom of messages
          chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }, error => {
          console.error("Error fetching messages:", error.message);
          showMessage(`Failed to load messages: ${error.message}`, 'error');
          chatMessagesContainer.innerHTML = '<p style="text-align: center; color: var(--error);">Failed to load messages.</p>';
        });
    }

    // Send a message
    sendChatMessageButton.addEventListener('click', async () => {
      const messageText = chatMessageInput.value.trim();
      if (messageText === '' || !currentUser || !currentChatPartnerUid) {
        return;
      }

      const chatRoomId = getChatRoomId(currentUser.uid, currentChatPartnerUid);

      try {
        // Ensure the chat room document exists with participants
        const chatRoomRef = db.collection('artifacts').doc(appId).collection('chats').doc(chatRoomId);
        await chatRoomRef.set({
          participants: [currentUser.uid, currentChatPartnerUid].sort(),
          lastMessage: messageText,
          lastMessageTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
          // Add unread status for the other participant
          [`unread_${currentChatPartnerUid}`]: true
        }, {
          merge: true
        }); // Use merge to avoid overwriting existing fields

        // Add the message to the subcollection
        await chatRoomRef.collection('messages').add({
          senderId: currentUser.uid,
          text: messageText,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        chatMessageInput.value = ''; // Clear input
      } catch (error) {
        console.error("Error sending message:", error.message);
        showMessage(`Failed to send message: ${error.message}`, 'error');
      }
    });

    // Allow sending message with Enter key
    chatMessageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendChatMessageButton.click();
      }
    });

    // Fetch and render current chats for the logged-in user
    function fetchCurrentChats() {
      currentChatsList.innerHTML = ''; // Clear existing list
      if (!currentUser || !currentUser.emailVerified) {
        currentChatsList.innerHTML = '<p>Login and verify your email to see your conversations.</p>';
        return;
      }

      db.collection('artifacts').doc(appId).collection('chats')
        .where('participants', 'array-contains', currentUser.uid)
        .orderBy('lastMessageTimestamp', 'desc')
        .onSnapshot(async snapshot => {
          currentChatsList.innerHTML = ''; // Clear again to prevent duplicates on update
          if (snapshot.empty) {
            currentChatsList.innerHTML = '<p>You have no active conversations.</p>';
            return;
          }

          for (const doc of snapshot.docs) {
            const chat = doc.data();
            const chatRoomId = doc.id;
            const otherParticipantUid = chat.participants.find(uid => uid !== currentUser.uid);

            // Fetch the display name of the other participant (from user's profile)
            const publicProfileDoc = await db.collection('artifacts').doc(appId).collection('users').doc(otherParticipantUid).collection('profile').doc('data').get();
            const otherParticipantDisplayName = publicProfileDoc.exists ? publicProfileDoc.data().displayName : `User-${otherParticipantUid.substring(0, 5)}`;

            const lastMessageText = chat.lastMessage || 'No messages yet.';
            const lastMessageTime = chat.lastMessageTimestamp ? new Date(chat.lastMessageTimestamp.toDate()).toLocaleString() : '';

            const listItem = document.createElement('li');
            listItem.classList.add('chat-list-item');
            listItem.setAttribute('data-uid', otherParticipantUid);
            listItem.setAttribute('data-display-name', otherParticipantDisplayName);

            // Check for unread status for the current user
            const isUnread = chat[`unread_${currentUser.uid}`] === true;

            listItem.innerHTML = `
              <span class="chat-partner-name">${otherParticipantDisplayName}</span>
              <span class="last-message">${lastMessageText}</span>
              <span class="chat-timestamp">${lastMessageTime}</span>
              ${isUnread ? '<div class="unread-dot"></div>' : ''}
            `;
            currentChatsList.appendChild(listItem);
          }

          currentChatsList.querySelectorAll('.chat-list-item').forEach(item => {
            item.addEventListener('click', (e) => {
              const targetUid = item.dataset.uid;
              const targetDisplayName = item.dataset.displayName;
              openChatWindow(targetUid, targetDisplayName);
            });
          });

        }, error => {
          console.error("Error fetching current chats:", error.message);
          currentChatsList.innerHTML = '<p style="color: var(--error);">Failed to load conversations.</p>';
        });
    }

    /**
     * Marks a specific chat as read by clearing the unread flag for the current user.
     * @param {string} partnerUid - The UID of the chat partner.
     */
    async function markChatAsRead(partnerUid) {
      if (!currentUser || !currentUser.emailVerified) {
        return;
      }
      const chatRoomId = getChatRoomId(currentUser.uid, partnerUid);
      const chatRef = db.collection('artifacts').doc(appId).collection('chats').doc(chatRoomId);

      try {
        // Only update if the unread flag is true for the current user
        const chatDoc = await chatRef.get();
        if (chatDoc.exists && chatDoc.data()[`unread_${currentUser.uid}`] === true) {
          await chatRef.update({
            [`unread_${currentUser.uid}`]: firebase.firestore.FieldValue.delete() // Remove the field
          });
        }
      } catch (error) {
        console.error("Error marking chat as read:", error.message);
      }
    }

    // --- Shop Logic (New) ---

    // Add/Update Shop Item (Admin Only)
    addShopItemForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isAdmin) {
        showMessage("Permission denied. Only admins can add/update shop items.", "error");
        return;
      }

      const itemName = shopItemNameInput.value.trim();
      const itemDescription = shopItemDescriptionInput.value.trim();
      const itemPrice = parseInt(shopItemPriceInput.value);
      const itemStock = parseInt(shopItemStockInput.value);

      if (itemName === '' || itemDescription === '' || isNaN(itemPrice) || itemPrice <= 0 || isNaN(itemStock) || itemStock < 0) {
        showMessage("Please fill in all fields correctly for the shop item.", "warning");
        return;
      }

      try {
        // Check if item already exists by name
        const existingItemQuery = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shopItems').where('name', '==', itemName).limit(1).get();

        if (!existingItemQuery.empty) {
          // Update existing item
          const docId = existingItemQuery.docs[0].id;
          await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shopItems').doc(docId).update({
            description: itemDescription,
            price: itemPrice,
            stock: itemStock,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });
          showMessage(`Shop item "${itemName}" updated successfully!`, 'success');
        } else {
          // Add new item
          await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shopItems').add({
            name: itemName,
            description: itemDescription,
            price: itemPrice,
            stock: itemStock,
            imageUrl: `https://placehold.co/100/1a1a1a/e0f7ff?text=${encodeURIComponent(itemName.split(' ')[0])}`, // Placeholder image
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          showMessage(`Shop item "${itemName}" added successfully!`, 'success');
        }
        addShopItemForm.reset();
        fetchShopItems(); // Refresh shop display
      } catch (error) {
        console.error("Error adding/updating shop item:", error.message);
        showMessage(`Failed to add/update shop item: ${error.message}`, 'error');
      }
    });

    // Fetch Shop Items
    function fetchShopItems() {
      db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shopItems').orderBy('name')
        .onSnapshot(snapshot => {
          renderShopItems(snapshot.docs);
        }, error => {
          console.error("Error fetching shop items:", error.message);
          // showMessage(`Failed to load shop items: ${error.message}`, 'error');
        });
    }

    // Render Shop Items
    function renderShopItems(docs) {
      shopItemsContainer.innerHTML = '';
      if (docs.length === 0) {
        shopItemsContainer.innerHTML = '<p style="text-align: center; width: 100%; color: var(--text-secondary);">No items in the shop yet. Check back later!</p>';
        return;
      }

      docs.forEach(doc => {
        const item = doc.data();
        const itemId = doc.id;
        const shopCard = document.createElement('div');
        shopCard.classList.add('shop-item-card');

        const isOutOfStock = item.stock <= 0;
        const canBuy = currentUser && currentUser.emailVerified && currentUser.realmCoins >= item.price && !isOutOfStock;

        shopCard.innerHTML = `
          <img src="${item.imageUrl}" alt="${item.name}" onerror="this.onerror=null;this.src='https://placehold.co/100/1a1a1a/e0f7ff?text=Item';"/>
          <h3>${item.name}</h3>
          <p>${item.description}</p>
          <div class="price-stock">
            <span class="price"><i class="fas fa-diamond realm-coin-icon"></i> ${item.price.toLocaleString()}</span>
            <span class="stock">Stock: ${item.stock}</span>
          </div>
          <button class="buy-item-button" data-item-id="${itemId}" ${!canBuy ? 'disabled' : ''}>
            ${isOutOfStock ? 'Out of Stock' : (canBuy ? 'Buy Now' : 'Requires Login/Coins')}
          </button>
          ${isAdmin ? `<button class="delete-button danger-button" data-id="${itemId}" data-type="shopItem" style="position: static; margin-top: 10px;">Delete Item</button>` : ''}
        `;
        shopItemsContainer.appendChild(shopCard);
      });

      shopItemsContainer.querySelectorAll('.buy-item-button').forEach(button => {
        button.addEventListener('click', (e) => {
          const itemId = e.target.dataset.itemId;
          buyShopItem(itemId);
        });
      });

      if (isAdmin) {
        shopItemsContainer.querySelectorAll('.delete-button[data-type="shopItem"]').forEach(button => {
          button.addEventListener('click', (e) => {
            const docId = e.target.dataset.id;
            deleteContent('shopItem', docId);
          });
        });
      }
    }

    // Buy Shop Item (Uses Firestore Transaction)
    async function buyShopItem(itemId) {
      if (!currentUser || !currentUser.emailVerified) {
        showMessage("Please login and verify your email to buy items.", "error");
        return;
      }

      const itemRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shopItems').doc(itemId);
      const userCurrencyRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('currency').doc('data');

      try {
        await db.runTransaction(async (transaction) => {
          const itemDoc = await transaction.get(itemRef);
          const userCurrencyDoc = await transaction.get(userCurrencyRef);

          if (!itemDoc.exists) {
            throw new Error("Item not found.");
          }
          if (!userCurrencyDoc.exists) {
            throw new Error("Your currency data not found. Please try logging in again.");
          }

          const itemData = itemDoc.data();
          const userData = userCurrencyDoc.data();

          const currentStock = itemData.stock || 0;
          const itemPrice = itemData.price || 0;
          const userCoins = userData.realmCoins || 0;

          if (currentStock <= 0) {
            throw new Error(`"${itemData.name}" is out of stock.`);
          }
          if (userCoins < itemPrice) {
            throw new Error(`Not enough Realm Coins to buy "${itemData.name}". You need ${itemPrice.toLocaleString()} coins.`);
          }

          // Perform the purchase
          transaction.update(itemRef, {
            stock: currentStock - 1
          });
          transaction.update(userCurrencyRef, {
            realmCoins: userCoins - itemPrice
          });

          showMessage(`Successfully purchased "${itemData.name}" for ${itemPrice.toLocaleString()} Realm Coins!`, 'success');
        });
      } catch (error) {
        console.error("Buy Item Error:", error.message);
        showMessage(`Purchase failed: ${error.message}`, 'error');
      } finally {
        fetchShopItems(); // Refresh shop display
        fetchUserProfile(currentUser.uid); // Refresh user coins in header/profile
      }
    }


    // --- Canvas Background Logic ---
    let canvas, ctx, w, h;
    let particles = [];
    const particleCount = 100;
    const maxRadius = 3;
    const minRadius = 1;
    const maxSpeed = 0.5;

    function initCanvasBackground() {
      canvas = document.getElementById("backgroundCanvas");
      // NEW SAFETY NET: Check if canvas element exists before proceeding
      if (!canvas) {
        console.warn("Background canvas element not found. Canvas background will not be rendered.");
        return;
      }
      ctx = canvas.getContext("2d");
      resizeResetCanvas();
      createParticles();
      animateParticles();
    }

    function resizeResetCanvas() {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
      ctx.fillStyle = "#000"; // Ensure clear background
      ctx.fillRect(0, 0, w, h);
    }

    class Particle {
      constructor(x, y) {
        this.x = x;
        this.y = y;
        this.radius = Math.random() * (maxRadius - minRadius) + minRadius;
        this.color = `rgba(0, ${Math.floor(Math.random() * 100) + 155}, ${Math.floor(Math.random() * 200) + 55}, ${Math.random() * 0.5 + 0.3})`;
        this.vx = (Math.random() - 0.5) * maxSpeed;
        this.vy = (Math.random() - 0.5) * maxSpeed;
      }

      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
        ctx.fillStyle = this.color;
        ctx.fill();
      }

      update() {
        this.x += this.vx;
        this.y += this.vy;

        if (this.x - this.radius < 0 || this.x + this.radius > w) {
          this.vx *= -1;
        }
        if (this.y - this.radius < 0 || this.y + this.radius > h) {
          this.vy *= -1;
        }

        this.draw();
      }
    }

    function createParticles() {
      for (let i = 0; i < particleCount; i++) {
        particles.push(new Particle(Math.random() * w, Math.random() * h));
      }
    }

    function animateParticles() {
      requestAnimationFrame(animateParticles);
      ctx.clearRect(0, 0, w, h); // Clear frame
      ctx.fillStyle = "rgba(10, 10, 10, 0.5)"; // Semi-transparent overlay to create trails
      ctx.fillRect(0, 0, w, h);

      for (let i = 0; i < particles.length; i++) {
        particles[i].update();
      }
    }

    // --- Event Listeners and Initial Calls ---

    // Navigation Toggle for mobile (and desktop now)
    navToggle.addEventListener('click', () => {
      navMenu.classList.toggle('active');
      navToggle.classList.toggle('active'); // Toggle hamburger icon to 'X'
    });

    // Handle navigation clicks
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        if (link.id === 'logout-button') return; // Handled separately
        e.preventDefault();
        const sectionId = link.getAttribute('href').substring(1);
        displaySection(sectionId);
      });
    });

    // Redirect to homepage when Shinigami Realm title is clicked
    shinigamiRealmLogo.addEventListener('click', () => {
      displaySection('home-section');
    });

    // Clear search buttons logic
    document.querySelectorAll('.clear-search-button').forEach(button => {
      button.addEventListener('click', (e) => {
        const targetInputId = e.target.dataset.targetInput;
        const targetInput = document.getElementById(targetInputId);
        targetInput.value = '';
        // Hide the clear button itself
        e.target.style.display = 'none';
        // Hide search results if any
        if (targetInputId === 'header-user-search-input') {
          headerUserSearchResults.classList.remove('active');
        } else if (targetInputId === 'fruit-search') {
          renderFruits(''); // Re-render all fruits
        } else if (targetInputId === 'user-search-input-main') {
          userSearchResultsMain.innerHTML = ''; // Clear main chat search results
        }
      });
    });

    // Logout button
    logoutButton.addEventListener('click', async () => {
      try {
        await auth.signOut();
        showMessage('Logged out successfully!', 'success');
        // UI updates handled by onAuthStateChanged
      } catch (error) {
        console.error("Logout Error:", error.message);
        showMessage(`Logout failed: ${error.message}`, 'error');
      }
    });

    // Initialize canvas background on window load
    window.onload = function() {
      initCanvasBackground();
      // Initial display based on auth state (handled by onAuthStateChanged)
    };

    // Handle window resize for canvas
    window.addEventListener('resize', resizeResetCanvas);

    // Initial call to update UI based on current auth state
    // This will trigger fetchUserProfile, fetchChangelogs, etc.
    // The onAuthStateChanged listener handles the initial displaySection('auth-section') or 'home-section'
  </script>
</body>

</html>
