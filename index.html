<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shinigami Realm</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <style>
    :root {
      --primary: #00ccff;
      --primary-dark: #0099cc;
      --secondary: #00ff88;
      --background: #0a0a0a;
      --card-bg: #1a1a1a;
      --text: #e0f7ff;
      --text-secondary: #b0b0b0;
      --border: rgba(0, 204, 255, 0.3);
      --mythical: #ff00ff;
      --legendary: #ffaa00;
      --rare: #5555ff;
      --uncommon: #55ff55;
      --common: #e0f7ff;
      --error: #ff4d4d;
      --claim-ready: #00ff88;
      /* Bright green for claim button */
      --claim-ready-shadow: rgba(0, 255, 136, 0.5);
      --warning: #ffcc00;
      --accept-color: #28a745;
      --decline-color: #dc3545;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      background: linear-gradient(to bottom, var(--background) 0%, var(--background) 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      overflow-x: hidden;
    }

    #backgroundCanvas {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background-color: #000;
    }

    /* The intro-overlay is now removed as per user request */
    /*
    .intro-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 2000;
      transition: opacity 1s ease;
      color: var(--primary);
      text-align: center;
      padding: 1rem;
    }

    .intro-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .welcome-text {
      font-size: 1.8rem;
      margin-bottom: 2rem;
      font-weight: 600;
      user-select: none;
    }

    .intro-button {
      background-color: var(--primary);
      color: #000;
      border: none;
      padding: 1rem 2rem;
      font-size: 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.5);
    }

    .intro-button:hover {
      background-color: var(--primary-dark);
      transform: scale(1.05);
    }
    */

    nav {
      background-color: #101820;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      box-shadow: 0 4px 10px rgba(0, 204, 255, 0.3);
      position: sticky;
      top: 0;
      z-index: 1000;
      user-select: none;
      flex-wrap: wrap;
    }

    nav .title {
      font-weight: 700;
      font-size: 1.5rem;
      color: var(--primary);
      user-select: text;
      cursor: pointer;
    }

    nav .hamburger {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 30px;
      height: 24px;
      cursor: pointer;
      position: relative;
      z-index: 1500;
      filter: drop-shadow(0 2px 2px rgba(0, 204, 255, 0.6));
      transition: filter 0.3s ease;
    }

    nav .hamburger:hover {
      filter: drop-shadow(0 4px 4px rgba(0, 204, 255, 0.8));
    }

    nav .hamburger span {
      display: block;
      height: 4px;
      background-color: var(--primary);
      border-radius: 3px;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s, opacity 0.3s;
      box-shadow:
        0 0 6px var(--primary),
        0 0 12px var(--primary),
        0 0 18px var(--primary);
      will-change: transform;
    }

    nav .hamburger span:not(:last-child) {
      margin-bottom: 6px;
    }

    nav .hamburger.active span:nth-child(1) {
      transform: translateY(10px) rotate(45deg);
      background-color: var(--primary-dark);
      box-shadow:
        0 0 10px var(--primary-dark),
        0 0 20px var(--primary-dark);
    }

    nav .hamburger.active span:nth-child(2) {
      opacity: 0;
      transform: scaleX(0);
    }

    nav .hamburger.active span:nth-child(3) {
      transform: translateY(-10px) rotate(-45deg);
      background-color: var(--primary-dark);
      box-shadow:
        0 0 10px var(--primary-dark),
        0 0 20px var(--primary-dark);
    }

    /* Navigation content container - always vertical, hidden by default */
    nav .nav-content {
      width: 100%;
      margin-top: 0.5rem;
      display: none;
      /* Hidden by default */
      flex-direction: column;
      align-items: center;
      border-top: 1px solid var(--primary);
      padding-top: 0.5rem;
      transition: max-height 0.5s ease, opacity 0.4s ease;
      overflow-y: auto;
      max-height: 0;
      opacity: 0;
    }

    nav .nav-content.show {
      display: flex;
      /* Display when .show is active */
      max-height: 100vh;
      /* Max height to fit all content, allows scrolling */
      opacity: 1;
    }

    /* Main navigation links */
    nav .nav-links-main {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    nav .nav-links-main a,
    nav .nav-utility button {
      color: var(--primary);
      margin: 0.5rem 0;
      text-decoration: none;
      font-size: 1.1rem;
      transition: color 0.3s, transform 0.3s;
      cursor: pointer;
      user-select: none;
      background: none;
      border: none;
      padding: 0;
      width: fit-content;
    }

    nav .nav-links-main a:hover,
    nav .nav-utility button:hover {
      color: var(--primary-dark);
      transform: scale(1.05);
    }

    nav .nav-links-main a.active {
      color: var(--text);
      font-weight: bold;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 4px;
    }

    /* Utility section (Realm Coin, Auth) */
    nav .nav-utility {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      margin-top: 1rem;
      border-top: 1px solid rgba(0, 204, 255, 0.1);
      padding-top: 1rem;
    }

    .realm-coin-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background-color: rgba(0, 204, 255, 0.1);
      border: 1px solid var(--primary);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 1rem;
      box-shadow: 0 0 10px rgba(0, 204, 255, 0.2);
      margin-bottom: 1rem;
    }

    .realm-coin-display:hover {
      background-color: rgba(0, 204, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.4);
    }

    .realm-coin-icon {
      font-size: 1.2rem;
      color: var(--secondary);
      text-shadow: 0 0 5px var(--secondary);
    }

    .realm-coin-amount {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--text);
    }

    /* Leaderboard in Nav (removed from here, now in realmCoinClaimSection) */
    /* Auth status display */
    .auth-status {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 1rem;
      text-align: center;
      width: 100%;
      word-break: break-all;
    }

    /* Desktop Styles - Hamburger always visible, nav content hidden by default */
    @media (min-width: 769px) {
      nav .hamburger {
        display: flex;
        /* Keep hamburger visible even on desktop for consistent behavior */
      }

      nav .nav-content {
        display: none;
        /* Still hidden by default on desktop */
        max-height: 100vh !important;
        /* Ensure it can expand fully */
        opacity: 1 !important;
        flex-direction: column;
        width: 100%;
        margin-top: 0.5rem;
        border-top: 1px solid var(--primary);
        padding-top: 0.5rem;
        overflow-y: auto;
      }

      nav .nav-content.show {
        display: flex;
        /* Display when .show is active */
      }

      nav .nav-links-main {
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

      nav .nav-links-main a {
        margin: 0.5rem 0;
      }

      nav .nav-utility {
        flex-direction: column;
        align-items: center;
        width: 100%;
        margin-top: 1rem;
        border-top: 1px solid rgba(0, 204, 255, 0.1);
        padding-top: 1rem;
      }

      .realm-coin-display {
        margin-top: 1rem;
        margin-bottom: 0.5rem;
      }

      nav .nav-utility button,
      nav .nav-utility .auth-status {
        margin-top: 0.5rem;
      }
    }

    main {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
      flex-grow: 1;
      width: 100%;
    }

    section {
      display: none;
      animation: fadeIn 0.5s ease-in;
    }

    section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h1 {
      color: var(--primary);
      margin-bottom: 1rem;
      text-align: center;
      text-shadow: 0 0 10px rgba(0, 204, 255, 0.3);
    }

    .bulletin-content,
    .changelog-content,
    .aboutus-content,
    .tradecalc-content,
    .bloxfruitnews-content,
    .claim-page-content,
    .shop-content,
    .giveaways-content,
    .profile-content,
    .blogs-content {
      background-color: var(--card-bg);
      padding: 1.5rem 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 204, 255, 0.1);
      line-height: 1.5;
      font-size: 1.1rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .bulletin-content:hover,
    .changelog-content:hover,
    .aboutus-content:hover,
    .tradecalc-content:hover,
    .bloxfruitnews-content:hover,
    .claim-page-content:hover,
    .shop-content:hover,
    .giveaways-content:hover,
    .profile-content:hover,
    .blogs-content:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 204, 255, 0.2);
    }

    .coming-soon {
      color: var(--primary);
      font-style: italic;
      font-weight: 600;
      font-size: 1.3rem;
      text-align: center;
      margin-top: 1rem;
    }

    footer {
      background-color: #101820;
      color: var(--primary);
      text-align: center;
      padding: 1rem 0;
      font-size: 0.9rem;
      margin-top: auto;
    }

    a.discord-link {
      color: var(--primary);
      font-weight: bold;
      text-decoration: none;
      display: block;
      margin-bottom: 0.5rem;
      transition: color 0.3s;
    }

    a.discord-link:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    /* Staff section styles */
    .staff-section {
      margin-top: 2rem;
    }

    .staff-section h2 {
      color: var(--primary);
      border-bottom: 1px solid var(--primary);
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }

    .staff-list {
      margin-top: 1rem;
    }

    .staff-list p {
      margin-bottom: 0.5rem;
    }

    .staff-list strong {
      color: var(--primary);
    }

    /* === ENHANCED TRADE CALCULATOR STYLES === */
    .calculator-header {
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
    }

    .calculator-header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
      max-width: 700px;
      margin: 0 auto;
    }

    .search-container {
      padding: 1.5rem;
      background: rgba(10, 10, 10, 0.7);
      backdrop-filter: blur(5px);
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid var(--border);
    }

    .search-wrapper {
      position: relative;
      max-width: 500px;
      margin: 0 auto;
    }

    #fruitSearch {
      width: 100%;
      padding: 1rem 1rem 1rem 3rem;
      background: rgba(20, 20, 20, 0.8);
      border: 1px solid var(--primary);
      color: var(--text);
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.1);
    }

    #fruitSearch:focus {
      outline: none;
      border-color: var(--primary-dark);
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.3);
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      font-size: 1.2rem;
    }

    .fruit-table-container {
      max-height: 60vh;
      overflow-y: auto;
      padding: 0 1.5rem;
    }

    .fruit-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }

    .fruit-table thead th {
      position: sticky;
      top: 0;
      background: var(--card-bg);
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--primary);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(5px);
      z-index: 5;
    }

    .fruit-table tbody tr {
      background: rgba(30, 30, 30, 0.5);
      transition: all 0.3s ease;
      border-radius: 8px;
      overflow: hidden;
    }

    .fruit-table tbody tr:hover {
      background: rgba(50, 50, 50, 0.7);
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0, 204, 255, 0.2);
    }

    .fruit-table td {
      padding: 1rem;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .fruit-table td:first-child {
      border-left: 1px solid var(--border);
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }

    .fruit-table td:last-child {
      border-right: 1px solid var(--border);
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    .rarity-mythical {
      color: var(--mythical);
    }

    .rarity-legendary {
      color: var(--legendary);
    }

    .rarity-rare {
      color: var(--rare);
    }

    .rarity-uncommon {
      color: var(--uncommon);
    }

    .rarity-common {
      color: var(--common);
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .quantity-control button {
      background: var(--primary);
      color: #000;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: bold;
    }

    .quantity-control button:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }

    .quantity-control input {
      width: 60px;
      text-align: center;
      background: rgba(20, 20, 20, 0.8);
      border: 1px solid var(--primary);
      color: var(--text);
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .quantity-control input:focus {
      outline: none;
      border-color: var(--primary-dark);
      box-shadow: 0 0 10px rgba(0, 204, 255, 0.3);
    }

    .total-display {
      background: rgba(10, 10, 10, 0.9);
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      bottom: 0;
      backdrop-filter: blur(5px);
    }

    .total-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .total-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .total-value {
      font-size: 1.5rem;
      font-weight: bold;
    }

    #totalBeli {
      color: var(--primary);
    }

    #totalValue {
      color: var(--secondary);
    }

    .reset-btn {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .reset-btn:hover {
      background: rgba(0, 204, 255, 0.1);
      transform: translateY(-2px);
    }

    /* Animations */
    @keyframes rowFadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fruit-table tbody tr {
      animation: rowFadeIn 0.3s ease forwards;
      opacity: 0;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(20, 20, 20, 0.5);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .calculator-header h1 {
        font-size: 2rem;
      }

      .total-display {
        flex-direction: column;
        gap: 1rem;
      }

      .fruit-table thead {
        display: none;
      }

      .fruit-table tbody tr {
        display: block;
        margin-bottom: 1rem;
      }

      .fruit-table td:before {
        content: attr(data-label);
        font-weight: bold;
        color: var(--primary);
        margin-right: 1rem;
      }

      .fruit-table td:first-child,
      .fruit-table td:last-child {
        border-radius: 0;
      }

      .fruit-table td:first-child {
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
      }

      .fruit-table td:last-child {
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
        border-bottom: none;
      }
    }

    /* --- Auth Form Styles --- */
    .auth-container {
      background-color: var(--card-bg);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 204, 255, 0.1);
      max-width: 400px;
      margin: 3rem auto;
      text-align: center;
      animation: fadeIn 0.5s ease-in;
    }

    .auth-container h2 {
      color: var(--primary);
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .auth-form input[type="email"],
    .auth-form input[type="password"] {
      padding: 0.8rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background-color: rgba(20, 20, 20, 0.8);
      color: var(--text);
      font-size: 1rem;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .auth-form input[type="email"]:focus,
    .auth-form input[type="password"]:focus {
      outline: none;
      border-color: var(--primary-dark);
      box-shadow: 0 0 10px rgba(0, 204, 255, 0.3);
    }

    .auth-form button {
      background-color: var(--primary);
      color: #000;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 6px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      font-weight: bold;
    }

    .auth-form button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .auth-toggle-text {
      margin-top: 1.5rem;
      color: var(--text-secondary);
    }

    .auth-toggle-text button {
      color: var(--secondary);
      background: none;
      border: none;
      text-decoration: underline;
      cursor: pointer;
      font-size: 1rem;
      transition: color 0.3s;
      padding: 0;
    }

    .message-box {
      background-color: rgba(255, 0, 0, 0.2);
      color: var(--error);
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: none;
      text-align: left;
      border: 1px solid var(--error);
    }

    .message-box.show {
      display: block;
    }

    .message-box.success {
      background-color: rgba(0, 255, 0, 0.1);
      color: var(--secondary);
      border: 1px solid var(--secondary);
    }

    .message-box.info {
      background-color: rgba(0, 204, 255, 0.1);
      color: var(--primary);
      border: 1px solid var(--primary);
    }


    /* Hide main content when not logged in */
    #mainContentWrapper.hidden {
      display: none;
    }

    /* Realm Coin Claim Page Styles */
    #realmCoinClaimSection {
      text-align: center;
      padding: 2rem;
    }

    #realmCoinClaimSection h1 {
      margin-bottom: 2rem;
    }

    .claim-page-content {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      align-items: center;
    }

    .countdown-display {
      font-size: 3rem;
      font-weight: bold;
      color: var(--primary);
      text-shadow: 0 0 15px rgba(0, 204, 255, 0.5);
      margin-bottom: 1rem;
    }

    .claim-button {
      background-color: #555;
      color: #bbb;
      border: none;
      padding: 1rem 2.5rem;
      font-size: 1.8rem;
      border-radius: 10px;
      cursor: not-allowed;
      transition: all 0.3s ease;
      font-weight: bold;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }

    .claim-button.ready {
      background-color: var(--claim-ready);
      color: #000;
      cursor: pointer;
      box-shadow: 0 0 20px var(--claim-ready-shadow), 0 0 40px var(--claim-ready-shadow);
      animation: pulse-green 1.5s infinite alternate;
    }

    .claim-button.ready:hover {
      transform: scale(1.05);
      background-color: var(--claim-ready);
      box-shadow: 0 0 25px var(--claim-ready-shadow), 0 0 50px var(--claim-ready-shadow);
    }

    .claim-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    @keyframes pulse-green {
      from {
        box-shadow: 0 0 20px var(--claim-ready-shadow), 0 0 40px var(--claim-ready-shadow);
      }
      to {
        box-shadow: 0 0 30px var(--claim-ready-shadow), 0 0 60px var(--claim-ready-shadow);
      }
    }

    .claim-status-message {
      font-size: 1.2rem;
      color: var(--text-secondary);
      margin-top: 1rem;
    }

    /* Email Verification Banner */
    .email-verification-banner {
      background-color: rgba(255, 204, 0, 0.15);
      color: var(--warning);
      padding: 1rem 1.5rem;
      margin: 1rem auto;
      border-radius: 8px;
      border: 1px solid var(--warning);
      text-align: center;
      font-size: 1.1rem;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.8rem;
      box-shadow: 0 0 15px rgba(255, 204, 0, 0.3);
    }

    .email-verification-banner p {
      margin: 0;
      line-height: 1.4;
    }

    .email-verification-banner button {
      background-color: var(--warning);
      color: #333;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: bold;
      transition: background-color 0.3s, transform 0.2s;
      margin: 0 0.5rem;
    }

    .email-verification-banner button:hover {
      background-color: #e6b800;
      transform: translateY(-2px);
    }

    /* New Home Section Styles */
    #homeSection {
      text-align: center;
      padding: 2rem;
    }

    #homeSection .main-title {
      font-size: 3.5rem;
      font-weight: 700;
      color: var(--primary);
      text-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
      margin-bottom: 2rem;
      animation: glow 2s infinite alternate;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary);
      }
      to {
        text-shadow: 0 0 20px var(--primary), 0 0 30px var(--primary-dark);
      }
    }

    #homeSection .clan-description {
      background-color: var(--card-bg);
      padding: 1.5rem 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 204, 255, 0.1);
      line-height: 1.6;
      font-size: 1.2rem;
      max-width: 800px;
      margin: 2rem auto;
      text-align: center;
    }

    .home-section-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-top: 3rem;
    }

    .home-section-card {
      background-color: var(--card-bg);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 15px rgba(0, 204, 255, 0.1);
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
      text-align: left;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .home-section-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(0, 204, 255, 0.3);
      background-color: #2a2a2a;
    }

    .home-section-card h3 {
      color: var(--secondary);
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid rgba(0, 255, 136, 0.3);
      padding-bottom: 0.5rem;
    }

    .home-section-card p {
      color: var(--text-secondary);
      font-size: 0.95rem;
      flex-grow: 1;
    }

    @media (max-width: 600px) {
      #homeSection .main-title {
        font-size: 2.5rem;
      }
      .home-section-cards-container {
        grid-template-columns: 1fr;
      }
    }

    /* Profile Section Styles */
    .profile-content {
      max-width: 700px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .profile-pfp {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary);
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.5);
      cursor: pointer;
      /* Make PFP clickable */
    }

    .profile-info h2 {
      margin: 0;
      color: var(--secondary);
      font-size: 2rem;
      cursor: pointer;
      /* Make name clickable */
    }

    .profile-info p {
      color: var(--text-secondary);
      font-size: 1rem;
      margin-top: 0.5rem;
    }

    .profile-form label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--primary);
      font-weight: bold;
    }

    .profile-form input[type="text"],
    .profile-form input[type="url"],
    .profile-form textarea {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background-color: rgba(20, 20, 20, 0.8);
      color: var(--text);
      font-size: 1rem;
      transition: border-color 0.3s, box-shadow 0.3s;
      margin-bottom: 1rem;
    }

    .profile-form input[type="text"]:focus,
    .profile-form input[type="url"]:focus,
    .profile-form textarea:focus {
      outline: none;
      border-color: var(--primary-dark);
      box-shadow: 0 0 10px rgba(0, 204, 255, 0.3);
    }

    .profile-form textarea {
      min-height: 100px;
      resize: vertical;
    }

    .profile-form button {
      background-color: var(--primary);
      color: #000;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 6px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      font-weight: bold;
    }

    .profile-form button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .friend-action-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      justify-content: center;
    }

    .friend-action-buttons button {
      padding: 0.8rem 1.5rem;
      border-radius: 6px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      font-weight: bold;
      border: none;
    }

    .friend-action-buttons .send-request-btn {
      background-color: var(--secondary);
      color: #000;
    }

    .friend-action-buttons .send-request-btn:hover {
      background-color: #00e676;
      transform: translateY(-2px);
    }

    .friend-action-buttons .pending-request-btn {
      background-color: var(--warning);
      color: #333;
      cursor: default;
    }

    .friend-action-buttons .friends-btn {
      background-color: var(--primary);
      color: #000;
      cursor: default;
    }

    .friend-section-container {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px dashed var(--border);
    }

    .friend-section-container h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      text-align: center;
    }

    .friend-list,
    .friend-requests-list {
      list-style: none;
      padding: 0;
    }

    .friend-list li,
    .friend-requests-list li {
      background-color: rgba(30, 30, 30, 0.7);
      padding: 0.8rem 1.2rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 2px 8px rgba(0, 204, 255, 0.1);
      transition: transform 0.2s ease;
    }

    .friend-list li:hover,
    .friend-requests-list li:hover {
      transform: translateX(5px);
    }

    .friend-list li img,
    .friend-requests-list li img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--secondary);
    }

    .friend-list li span,
    .friend-requests-list li span {
      flex-grow: 1;
      color: var(--text);
      font-weight: 500;
    }

    .friend-request-actions button {
      padding: 0.4rem 0.8rem;
      border-radius: 5px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background-color 0.2s;
      border: none;
      margin-left: 0.5rem;
    }

    .friend-request-actions .accept-btn {
      background-color: var(--accept-color);
      color: white;
    }

    .friend-request-actions .accept-btn:hover {
      background-color: #218838;
    }

    .friend-request-actions .decline-btn {
      background-color: var(--decline-color);
      color: white;
    }

    .friend-request-actions .decline-btn:hover {
      background-color: #c82333;
    }


    /* Blogs Section Styles */
    .blogs-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .create-blog-form {
      background-color: rgba(30, 30, 30, 0.7);
      padding: 1.5rem;
      border-radius: 10px;
      border: 1px solid rgba(0, 204, 255, 0.2);
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.1);
    }

    .create-blog-form h3 {
      color: var(--secondary);
      margin-bottom: 1rem;
      text-align: center;
    }

    .create-blog-form input[type="text"],
    .create-blog-form input[type="url"],
    .create-blog-form textarea {
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background-color: rgba(20, 20, 20, 0.8);
      color: var(--text);
      font-size: 1rem;
    }

    .create-blog-form textarea {
      min-height: 150px;
      resize: vertical;
    }

    .create-blog-form button {
      background-color: var(--primary);
      color: #000;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 6px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      font-weight: bold;
      width: 100%;
    }

    .create-blog-form button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .blog-posts-container {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .blog-post-card {
      background-color: rgba(30, 30, 30, 0.7);
      padding: 1.5rem;
      border-radius: 10px;
      border: 1px solid rgba(0, 204, 255, 0.2);
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.1);
    }

    .blog-post-card h3 {
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-size: 1.8rem;
    }

    .blog-post-card .blog-meta {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      border-bottom: 1px dashed rgba(0, 204, 255, 0.1);
      padding-bottom: 0.5rem;
    }

    .blog-post-card .blog-author-info {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      cursor: pointer;
      width: fit-content;
      /* Make clickable area smaller */
      margin-bottom: 0.5rem;
    }

    .blog-post-card .blog-author-info:hover .blog-author-name {
      color: var(--primary);
      text-decoration: underline;
    }

    .blog-post-card .blog-author-pfp {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--secondary);
    }

    .blog-post-card .blog-author-name {
      font-weight: bold;
      color: var(--secondary);
      transition: color 0.2s, text-decoration 0.2s;
    }

    .blog-post-card .blog-image {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin-top: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .blog-post-card .blog-content-text {
      color: var(--text);
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .pagination-controls {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 2rem;
    }

    .pagination-controls button {
      background-color: var(--primary);
      color: #000;
      border: none;
      padding: 0.7rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: background-color 0.3s, transform 0.2s;
    }

    .pagination-controls button:hover:not(:disabled) {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .pagination-controls button:disabled {
      background-color: #555;
      color: #bbb;
      cursor: not-allowed;
    }

    /* Admin Post/Delete Forms */
    .admin-form-container {
      background-color: rgba(30, 30, 30, 0.7);
      padding: 1.5rem;
      border-radius: 10px;
      border: 1px solid rgba(0, 204, 255, 0.2);
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.1);
      margin-bottom: 2rem;
    }

    .admin-form-container h3 {
      color: var(--secondary);
      margin-bottom: 1rem;
      text-align: center;
    }

    .admin-form-container input[type="text"],
    .admin-form-container textarea {
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background-color: rgba(20, 20, 20, 0.8);
      color: var(--text);
      font-size: 1rem;
    }

    .admin-form-container textarea {
      min-height: 100px;
      resize: vertical;
    }

    .admin-form-container button {
      background-color: var(--primary);
      color: #000;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 6px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      font-weight: bold;
      width: 100%;
    }

    .admin-form-container button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .post-item {
      background-color: rgba(30, 30, 30, 0.7);
      padding: 1.5rem;
      border-radius: 10px;
      border: 1px solid rgba(0, 204, 255, 0.2);
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.1);
      margin-bottom: 1rem;
      position: relative;
    }

    .post-item h3 {
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-size: 1.5rem;
    }

    .post-item p {
      color: var(--text);
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .post-item .delete-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: var(--error);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background-color 0.3s;
    }

    .post-item .delete-button:hover {
      background-color: #cc0000;
    }
  </style>
</head>

<body>
  <canvas id="backgroundCanvas"></canvas>

  <!--
  <div class="intro-overlay" id="intro">
    <div class="welcome-text">Welcome to The Official Website of Shinigami Realm</div>
    <button class="intro-button" id="introButton">Hop In</button>
  </div>
  -->

  <nav>
    <div class="title" id="navTitle">Shinigami Realm</div>
    <div class="hamburger" id="hamburger" aria-label="Toggle navigation menu" role="button" tabindex="0">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div class="nav-content" id="navContent">
      <div class="nav-links-main">
        <a href="#" id="homeTab" class="active">Home</a>
        <a href="#" id="bulletinTab">Bulletin</a>
        <a href="#" id="changelogTab">Changelog</a>
        <a href="#" id="aboutusTab">About Us</a>
        <a href="#" id="tradecalcTab">Trade Calculator</a>
        <a href="#" id="bloxfruitNewsTab">Blox Fruit News</a>
        <a href="#" id="shopTab">Shop</a>
        <a href="#" id="giveawaysTab">Giveaways</a>
        <a href="#" id="topPVPFighterTab">Top PVP Fighter</a>
        <a href="#" id="myProfileTab">My Profile</a>
        <a href="#" id="blogsTab">Blogs</a>
      </div>
      <div class="nav-utility">
        <div class="realm-coin-display" id="realmCoinDisplay">
          <span class="realm-coin-icon">üíé</span>
          <span class="realm-coin-amount" id="currentRealmCoins">0</span>
          <span class="realm-coin-text">Realm Coins</span>
        </div>
        <button id="authButton"></button>
        <div id="authStatus" class="auth-status"></div>
      </div>
    </div>
  </nav>

  <main id="authSection" style="display: none;">
    <div class="auth-container">
      <div id="messageBox" class="message-box"></div>
      <h2 id="authFormTitle">Login</h2>
      <form id="authForm" class="auth-form">
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit" id="authSubmitButton">Login</button>
      </form>
      <div class="auth-toggle-text">
        <span id="toggleAuthText">Don't have an account?</span>
        <button id="toggleAuthMode">Sign Up</button>
      </div>
    </div>
  </main>

  <div id="mainContentWrapper" class="hidden">
    <div id="emailVerificationBanner" class="email-verification-banner" style="display:none;">
      <p>‚ö†Ô∏è Your email address is not verified. Please check your inbox for a verification link to fully activate your
        account and ensure all features are available.</p>
      <div>
        <button id="resendVerificationEmail">Resend Verification Email</button>
        <button id="reloadUserAndCheckEmail">I've Verified My Email</button>
      </div>
    </div>

    <main>
      <section id="homeSection" class="active">
        <h1 class="main-title">Shinigami Realm</h1>
        <div class="clan-description">
          <p>Welcome, warrior, to the digital heart of Shinigami Realm! We are a dedicated and vibrant Roblox gaming
            clan, forging legends across the vast seas of Blox Fruits and cultivating vibrant gardens in Grow A Garden.
            Our realm is built on camaraderie, strategic mastery, and shared adventures. Whether you're seeking to
            dominate the Grand Line or grow the most exquisite virtual flora, you'll find your place among us. Dive
            into our community, explore our resources, and rise with the Shinigami!</p>
        </div>

        <div class="home-section-cards-container">
          <div class="home-section-card" data-target-section="bulletinSection" data-target-tab="bulletinTab">
            <h3>Bulletin</h3>
            <p>Stay updated with the latest announcements, important notices, and general news from the Shinigami Realm
              leadership.</p>
          </div>
          <div class="home-section-card" data-target-section="changelogSection" data-target-tab="changelogTab">
            <h3>Changelog</h3>
            <p>Track all the recent changes, updates, and new features implemented on the website and within our clan
              activities.</p>
          </div>
          <div class="home-section-card" data-target-section="aboutusSection" data-target-tab="aboutusTab">
            <h3>About Us</h3>
            <p>Learn more about the Shinigami Realm, our mission, our games, and meet the glorious staff who lead our
              community.</p>
          </div>
          <div class="home-section-card" data-target-section="tradecalcSection" data-target-tab="tradecalcTab">
            <h3>Trade Calculator</h3>
            <p>Utilize our specialized Blox Fruits trade calculator to ensure fair and balanced trades within the game.
              Never get scammed again!</p>
          </div>
          <div class="home-section-card" data-target-section="bloxfruitNewsSection" data-target-tab="bloxfruitNewsTab">
            <h3>Blox Fruit News</h3>
            <p>Get the freshest leaks, updates, and news related to Blox Fruits, keeping you ahead in the game.</p>
          </div>
          <div class="home-section-card" data-target-section="shopSection" data-target-tab="shopTab">
            <h3>Shop</h3>
            <p>Spend your hard-earned Realm Coins on exclusive items and rewards!</p>
          </div>
          <div class="home-section-card" data-target-section="giveawaysSection" data-target-tab="giveawaysTab">
            <h3>Giveaways</h3>
            <p>Participate in exciting giveaways for a chance to win valuable in-game items or special perks!</p>
          </div>
          <div class="home-section-card" data-target-section="topPVPFighterSection" data-target-tab="topPVPFighterTab">
            <h3>Top PVP Fighter</h3>
            <p>See the rankings of the most formidable PvP fighters in our clan. Can you climb to the top?</p>
          </div>
          <div class="home-section-card" data-target-section="realmCoinClaimSection" data-target-tab="realmCoinClaimTab">
            <h3>Realm Coins</h3>
            <p>Claim your daily Realm Coins, our exclusive website currency, by staying active on the site. Collect them
              for future rewards!</p>
          </div>
        </div>
      </section>

      <section id="bulletinSection">
        <h1>The Shinigami's Rise</h1>
        <div id="adminBulletinForm" class="admin-form-container" style="display:none;">
          <h3>Post New Bulletin</h3>
          <input type="text" id="bulletinTitleInput" placeholder="Bulletin Title" required>
          <textarea id="bulletinContentInput" placeholder="Write your bulletin content here..." required></textarea>
          <button id="submitBulletinPost">Post Bulletin</button>
        </div>
        <div id="bulletinsContainer" class="bulletin-content">
          <p class="coming-soon" id="noBulletinsMessage">No bulletins yet.</p>
        </div>
      </section>

      <section id="changelogSection">
        <h1>Changelog</h1>
        <div id="adminChangelogForm" class="admin-form-container" style="display:none;">
          <h3>Post New Changelog</h3>
          <input type="text" id="changelogTitleInput" placeholder="Changelog Title" required>
          <textarea id="changelogContentInput" placeholder="Write your changelog content here..." required></textarea>
          <button id="submitChangelogPost">Post Changelog</button>
        </div>
        <div id="changelogsContainer" class="changelog-content">
          <p class="coming-soon" id="noChangelogsMessage">No changelogs yet.</p>
        </div>
      </section>

      <section id="aboutusSection">
        <h1>About Us</h1>
        <div class="aboutus-content">
          <p>We are a Roblox clan focused on Blox Fruits and Grow a Garden games. Our community thrives on teamwork,
            creativity, and shared passion for gaming. Join us on Discord and follow our updates here! We have our own
            private server, For Blox Fruits. We have our own private server for Grow A Graden for the members to
            mingle! We have private servers accross roblox!</p>
          <a href="https://discord.gg/NgbcrWSVm5" target="_blank" rel="noopener noreferrer" class="discord-link">Join
            our Discord Server</a>

          <div class="staff-section">
            <h2>The Glorious Staff</h2>
            <div class="staff-list">
              <p><strong>Founder:</strong> mud</p>
              <p><strong>Co-Founders:</strong> aq.17d , Batman</p>
              <p><strong>Senior Staff:</strong> crash , GREED , rip_gojo</p>
              <p><strong>Moderators:</strong> Will be recruited soon....</p>
            </div>
          </div>
        </div>
      </section>

      <section id="tradecalcSection">
        <div class="calculator-header">
          <h1>Blox Fruits Trade Calculator</h1>
          <p>Calculate the value of your fruit trades with our interactive calculator. Perfect for fair trading in the
            Shinigami Realm!</p>
        </div>
        <div class="tradecalc-content">
          <div class="search-container">
            <div class="search-wrapper">
              <span class="search-icon">üîç</span>
              <input type="text" id="fruitSearch" placeholder="Search fruits..." class="search-bar">
            </div>
          </div>
          <div class="fruit-table-container">
            <table class="fruit-table">
              <thead>
                <tr>
                  <th>Fruit</th>
                  <th>Rarity</th>
                  <th>Beli Price</th>
                  <th>Trade Value</th>
                  <th>Quantity</th>
                </tr>
              </thead>
              <tbody id="fruitTable">
                <tr>
                  <td data-label="Fruit">Dragon West</td>
                  <td data-label="Rarity" class="rarity-mythical">Mythical</td>
                  <td data-label="Beli">15,000,000</td>
                  <td data-label="Value">1.2B</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="1200">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Dragon East</td>
                  <td data-label="Rarity" class="rarity-mythical">Mythical</td>
                  <td data-label="Beli">15,000,000</td>
                  <td data-label="Value">960M</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="1200">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Kitsune</td>
                  <td data-label="Rarity" class="rarity-mythical">Mythical</td>
                  <td data-label="Beli">8,000,000</td>
                  <td data-label="Value">240M</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="1000">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Yeti</td>
                  <td data-label="Rarity" class="rarity-mythical">Mythical</td>
                  <td data-label="Beli">15,000,000</td>
                  <td data-label="Value">140M</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="1200">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Leopard</td>
                  <td data-label="Rarity" class="rarity-mythical">Mythical</td>
                  <td data-label="Beli">5,000,000</td>
                  <td data-label="Value">60,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="800">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Gas</td>
                  <td data-label="Rarity" class="rarity-mythical">Mythical</td>
                  <td data-label="Beli">3,200,000</td>
                  <td data-label="Value">75,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="700">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Dough</td>
                  <td data-label="Rarity" class="rarity-mythical">Mythical</td>
                  <td data-label="Beli">2,800,000</td>
                  <td data-label="Value">30,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="700">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Spirit</td>
                  <td data-label="Rarity" class="rarity-mythical">Mythical</td>
                  <td data-label="Beli">3,400,000</td>
                  <td data-label="Value">10,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="680">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Control</td>
                  <td data-label="Rarity" class="rarity-mythical">Mythical</td>
                  <td data-label="Beli">3,200,000</td>
                  <td data-label="Value">12,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="640">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Venom</td>
                  <td data-label="Rarity" class="rarity-mythical">Mythical</td>
                  <td data-label="Beli">3,000,000</td>
                  <td data-label="Value">10,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="600">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Shadow</td>
                  <td data-label="Rarity" class="rarity-mythical">Mythical</td>
                  <td data-label="Beli">2,900,000</td>
                  <td data-label="Value">6,500,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="580">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>

                <tr>
                  <td data-label="Fruit">Blizzard</td>
                  <td data-label="Rarity" class="rarity-legendary">Legendary</td>
                  <td data-label="Beli">2,400,000</td>
                  <td data-label="Value">5,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="480">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Pain</td>
                  <td data-label="Rarity" class="rarity-legendary">Legendary</td>
                  <td data-label="Beli">2,300,000</td>
                  <td data-label="Value">2,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="460">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Rumble</td>
                  <td data-label="Rarity" class="rarity-legendary">Legendary</td>
                  <td data-label="Beli">2,100,000</td>
                  <td data-label="Value">7,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="420">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Portal</td>
                  <td data-label="Rarity" class="rarity-legendary">Legendary</td>
                  <td data-label="Beli">1,900,000</td>
                  <td data-label="Value">11,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="380">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Phoenix</td>
                  <td data-label="Rarity" class="rarity-legendary">Legendary</td>
                  <td data-label="Beli">1,800,000</td>
                  <td data-label="Value">2,800,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="360">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Sound</td>
                  <td data-label="Rarity" class="rarity-legendary">Legendary</td>
                  <td data-label="Beli">1,700,000</td>
                  <td data-label="Value">2,500,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="340">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Spider</td>
                  <td data-label="Rarity" class="rarity-legendary">Legendary</td>
                  <td data-label="Beli">1,500,000</td>
                  <td data-label="Value">1,500,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="300">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Love</td>
                  <td data-label="Rarity" class="rarity-legendary">Legendary</td>
                  <td data-label="Beli">1,800,000</td>
                  <td data-label="Value">1,500,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="260">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Buddha</td>
                  <td data-label="Rarity" class="rarity-legendary">Legendary</td>
                  <td data-label="Beli">1,800,000</td>
                  <td data-label="Value">11,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="240">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Creation</td>
                  <td data-label="Rarity" class="rarity-legendary">Legendary</td>
                  <td data-label="Beli">1,500,000</td>
                  <td data-label="Value">4,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="160">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Quake</td>
                  <td data-label="Rarity" class="rarity-legendary">Legendary</td>
                  <td data-label="Beli">1,000,000</td>
                  <td data-label="Value">1,000,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="200">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>

                <tr>
                  <td data-label="Fruit">Magma</td>
                  <td data-label="Rarity" class="rarity-rare">Rare</td>
                  <td data-label="Beli">960,000</td>
                  <td data-label="Value">1,100,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="192">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Ghost</td>
                  <td data-label="Rarity" class="rarity-rare">Rare</td>
                  <td data-label="Beli">950,000</td>
                  <td data-label="Value">800,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="190">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Rubber</td>
                  <td data-label="Rarity" class="rarity-rare">Rare</td>
                  <td data-label="Beli">750,000</td>
                  <td data-label="Value">700,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="150">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Light</td>
                  <td data-label="Rarity" class="rarity-rare">Rare</td>
                  <td data-label="Beli">650,000</td>
                  <td data-label="Value">800,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="130">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>

                <tr>
                  <td data-label="Fruit">Diamond</td>
                  <td data-label="Rarity" class="rarity-uncommon">Uncommon</td>
                  <td data-label="Beli">650,000</td>
                  <td data-label="Value">1,500,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="130">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Dark</td>
                  <td data-label="Rarity" class="rarity-uncommon">Uncommon</td>
                  <td data-label="Beli">500,000</td>
                  <td data-label="Value">400,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="100">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Sand</td>
                  <td data-label="Rarity" class="rarity-uncommon">Uncommon</td>
                  <td data-label="Beli">420,000</td>
                  <td data-label="Value">420,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="84">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Ice</td>
                  <td data-label="Rarity" class="rarity-uncommon">Uncommon</td>
                  <td data-label="Beli">350,000</td>
                  <td data-label="Value">550,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="70">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Flame</td>
                  <td data-label="Rarity" class="rarity-uncommon">Uncommon</td>
                  <td data-label="Beli">250,000</td>
                  <td data-label="Value">250,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="50">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Eagle</td>
                  <td data-label="Rarity" class="rarity-uncommon">Uncommon</td>
                  <td data-label="Beli">200,000</td>
                  <td data-label="Value">800,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="40">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>

                <tr>
                  <td data-label="Fruit">Spike</td>
                  <td data-label="Rarity" class="rarity-common">Common</td>
                  <td data-label="Beli">170,000</td>
                  <td data-label="Value">180,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="34">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Smoke</td>
                  <td data-label="Rarity" class="rarity-common">Common</td>
                  <td data-label="Beli">100,000</td>
                  <td data-label="Value">100,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="20">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Bomb</td>
                  <td data-label="Rarity" class="rarity-common">Common</td>
                  <td data-label="Beli">85,000</td>
                  <td data-label="Value">80,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="17">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Spring</td>
                  <td data-label="Rarity" class="rarity-common">Common</td>
                  <td data-label="Beli">60,000</td>
                  <td data-label="Value">60,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="12">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Chop</td>
                  <td data-label="Rarity" class="rarity-common">Common</td>
                  <td data-label="Beli">50,000</td>
                  <td data-label="Value">50,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="6">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Spin</td>
                  <td data-label="Rarity" class="rarity-common">Common</td>
                  <td data-label="Beli">7,500</td>
                  <td data-label="Value">7,500</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="1.5">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td data-label="Fruit">Rocket</td>
                  <td data-label="Rarity" class="rarity-common">Common</td>
                  <td data-label="Beli">5,000</td>
                  <td data-label="Value">5,000</td>
                  <td data-label="Quantity">
                    <div class="quantity-control">
                      <button class="decrement">-</button>
                      <input type="number" min="0" value="0" data-value="1">
                      <button class="increment">+</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="total-display">
            <div class="total-item">
              <span class="total-label">Total Beli Value</span>
              <span id="totalBeli" class="total-value">0</span>
            </div>
            <div class="total-item">
              <span class="total-label">Total Trade Value</span>
              <span id="totalValue" class="total-value">0</span>
            </div>
            <button class="reset-btn" id="resetCalculator">Reset All</button>
          </div>
        </div>
      </section>

      <section id="bloxfruitNewsSection">
        <h1>Blox Fruit News</h1>
        <div class="bloxfruitnews-content">
          <div class="coming-soon">Waiting for next leaks...</div>
        </div>
      </section>

      <section id="shopSection">
        <h1>Shinigami Shop</h1>
        <div class="shop-content">
          <div class="coming-soon">This section is currently in progress! Check back soon to spend your Realm Coins on
            awesome rewards!</div>
        </div>
      </section>
      <section id="giveawaysSection">
        <h1>Giveaways</h1>
        <div class="giveaways-content">
          <div class="coming-soon">Waiting for sauce..</div>
        </div>
      </section>
      <section id="topPVPFighterSection">
        <h1>Top PVP Fighter</h1>
        <div class="coming-soon">The next PvP Tournament is being planned. Stay tuned for details on how to participate
          and climb the ranks!</div>
      </section>

      <section id="myProfileSection">
        <h1>My Profile</h1>
        <div class="profile-content">
          <div class="profile-header">
            <img id="profilePfpDisplay" src="https://placehold.co/100x100/00ccff/000000?text=PFP" alt="Profile Picture"
              class="profile-pfp">
            <div class="profile-info">
              <h2 id="profileNameDisplay">Guest User</h2>
              <p id="profileEmailDisplay"></p>
            </div>
          </div>

          <div id="ownProfileEditForm">
            <form id="profileForm" class="profile-form">
              <label for="profileNameInput">Name:</label>
              <input type="text" id="profileNameInput" placeholder="Enter your name">

              <label for="profilePfpInput">Profile Picture URL:</label>
              <input type="url" id="profilePfpInput" placeholder="https://example.com/your-pfp.jpg">

              <label for="profileDescriptionInput">About Me:</label>
              <textarea id="profileDescriptionInput" placeholder="Tell us about yourself..."></textarea>

              <button type="submit" id="saveProfileButton">Save Profile</button>
            </form>

            <div class="friend-section-container">
              <h3>Incoming Friend Requests</h3>
              <ul id="incomingFriendRequestsList" class="friend-requests-list">
                <p class="coming-soon" id="noIncomingRequestsMessage">No incoming friend requests.</p>
              </ul>
            </div>

            <div class="friend-section-container">
              <h3>My Friends</h3>
              <ul id="myFriendsList" class="friend-list">
                <p class="coming-soon" id="noFriendsMessage">You have no friends yet.</p>
              </ul>
            </div>
          </div>

          <div id="otherUserProfileView" style="display:none;">
            <div class="profile-header">
              <img id="otherProfilePfpDisplay" src="https://placehold.co/100x100/00ccff/000000?text=PFP"
                alt="Profile Picture" class="profile-pfp">
              <div class="profile-info">
                <h2 id="otherProfileNameDisplay"></h2>
                <p id="otherProfileEmailDisplay"></p>
              </div>
            </div>
            <p id="otherProfileDescriptionDisplay" class="aboutus-content"
              style="background-color: var(--card-bg);"></p>
            <div class="friend-action-buttons">
              <button id="sendFriendRequestButton" class="send-request-btn" style="display:none;">Send Friend
                Request</button>
              <button id="pendingFriendRequestButton" class="pending-request-btn" style="display:none;" disabled>Friend
                Request Pending</button>
              <button id="alreadyFriendsButton" class="friends-btn" style="display:none;" disabled>Friends</button>
            </div>
          </div>
        </div>
      </section>

      <section id="blogsSection">
        <h1>Shinigami Blogs</h1>
        <div class="blogs-content">
          <div class="create-blog-form">
            <h3>Create New Blog Post</h3>
            <input type="text" id="blogTitleInput" placeholder="Blog Title" required>
            <input type="url" id="blogImageUrlInput" placeholder="Optional: Image URL for your blog post">
            <textarea id="blogContentInput" placeholder="Write your blog post here..." required></textarea>
            <button id="submitBlogPost">Post Blog</button>
          </div>

          <div class="blog-posts-container" id="blogPostsContainer">
            <p class="coming-soon" id="noBlogsMessage" style="display:none;">No blog posts yet. Be the first to post!
            </p>
          </div>

          <div class="pagination-controls">
            <button id="prevPageButton" disabled>Previous</button>
            <span id="currentPageDisplay">Page 1</span>
            <button id="nextPageButton" disabled>Next</button>
          </div>
        </div>
      </section>

      <section id="realmCoinClaimSection">
        <h1>Claim Your Daily Realm Coin!</h1>
        <div class="claim-page-content">
          <p>Stay on the website for 5 minutes each day to claim your Realm Coin.</p>
          <div class="countdown-display" id="countdownDisplay">05:00</div>
          <button class="claim-button" id="claimCoinButton" disabled>Claim</button>
          <p class="claim-status-message" id="claimStatusMessage"></p>

          <div class="leaderboard-container">
            <h4>Top Shinigami (Realm Coins)</h4>
            <ol class="leaderboard-list" id="leaderboardList">
              <li><span class="rank">1.</span> <span class="name">Loading...</span> <span class="coins">0</span></li>
            </ol>
          </div>
        </div>
      </section>

    </main>
  </div>

  <footer>¬© 2025 Shinigami Realm</footer>

  <script type="module">
    // Firebase imports
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      sendEmailVerification,
      reload
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      collection,
      query,
      orderBy,
      limit,
      addDoc,
      getDocs,
      startAfter,
      deleteDoc,
      onSnapshot,
      where
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase Initialization ---
    const firebaseConfig = JSON.parse(`{"apiKey":"AIzaSyDa22uXbbmUb2CWU9AEbvqb90nsLZeul4M","authDomain":"shinigami-realm-c5b79.firebaseapp.com","projectId":"shinigami-realm-c5b79","storageBucket":"shinigami-realm-c5b79.appspot.com","messagingSenderId":"540557371652","appId":"1:540557371652:web:67a3f100b1d4c2964b8851","measurementId":"G-G4YV145Q71"}`);

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const ADMIN_EMAIL = 'daiwikmjith90@gmail.com';
    let isAdmin = false;

    let currentUserId = null;
    let currentRealmCoins = 0;
    let lastClaimDate = null;
    let timeSpentToday = 0;
    const REQUIRED_TIME_FOR_CLAIM = 300;

    let dailyActivityTimer = null;
    let countdownDisplayInterval = null;
    let viewingProfileId = null; // New: To track which profile is being viewed

    // --- UI Elements ---
    // const introOverlay = document.getElementById('intro'); // Removed as per user request
    // const introButton = document.getElementById('introButton'); // Removed as per user request
    const navContent = document.getElementById('navContent');
    const hamburger = document.getElementById('hamburger');
    const authButton = document.getElementById('authButton');
    const authStatus = document.getElementById('authStatus');
    const authSection = document.getElementById('authSection');
    const mainContentWrapper = document.getElementById('mainContentWrapper');
    const authForm = document.getElementById('authForm');
    const authFormTitle = document.getElementById('authFormTitle');
    const authSubmitButton = document.getElementById('authSubmitButton');
    const toggleAuthModeButton = document.getElementById('toggleAuthMode');
    const toggleAuthText = document.getElementById('toggleAuthText');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const messageBox = document.getElementById('messageBox');

    const realmCoinDisplay = document.getElementById('realmCoinDisplay');
    const currentRealmCoinsSpan = document.getElementById('currentRealmCoins');
    const realmCoinClaimSection = document.getElementById('realmCoinClaimSection');
    const countdownDisplay = document.getElementById('countdownDisplay');
    const claimCoinButton = document.getElementById('claimCoinButton');
    const claimStatusMessage = document.getElementById('claimStatusMessage');

    const emailVerificationBanner = document.getElementById('emailVerificationBanner');
    const resendVerificationEmailBtn = document.getElementById('resendVerificationEmail');
    const reloadUserAndCheckEmailBtn = document.getElementById('reloadUserAndCheckEmail');

    const navTitle = document.getElementById('navTitle');
    const leaderboardList = document.getElementById('leaderboardList'); // Moved to realmCoinClaimSection

    // Own Profile Elements
    const profilePfpDisplay = document.getElementById('profilePfpDisplay');
    const profileNameDisplay = document.getElementById('profileNameDisplay');
    const profileEmailDisplay = document.getElementById('profileEmailDisplay');
    const profileForm = document.getElementById('profileForm');
    const profileNameInput = document.getElementById('profileNameInput');
    const profilePfpInput = document.getElementById('profilePfpInput');
    const profileDescriptionInput = document.getElementById('profileDescriptionInput');
    const saveProfileButton = document.getElementById('saveProfileButton');
    const ownProfileEditForm = document.getElementById('ownProfileEditForm'); // New: Container for own profile edit
    const incomingFriendRequestsList = document.getElementById('incomingFriendRequestsList'); // New
    const noIncomingRequestsMessage = document.getElementById('noIncomingRequestsMessage'); // New
    const myFriendsList = document.getElementById('myFriendsList'); // New
    const noFriendsMessage = document.getElementById('noFriendsMessage'); // New

    // Other User Profile Elements
    const otherUserProfileView = document.getElementById('otherUserProfileView'); // New: Container for other profiles
    const otherProfilePfpDisplay = document.getElementById('otherProfilePfpDisplay'); // New
    const otherProfileNameDisplay = document.getElementById('otherProfileNameDisplay'); // New
    const otherProfileEmailDisplay = document.getElementById('otherProfileEmailDisplay'); // New
    const otherProfileDescriptionDisplay = document.getElementById('otherProfileDescriptionDisplay'); // New
    const sendFriendRequestButton = document.getElementById('sendFriendRequestButton'); // New
    const pendingFriendRequestButton = document.getElementById('pendingFriendRequestButton'); // New
    const alreadyFriendsButton = document.getElementById('alreadyFriendsButton'); // New

    const blogTitleInput = document.getElementById('blogTitleInput');
    const blogImageUrlInput = document.getElementById('blogImageUrlInput');
    const blogContentInput = document.getElementById('blogContentInput');
    const submitBlogPostButton = document.getElementById('submitBlogPost');
    const blogPostsContainer = document.getElementById('blogPostsContainer');
    const noBlogsMessage = document.getElementById('noBlogsMessage');
    const prevPageButton = document.getElementById('prevPageButton');
    const nextPageButton = document.getElementById('nextPageButton');
    const currentPageDisplay = document.getElementById('currentPageDisplay');

    // Admin Bulletin UI Elements
    const adminBulletinForm = document.getElementById('adminBulletinForm');
    const bulletinTitleInput = document.getElementById('bulletinTitleInput');
    const bulletinContentInput = document.getElementById('bulletinContentInput');
    const submitBulletinPostButton = document.getElementById('submitBulletinPost');
    const bulletinsContainer = document.getElementById('bulletinsContainer');
    const noBulletinsMessage = document.getElementById('noBulletinsMessage');

    // Admin Changelog UI Elements
    const adminChangelogForm = document.getElementById('adminChangelogForm');
    const changelogTitleInput = document.getElementById('changelogTitleInput');
    const changelogContentInput = document.getElementById('changelogContentInput');
    const submitChangelogPostButton = document.getElementById('submitChangelogPost');
    const changelogsContainer = document.getElementById('changelogsContainer');
    const noChangelogsMessage = document.getElementById('noChangelogsMessage');


    const tabs = {
      homeTab: document.getElementById('homeTab'),
      bulletinTab: document.getElementById('bulletinTab'),
      changelogTab: document.getElementById('changelogTab'),
      aboutusTab: document.getElementById('aboutusTab'),
      tradecalcTab: document.getElementById('tradecalcTab'),
      bloxfruitNewsTab: document.getElementById('bloxfruitNewsTab'),
      shopTab: document.getElementById('shopTab'),
      giveawaysTab: document.getElementById('giveawaysTab'),
      topPVPFighterTab: document.getElementById('topPVPFighterTab'),
      myProfileTab: document.getElementById('myProfileTab'),
      blogsTab: document.getElementById('blogsTab'),
    };

    const sections = {
      homeSection: document.getElementById('homeSection'),
      bulletinSection: document.getElementById('bulletinSection'),
      changelogSection: document.getElementById('changelogSection'),
      aboutusSection: document.getElementById('aboutusSection'),
      tradecalcSection: document.getElementById('tradecalcSection'),
      bloxfruitNewsSection: document.getElementById('bloxfruitNewsSection'),
      shopSection: document.getElementById('shopSection'),
      giveawaysSection: document.getElementById('giveawaysSection'),
      topPVPFighterSection: document.getElementById('topPVPFighterTab'), // Corrected ID
      myProfileSection: document.getElementById('myProfileSection'),
      blogsSection: document.getElementById('blogsSection'),
      realmCoinClaimSection: document.getElementById('realmCoinClaimSection')
    };

    let isSignUpMode = false;

    let currentPage = 1;
    const postsPerPage = 10;
    let lastVisibleBlog = null;

    // --- Helper Functions ---
    function getTodayDateString() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function showMessage(message, type = 'error') {
      messageBox.textContent = message;
      messageBox.className = `message-box show ${type}`;
      setTimeout(() => {
        messageBox.classList.remove('show');
      }, 5000);
    }

    function switchSection(targetSectionId, targetTabId = null, profileId = null) {
      if (mainContentWrapper.classList.contains('hidden') && targetSectionId !== 'authSection') {
        showMessage('Please log in to access this content.', 'info');
        // If not logged in, always redirect to auth section
        showAuthSection(false);
        return;
      }

      Object.values(sections).forEach(s => s.classList.remove('active'));
      Object.values(tabs).forEach(t => t.classList.remove('active'));

      const targetSection = sections[targetSectionId];
      if (targetSection) {
        targetSection.classList.add('active');
      }

      const targetTab = tabs[targetTabId];
      if (targetTab) {
        targetTab.classList.add('active');
      }

      if (targetSectionId === 'myProfileSection') {
        viewingProfileId = profileId || currentUserId; // Set viewingProfileId
        fetchProfile(viewingProfileId);
      } else if (targetSectionId === 'blogsSection') {
        currentPage = 1;
        lastVisibleBlog = null;
        fetchBlogPosts(currentPage);
      } else if (targetSectionId === 'realmCoinClaimSection') {
        updateClaimPageUI();
        fetchLeaderboard(); // Fetch leaderboard when Realm Coin section is active
      } else if (targetSectionId === 'bulletinSection') {
        fetchBulletins();
      } else if (targetSectionId === 'changelogSection') {
        fetchChangelogs();
      }


      if (targetSectionId !== 'realmCoinClaimSection' && countdownDisplayInterval) {
        clearInterval(countdownDisplayInterval);
        countdownDisplayInterval = null;
      }

      if (navContent.classList.contains('show')) {
        toggleMenu();
      }
    }

    // --- Firebase Interaction Functions ---
    async function fetchUserCurrency() {
      if (!currentUserId) return;

      const currencyDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/currency/data`);
      try {
        const docSnap = await getDoc(currencyDocRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          currentRealmCoins = data.realmCoins || 0;
          lastClaimDate = data.lastClaimDate || null;
        } else {
          await setDoc(currencyDocRef, {
            realmCoins: 0,
            lastClaimDate: null
          });
          currentRealmCoins = 0;
          lastClaimDate = null;
        }
      } catch (error) {
        console.error("Error fetching/initializing user currency:", error);
        showMessage(`Error loading currency: ${error.message}`, 'error');
      }
      updateRealmCoinDisplay();
    }

    async function updateUserCurrencyInFirestore() {
      if (!currentUserId) return;

      const currencyDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/currency/data`);
      const leaderboardDocRef = doc(db, `artifacts/${appId}/public/leaderboard/${currentUserId}`);

      try {
        await updateDoc(currencyDocRef, {
          realmCoins: currentRealmCoins,
          lastClaimDate: lastClaimDate
        });

        await setDoc(leaderboardDocRef, {
          userId: currentUserId,
          email: auth.currentUser.email,
          realmCoins: currentRealmCoins,
          lastUpdated: new Date()
        }, {
          merge: true
        });
        fetchLeaderboard();
      } catch (error) {
        console.error("Error updating user currency:", error);
        showMessage(`Error saving currency: ${error.message}`, 'error');
      }
    }

    // --- Leaderboard Logic ---
    async function fetchLeaderboard() {
      const leaderboardColRef = collection(db, `artifacts/${appId}/public/leaderboard`);
      try {
        const q = query(leaderboardColRef, orderBy("realmCoins", "desc"), limit(10));
        const querySnapshot = await getDocs(q);
        const leaderboardData = [];
        querySnapshot.forEach((doc) => {
          leaderboardData.push(doc.data());
        });
        renderLeaderboard(leaderboardData);
      } catch (error) {
        console.error("Error fetching leaderboard:", error);
        leaderboardList.innerHTML = `<li><span class="name" style="color:var(--error);">Error loading leaderboard.</span></li>`;
      }
    }

    function renderLeaderboard(data) {
      leaderboardList.innerHTML = '';
      if (data.length === 0) {
        leaderboardList.innerHTML = `<li><span class="name">No entries yet.</span></li>`;
        return;
      }
      data.forEach((entry, index) => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `
          <span class="rank">${index + 1}.</span>
          <span class="name">${entry.email ? entry.email.split('@')[0] : 'Anonymous'}</span>
          <span class="coins">${entry.realmCoins}</span>
        `;
        leaderboardList.appendChild(listItem);
      });
    }

    // --- Daily Activity Timer Logic ---
    function startDailyActivityTimer() {
      if (dailyActivityTimer) {
        clearInterval(dailyActivityTimer);
      }

      const todayKey = `timeSpent_${currentUserId}_${getTodayDateString()}`;
      timeSpentToday = parseInt(localStorage.getItem(todayKey) || '0');

      dailyActivityTimer = setInterval(() => {
        if (document.visibilityState === 'visible') {
          timeSpentToday++;
          localStorage.setItem(todayKey, timeSpentToday.toString());
          if (sections.realmCoinClaimSection.classList.contains('active')) {
            updateClaimPageUI();
          }
        }
      }, 1000);
    }

    function stopDailyActivityTimer() {
      if (dailyActivityTimer) {
        clearInterval(dailyActivityTimer);
        dailyActivityTimer = null;
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (auth.currentUser) {
        if (document.visibilityState === 'visible') {
          startDailyActivityTimer();
        } else {
          stopDailyActivityTimer();
        }
      }
    });

    // --- Realm Coin Claim Page Logic ---
    function updateRealmCoinDisplay() {
      if (currentRealmCoinsSpan) {
        currentRealmCoinsSpan.textContent = currentRealmCoins;
      }
    }

    // Define handleClaimCoin function
    async function handleClaimCoin() {
      if (!auth.currentUser) {
        showMessage('Please log in to claim Realm Coins.', 'info');
        return;
      }
      if (!auth.currentUser.emailVerified) {
        showMessage('Please verify your email address to claim Realm Coins.', 'warning');
        return;
      }

      const todayDate = getTodayDateString();
      if (lastClaimDate === todayDate) {
        showMessage("You've already claimed your Realm Coin for today. Come back tomorrow!", 'info');
        return;
      }

      if (timeSpentToday < REQUIRED_TIME_FOR_CLAIM) {
        const remainingTime = REQUIRED_TIME_FOR_CLAIM - timeSpentToday;
        showMessage(`You need to spend ${formatTime(remainingTime)} more on the site to claim.`, 'warning');
        return;
      }

      try {
        currentRealmCoins += 1; // Add 1 coin
        lastClaimDate = todayDate; // Update last claim date
        await updateUserCurrencyInFirestore(); // Save to Firestore
        showMessage('Realm Coin claimed successfully! Check your balance.', 'success');
        updateClaimPageUI(); // Update UI
      } catch (error) {
        console.error("Error claiming coin:", error);
        showMessage(`Failed to claim coin: ${error.message}`, 'error');
      }
    }


    function updateClaimPageUI() {
      if (!sections.realmCoinClaimSection.classList.contains('active')) {
        if (countdownDisplayInterval) {
          clearInterval(countdownDisplayInterval);
          countdownDisplayInterval = null;
        }
        return;
      }

      const todayDate = getTodayDateString();
      const hasClaimedToday = (lastClaimDate === todayDate);
      const hasEnoughTime = (timeSpentToday >= REQUIRED_TIME_FOR_CLAIM);

      if (hasClaimedToday) {
        claimCoinButton.disabled = true;
        claimCoinButton.classList.remove('ready');
        claimCoinButton.textContent = 'Claimed!';
        claimStatusMessage.textContent = `You've claimed your coin for today. Come back tomorrow!`;
        if (countdownDisplayInterval) {
          clearInterval(countdownDisplayInterval);
          countdownDisplayInterval = null;
        }
        countdownDisplay.textContent = formatTime(0);
      } else if (hasEnoughTime) {
        claimCoinButton.disabled = false;
        claimCoinButton.classList.add('ready');
        claimCoinButton.textContent = 'Claim';
        claimStatusMessage.textContent = `You've spent ${formatTime(timeSpentToday)} on the site today. Claim your coin!`;
        if (countdownDisplayInterval) {
          clearInterval(countdownDisplayInterval);
          countdownDisplayInterval = null;
        }
        countdownDisplay.textContent = formatTime(0);
      } else {
        claimCoinButton.disabled = true;
        claimCoinButton.classList.remove('ready');
        claimCoinButton.textContent = 'Claim';
        const remainingTime = REQUIRED_TIME_FOR_CLAIM - timeSpentToday;
        claimStatusMessage.textContent = `You need to spend ${formatTime(remainingTime)} more on the site.`;

        if (!countdownDisplayInterval) {
          countdownDisplayInterval = setInterval(() => {
            if (document.visibilityState === 'visible' && sections.realmCoinClaimSection.classList.contains('active')) {
              const updatedRemainingTime = REQUIRED_TIME_FOR_CLAIM - timeSpentToday;
              if (updatedRemainingTime <= 0) {
                clearInterval(countdownDisplayInterval);
                countdownDisplayInterval = null;
                updateClaimPageUI();
              } else {
                countdownDisplay.textContent = formatTime(updatedRemainingTime);
              }
            }
          }, 1000);
        }
        countdownDisplay.textContent = formatTime(remainingTime);
      }
    }

    // Event listener for the claim button (now correctly attached)
    claimCoinButton.addEventListener('click', handleClaimCoin);

    realmCoinDisplay.addEventListener('click', () => {
      if (!auth.currentUser) {
        showMessage('Please log in to access Realm Coins.', 'info');
        return;
      }
      switchSection('realmCoinClaimSection', 'realmCoinClaimTab');
      updateClaimPageUI();
    });

    // --- Email Verification Logic ---
    async function sendVerificationEmailToUser(user) {
      if (!user) {
        showMessage('No user logged in to send verification email.', 'error');
        return;
      }
      try {
        await sendEmailVerification(user);
        showMessage('Verification email sent! Please check your inbox (and spam folder).', 'success');
      } catch (error) {
        console.error("Error sending verification email:", error);
        showMessage(`Failed to send verification email: ${error.message}`, 'error');
      }
    }

    function displayVerificationBanner(user) {
      if (user && !user.emailVerified) {
        emailVerificationBanner.style.display = 'flex';
      } else {
        emailVerificationBanner.style.display = 'none';
      }
    }

    resendVerificationEmailBtn.addEventListener('click', async () => {
      if (auth.currentUser) {
        await sendVerificationEmailToUser(auth.currentUser);
      } else {
        showMessage('You must be logged in to resend a verification email.', 'info');
      }
    });

    reloadUserAndCheckEmailBtn.addEventListener('click', async () => {
      if (auth.currentUser) {
        await auth.currentUser.reload();
        displayVerificationBanner(auth.currentUser);
        if (auth.currentUser.emailVerified) {
          showMessage('Email successfully verified!', 'success');
        } else {
          showMessage('Email still unverified. Please try again or check your spam folder.', 'warning');
        }
      } else {
        showMessage('No user logged in.', 'error');
      }
    });

    // --- Auth State Listener ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserId = user.uid;
        isAdmin = (user.email === ADMIN_EMAIL);
        authStatus.textContent = `Logged in as: ${user.email}`;
        authButton.textContent = 'Sign Out';
        authButton.onclick = handleSignOut;

        authSection.style.display = 'none';
        mainContentWrapper.classList.remove('hidden'); // Ensure main content is visible

        await user.reload();
        displayVerificationBanner(user);

        await fetchUserCurrency();
        startDailyActivityTimer();
        // Leaderboard is now fetched when realmCoinClaimSection is active

        adminBulletinForm.style.display = isAdmin ? 'block' : 'none';
        adminChangelogForm.style.display = isAdmin ? 'block' : 'none';

        // Automatically switch to home section on successful login
        switchSection('homeSection', 'homeTab');

      } else {
        currentUserId = null;
        isAdmin = false;
        currentRealmCoins = 0;
        lastClaimDate = null;
        timeSpentToday = 0;
        stopDailyActivityTimer();
        updateRealmCoinDisplay();
        displayVerificationBanner(null);

        authStatus.textContent = 'Not logged in.';
        authButton.textContent = 'Login / Sign Up';
        authButton.onclick = () => {
          showAuthSection(false);
        };

        mainContentWrapper.classList.add('hidden'); // Hide main content if not logged in
        authSection.style.display = 'block'; // Show auth section

        Object.values(sections).forEach(s => s.classList.remove('active'));
        Object.values(tabs).forEach(t => t.classList.remove('active'));

        localStorage.removeItem(`timeSpent_${currentUserId}_${getTodayDateString()}`);
        adminBulletinForm.style.display = 'none';
        adminChangelogForm.style.display = 'none';
      }
    });

    // --- Firebase Authentication Functions ---
    async function handleSignUp(event) {
      event.preventDefault();
      const email = emailInput.value;
      const password = passwordInput.value;

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await sendVerificationEmailToUser(userCredential.user);
        showMessage('Sign up successful! A verification email has been sent. Please check your inbox (and spam folder) to activate your account.', 'success');
      } catch (error) {
        console.error("Sign up error:", error.message);
        showMessage(`Sign Up Failed: ${error.message}`, 'error');
      }
    }

    async function handleLogin(event) {
      event.preventDefault();
      const email = emailInput.value;
      const password = passwordInput.value;

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        await userCredential.user.reload();
        displayVerificationBanner(userCredential.user);
        showMessage('Login successful! Welcome back.', 'success');
      } catch (error) {
        console.error("Login error:", error.message);
        showMessage(`Login Failed: ${error.message}`, 'error');
      }
    }

    async function handleSignOut() {
      try {
        await signOut(auth);
        showMessage('You have been signed out.', 'info');
      } catch (error) {
        console.error("Sign out error:", error.message);
        showMessage(`Sign Out Failed: ${error.message}`, 'error');
      }
    }

    // --- Auth Form Toggling ---
    function showAuthSection(isSignUp) {
      authSection.style.display = 'block';
      mainContentWrapper.classList.add('hidden');
      emailVerificationBanner.style.display = 'none';
      isSignUpMode = isSignUp;
      if (isSignUpMode) {
        authFormTitle.textContent = 'Sign Up';
        authSubmitButton.textContent = 'Sign Up';
        toggleAuthText.textContent = 'Already have an account?';
        toggleAuthModeButton.textContent = 'Login';
        authForm.onsubmit = handleSignUp;
      } else {
        authFormTitle.textContent = 'Login';
        authSubmitButton.textContent = 'Login';
        toggleAuthText.textContent = "Don't have an account?";
        toggleAuthModeButton.textContent = 'Sign Up';
        authForm.onsubmit = handleLogin;
      }
      messageBox.classList.remove('show');
      emailInput.value = '';
      passwordInput.value = '';
    }

    toggleAuthModeButton.addEventListener('click', () => showAuthSection(!isSignUpMode));

    // --- Initial Site Load Logic (Modified) ---
    // The intro overlay is removed, so we don't need an 'enterSite' function.
    // The onAuthStateChanged listener will now handle the initial display.
    // To make sure the initial auth state is checked immediately, we don't need to call enterSite.

    // Hamburger toggle
    function toggleMenu() {
      hamburger.classList.toggle('active');
      navContent.classList.toggle('show');
    }

    hamburger.addEventListener('click', toggleMenu);
    hamburger.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleMenu();
      }
    });

    // Main navigation tab click handler
    Object.entries(tabs).forEach(([key, tab]) => {
      tab.addEventListener('click', async e => {
        e.preventDefault();
        // Pass null for profileId when navigating from main tabs
        switchSection(key.replace('Tab', 'Section'), key, null);
      });
    });

    // Navigation title click handler (to go to home page)
    navTitle.addEventListener('click', () => {
      if (auth.currentUser) {
        switchSection('homeSection', 'homeTab', null);
      } else {
        showMessage('Please log in to access the website content.', 'info');
        showAuthSection(false); // Show login if not logged in
      }
    });

    // Home section mini-card click handlers
    document.querySelectorAll('.home-section-card').forEach(card => {
      card.addEventListener('click', () => {
        const targetSectionId = card.dataset.targetSection;
        const targetTabId = card.dataset.targetTab;
        switchSection(targetSectionId, targetTabId, null);
      });
    });

    // ===== ENHANCED TRADE CALCULATOR LOGIC =====
    function initializeTradeCalculator() {
      const fruitSearch = document.getElementById('fruitSearch');
      if (fruitSearch) {
        fruitSearch.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const rows = document.querySelectorAll('#fruitTable tr');

          rows.forEach((row, index) => {
            const fruitName = row.cells[0].textContent.toLowerCase();
            if (fruitName.includes(searchTerm)) {
              row.style.display = '';
              row.style.animation = `fadeIn 0.3s ease ${index * 0.05}s forwards`;
            } else {
              row.style.display = 'none';
            }
          });
        });
      }

      document.querySelectorAll('.quantity-control button').forEach(button => {
        button.addEventListener('click', function() {
          const input = this.parentElement.querySelector('input');
          if (this.classList.contains('increment')) {
            input.value = parseInt(input.value) + 1;
          } else if (input.value > 0) {
            input.value = parseInt(input.value) - 1;
          }
          const event = new Event('input', {
            bubbles: true
          });
          input.dispatchEvent(event);
        });
      });

      function calculateTotals() {
        let totalBeli = 0;
        let totalValue = 0;

        document.querySelectorAll('#fruitTable input').forEach(input => {
          const quantity = parseInt(input.value) || 0;
          const row = input.closest('tr');

          const beliPrice = parseFloat(row.cells[2].textContent.replace(/,/g, '')) || 0;

          let tradeText = row.cells[3].textContent.replace(/,/g, '').toUpperCase();
          let tradeValue = 0;
          if (tradeText.endsWith('B')) {
            tradeValue = parseFloat(tradeText) * 1000;
          } else if (tradeText.endsWith('M')) {
            tradeValue = parseFloat(tradeText);
          } else {
            tradeValue = parseFloat(tradeText) / 1000000;
          }

          totalValue += tradeValue * quantity;
          totalBeli += beliPrice * quantity;
        });

        if (document.getElementById('totalValue')) {
          document.getElementById('totalValue').textContent = formatValue(totalValue);
        }
        if (document.getElementById('totalBeli')) {
          document.getElementById('totalBeli').textContent = formatBeli(totalBeli);
        }
      }

      function formatValue(value) {
        if (value >= 1000) return `${(value/1000).toFixed(1)}B`;
        if (value >= 1) return `${value.toFixed(1)}M`;
        return `${(value*1000).toFixed(0)}K`;
      }

      function formatBeli(beli) {
        if (beli >= 1000000000) return `${(beli/1000000000).toFixed(1)}B`;
        if (beli >= 1000000) return `${(beli/1000000).toFixed(1)}M`;
        if (beli >= 1000) return `${(beli/1000).toFixed(1)}K`;
        return `${beli.toLocaleString()}`;
      }

      document.querySelectorAll('#fruitTable input').forEach(input => {
        input.addEventListener('input', calculateTotals);
      });

      document.getElementById('resetCalculator').addEventListener('click', function() {
        document.querySelectorAll('#fruitTable input').forEach(input => {
          input.value = 0;
        });
        calculateTotals();

        this.textContent = 'Reset!';
        setTimeout(() => {
          this.textContent = 'Reset All';
        }, 1000);
      });

      calculateTotals();

      const rows = document.querySelectorAll('#fruitTable tbody tr');
      rows.forEach((row, index) => {
        row.style.animationDelay = `${index * 0.05}s`;
      });
    }

    document.addEventListener('DOMContentLoaded', initializeTradeCalculator);

    // --- Profile Section Logic ---
    async function fetchProfile(profileUserId) {
      if (!currentUserId) {
        // If not logged in, show auth section
        showAuthSection(false);
        return;
      }

      // Determine if viewing own profile or another user's
      const isOwnProfile = (profileUserId === currentUserId);

      // Toggle visibility of profile sections
      ownProfileEditForm.style.display = isOwnProfile ? 'block' : 'none';
      otherUserProfileView.style.display = isOwnProfile ? 'none' : 'block';

      const targetProfileId = isOwnProfile ? currentUserId : profileUserId;
      const profileDocRef = doc(db, `artifacts/${appId}/users/${targetProfileId}/profile/data`);

      try {
        const docSnap = await getDoc(profileDocRef);
        let profileData = {
          name: 'Unknown User',
          pfpUrl: "https://placehold.co/100x100/00ccff/000000?text=PFP",
          description: "No description available."
        };

        if (docSnap.exists()) {
          profileData = docSnap.data();
        } else if (isOwnProfile) {
          // If own profile doesn't exist, create it with default values
          profileData.name = auth.currentUser.email.split('@')[0];
          await setDoc(profileDocRef, profileData);
        } else {
          // If other user's profile doesn't exist, use default unknown user data
          profileData.name = profileUserId; // Fallback to UID if no profile exists
        }

        // Update UI based on whether it's own profile or other's
        if (isOwnProfile) {
          profileNameDisplay.textContent = profileData.name || auth.currentUser.email.split('@')[0];
          profileEmailDisplay.textContent = auth.currentUser.email;
          profilePfpDisplay.src = profileData.pfpUrl || "https://placehold.co/100x100/00ccff/000000?text=PFP";
          profileDescriptionInput.value = profileData.description || '';
          profileNameInput.value = profileData.name || '';
          profilePfpInput.value = profileData.pfpUrl || '';
          fetchFriendRequests(); // Fetch for own profile
          fetchFriends(); // Fetch for own profile
        } else {
          otherProfileNameDisplay.textContent = profileData.name || profileUserId.substring(0, 8) + '...';
          otherProfileEmailDisplay.textContent = profileData.email || 'N/A'; // Assuming email is stored in profile
          otherProfilePfpDisplay.src = profileData.pfpUrl || "https://placehold.co/100x100/00ccff/000000?text=PFP";
          otherProfileDescriptionDisplay.textContent = profileData.description || 'No description available.';
          updateFriendActionButton(profileUserId); // Update button for other profile
        }

      } catch (error) {
        console.error("Error fetching profile:", error);
        showMessage(`Error loading profile: ${error.message}`, 'error');
      }
    }

    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUserId) {
        showMessage('Please log in to save your profile.', 'error');
        return;
      }

      const name = profileNameInput.value.trim();
      const pfpUrl = profilePfpInput.value.trim();
      const description = profileDescriptionInput.value.trim();

      const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
      try {
        await setDoc(profileDocRef, {
          name: name,
          pfpUrl: pfpUrl,
          description: description,
          email: auth.currentUser.email // Ensure email is saved with profile
        }, {
          merge: true
        });
        showMessage('Profile saved successfully!', 'success');
        fetchProfile(currentUserId); // Re-fetch to update display
      } catch (error) {
        console.error("Error saving profile:", error);
        showMessage(`Error saving profile: ${error.message}`, 'error');
      }
    });

    // --- Friend System Logic ---

    async function sendFriendRequest(targetUserId) {
      if (!currentUserId || !auth.currentUser) {
        showMessage('You must be logged in to send friend requests.', 'error');
        return;
      }
      if (targetUserId === currentUserId) {
        showMessage('You cannot send a friend request to yourself.', 'info');
        return;
      }

      // Fetch target user's profile to get their details
      const targetProfileDocRef = doc(db, `artifacts/${appId}/users/${targetUserId}/profile/data`);
      const targetProfileSnap = await getDoc(targetProfileDocRef);
      if (!targetProfileSnap.exists()) {
        showMessage('Target user profile not found.', 'error');
        return;
      }
      const targetProfileData = targetProfileSnap.data();

      // Check if request already sent or received
      const sentRequestsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/sentFriendRequests`);
      const incomingRequestsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/incomingFriendRequests`);
      const friendsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/friends`);

      const [sentSnap, incomingSnap, friendsSnap] = await Promise.all([
        getDocs(query(sentRequestsRef, where('receiverId', '==', targetUserId))),
        getDocs(query(incomingRequestsRef, where('senderId', '==', targetUserId))),
        getDocs(query(friendsRef, where('friendId', '==', targetUserId)))
      ]);

      if (!sentSnap.empty) {
        showMessage('Friend request already sent to this user.', 'info');
        return;
      }
      if (!incomingSnap.empty) {
        showMessage('This user has already sent you a friend request. Check your incoming requests!', 'info');
        return;
      }
      if (!friendsSnap.empty) {
        showMessage('You are already friends with this user.', 'info');
        return;
      }

      try {
        // Add request to target user's incoming requests
        await addDoc(collection(db, `artifacts/${appId}/users/${targetUserId}/incomingFriendRequests`), {
          senderId: currentUserId,
          senderEmail: auth.currentUser.email,
          senderName: (await getProfileData(currentUserId)).name || auth.currentUser.email.split('@')[0],
          senderPfpUrl: (await getProfileData(currentUserId)).pfpUrl || "https://placehold.co/100x100/00ccff/000000?text=PFP",
          timestamp: new Date(),
        });

        // Add to current user's sent requests for tracking
        await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/sentFriendRequests`), {
          receiverId: targetUserId,
          receiverEmail: targetProfileData.email,
          receiverName: targetProfileData.name,
          receiverPfpUrl: targetProfileData.pfpUrl,
          timestamp: new Date(),
        });

        showMessage('Friend request sent!', 'success');
        updateFriendActionButton(targetUserId); // Update button state
      } catch (error) {
        console.error("Error sending friend request:", error);
        showMessage(`Failed to send request: ${error.message}`, 'error');
      }
    }

    async function acceptFriendRequest(requestId, senderId, senderEmail, senderName, senderPfpUrl) {
      if (!currentUserId) return;

      const incomingRequestDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/incomingFriendRequests`, requestId);
      const myFriendsColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/friends`);
      const senderFriendsColRef = collection(db, `artifacts/${appId}/users/${senderId}/friends`);
      const senderSentRequestDocRef = query(collection(db, `artifacts/${appId}/users/${senderId}/sentFriendRequests`), where('receiverId', '==', currentUserId));

      try {
        // 1. Add sender to my friends list
        await addDoc(myFriendsColRef, {
          friendId: senderId,
          friendEmail: senderEmail,
          friendName: senderName,
          friendPfpUrl: senderPfpUrl,
          addedDate: new Date()
        });

        // 2. Add me to sender's friends list
        await addDoc(senderFriendsColRef, {
          friendId: currentUserId,
          friendEmail: auth.currentUser.email,
          friendName: (await getProfileData(currentUserId)).name || auth.currentUser.email.split('@')[0],
          friendPfpUrl: (await getProfileData(currentUserId)).pfpUrl || "https://placehold.co/100x100/00ccff/000000?text=PFP",
          addedDate: new Date()
        });

        // 3. Delete the incoming request from my list
        await deleteDoc(incomingRequestDocRef);

        // 4. Delete the sent request from sender's list
        const sentRequestSnap = await getDocs(senderSentRequestDocRef);
        if (!sentRequestSnap.empty) {
          sentRequestSnap.forEach(async (doc) => {
            await deleteDoc(doc.ref);
          });
        }

        showMessage('Friend request accepted!', 'success');
        fetchFriendRequests(); // Refresh my incoming requests
        fetchFriends(); // Refresh my friends list
      } catch (error) {
        console.error("Error accepting friend request:", error);
        showMessage(`Failed to accept request: ${error.message}`, 'error');
      }
    }

    async function declineFriendRequest(requestId, senderId) {
      if (!currentUserId) return;

      const incomingRequestDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/incomingFriendRequests`, requestId);
      const senderSentRequestDocRef = query(collection(db, `artifacts/${appId}/users/${senderId}/sentFriendRequests`), where('receiverId', '==', currentUserId));

      try {
        // 1. Delete the incoming request from my list
        await deleteDoc(incomingRequestDocRef);

        // 2. Delete the sent request from sender's list
        const sentRequestSnap = await getDocs(senderSentRequestDocRef);
        if (!sentRequestSnap.empty) {
          sentRequestSnap.forEach(async (doc) => {
            await deleteDoc(doc.ref);
          });
        }

        showMessage('Friend request declined.', 'info');
        fetchFriendRequests(); // Refresh my incoming requests
      } catch (error) {
        console.error("Error declining friend request:", error);
        showMessage(`Failed to decline request: ${error.message}`, 'error');
      }
    }

    async function getProfileData(userId) {
      const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
      const docSnap = await getDoc(profileDocRef);
      if (docSnap.exists()) {
        return docSnap.data();
      }
      return {
        name: 'Unknown User',
        pfpUrl: "https://placehold.co/100x100/00ccff/000000?text=PFP",
        email: 'N/A'
      };
    }

    async function updateFriendActionButton(targetUserId) {
      sendFriendRequestButton.style.display = 'none';
      pendingFriendRequestButton.style.display = 'none';
      alreadyFriendsButton.style.display = 'none';

      if (!currentUserId || targetUserId === currentUserId) {
        return; // No button if not logged in or viewing own profile
      }

      const sentRequestsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/sentFriendRequests`);
      const incomingRequestsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/incomingFriendRequests`);
      const friendsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/friends`);

      const [sentSnap, incomingSnap, friendsSnap] = await Promise.all([
        getDocs(query(sentRequestsRef, where('receiverId', '==', targetUserId))),
        getDocs(query(incomingRequestsRef, where('senderId', '==', targetUserId))),
        getDocs(query(friendsRef, where('friendId', '==', targetUserId)))
      ]);

      if (!friendsSnap.empty) {
        alreadyFriendsButton.style.display = 'block';
      } else if (!sentSnap.empty || !incomingSnap.empty) {
        pendingFriendRequestButton.style.display = 'block';
      } else {
        sendFriendRequestButton.style.display = 'block';
      }
    }

    sendFriendRequestButton.addEventListener('click', () => {
      if (viewingProfileId) {
        sendFriendRequest(viewingProfileId);
      }
    });

    function fetchFriendRequests() {
      if (!currentUserId) {
        incomingFriendRequestsList.innerHTML = '';
        noIncomingRequestsMessage.style.display = 'block';
        return;
      }

      const incomingRequestsColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/incomingFriendRequests`);
      const q = query(incomingRequestsColRef, orderBy("timestamp", "desc"));

      onSnapshot(q, (snapshot) => {
        const requests = [];
        snapshot.forEach(doc => {
          requests.push({
            id: doc.id,
            ...doc.data()
          });
        });
        renderFriendRequests(requests);
      }, (error) => {
        console.error("Error fetching incoming friend requests:", error);
        incomingFriendRequestsList.innerHTML = `<p class="coming-soon" style="color:var(--error);">Error loading requests.</p>`;
      });
    }

    function renderFriendRequests(requests) {
      incomingFriendRequestsList.innerHTML = '';
      if (requests.length === 0) {
        noIncomingRequestsMessage.style.display = 'block';
        return;
      } else {
        noIncomingRequestsMessage.style.display = 'none';
      }

      requests.forEach(request => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `
          <img src="${request.senderPfpUrl || 'https://placehold.co/40x40/00ccff/000000?text=PFP'}" alt="${request.senderName}'s PFP" class="profile-pfp">
          <span>${request.senderName || request.senderEmail.split('@')[0]} wants to be friends!</span>
          <div class="friend-request-actions">
            <button class="accept-btn" data-id="${request.id}" data-sender-id="${request.senderId}" data-sender-email="${request.senderEmail}" data-sender-name="${request.senderName}" data-sender-pfp="${request.senderPfpUrl}">Accept</button>
            <button class="decline-btn" data-id="${request.id}" data-sender-id="${request.senderId}">Decline</button>
          </div>
        `;
        incomingFriendRequestsList.appendChild(listItem);
      });

      incomingFriendRequestsList.querySelectorAll('.accept-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const {
            id,
            senderId,
            senderEmail,
            senderName,
            senderPfp
          } = e.target.dataset;
          acceptFriendRequest(id, senderId, senderEmail, senderName, senderPfp);
        });
      });

      incomingFriendRequestsList.querySelectorAll('.decline-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const {
            id,
            senderId
          } = e.target.dataset;
          declineFriendRequest(id, senderId);
        });
      });
    }

    function fetchFriends() {
      if (!currentUserId) {
        myFriendsList.innerHTML = '';
        noFriendsMessage.style.display = 'block';
        return;
      }

      const friendsColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/friends`);
      const q = query(friendsColRef, orderBy("addedDate", "desc"));

      onSnapshot(q, (snapshot) => {
        const friends = [];
        snapshot.forEach(doc => {
          friends.push({
            id: doc.id,
            ...doc.data()
          });
        });
        renderFriends(friends);
      }, (error) => {
        console.error("Error fetching friends:", error);
        myFriendsList.innerHTML = `<p class="coming-soon" style="color:var(--error);">Error loading friends.</p>`;
      });
    }

    function renderFriends(friends) {
      myFriendsList.innerHTML = '';
      if (friends.length === 0) {
        noFriendsMessage.style.display = 'block';
        return;
      } else {
        noFriendsMessage.style.display = 'none';
      }

      friends.forEach(friend => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `
          <img src="${friend.friendPfpUrl || 'https://placehold.co/40x40/00ccff/000000?text=PFP'}" alt="${friend.friendName}'s PFP">
          <span>${friend.friendName || friend.friendEmail.split('@')[0]}</span>
        `;
        myFriendsList.appendChild(listItem);
      });
    }

    // --- Blogs Section Logic ---
    const badWords = ['fuck', 'shit', 'asshole', 'bitch', 'cunt', 'damn', 'hell', 'wanker', 'bastard', 'dick', 'pussy'];

    function sanitizeContent(text) {
      let sanitizedText = text;
      badWords.forEach(word => {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        sanitizedText = sanitizedText.replace(regex, '*'.repeat(word.length));
      });
      return sanitizedText;
    }

    submitBlogPostButton.addEventListener('click', async () => {
      if (!auth.currentUser) {
        showMessage('Please log in to post a blog.', 'error');
        return;
      }
      if (!auth.currentUser.emailVerified) {
        showMessage('Please verify your email address to post a blog.', 'warning');
        return;
      }

      const title = blogTitleInput.value.trim();
      const imageUrl = blogImageUrlInput.value.trim();
      const content = blogContentInput.value.trim();

      if (!title || !content) {
        showMessage('Blog title and content cannot be empty.', 'error');
        return;
      }

      const sanitizedTitle = sanitizeContent(title);
      const sanitizedContent = sanitizeContent(content);

      // Get current user's profile data for author info
      const authorProfile = await getProfileData(currentUserId);

      const blogsColRef = collection(db, `artifacts/${appId}/public/blogs`);
      try {
        await addDoc(blogsColRef, {
          title: sanitizedTitle,
          imageUrl: imageUrl,
          content: sanitizedContent,
          authorId: currentUserId,
          authorEmail: auth.currentUser.email,
          authorName: authorProfile.name || auth.currentUser.email.split('@')[0],
          authorPfpUrl: authorProfile.pfpUrl || "https://placehold.co/100x100/00ccff/000000?text=PFP",
          timestamp: new Date(),
        });
        showMessage('Blog post published successfully!', 'success');
        blogTitleInput.value = '';
        blogImageUrlInput.value = '';
        blogContentInput.value = '';
        currentPage = 1;
        lastVisibleBlog = null;
        fetchBlogPosts(currentPage);
      } catch (error) {
        console.error("Error posting blog:", error);
        showMessage(`Failed to post blog: ${error.message}`, 'error');
      }
    });

    async function fetchBlogPosts(page) {
      const blogsColRef = collection(db, `artifacts/${appId}/public/blogs`);
      let q;

      if (page === 1) {
        q = query(blogsColRef, orderBy("timestamp", "desc"), limit(postsPerPage));
        lastVisibleBlog = null;
      } else {
        const prevPageQuery = query(blogsColRef, orderBy("timestamp", "desc"), limit((page - 1) * postsPerPage));
        const prevPageSnapshot = await getDocs(prevPageQuery);
        if (prevPageSnapshot.docs.length > 0) {
          const startAfterDoc = prevPageSnapshot.docs[prevPageSnapshot.docs.length - 1];
          q = query(blogsColRef, orderBy("timestamp", "desc"), startAfter(startAfterDoc), limit(postsPerPage));
        } else {
          q = query(blogsColRef, orderBy("timestamp", "desc"), limit(postsPerPage));
        }
      }

      try {
        const querySnapshot = await getDocs(q);
        const blogPosts = [];
        let newLastVisible = null;

        querySnapshot.forEach((docSnap) => {
          blogPosts.push({
            id: docSnap.id,
            ...docSnap.data()
          });
          newLastVisible = docSnap;
        });

        lastVisibleBlog = newLastVisible;

        renderBlogPosts(blogPosts);
        updatePaginationControls(querySnapshot.docs.length);
      } catch (error) {
        console.error("Error fetching blog posts:", error);
        showMessage(`Failed to load blogs: ${error.message}`, 'error');
        blogPostsContainer.innerHTML = `<p class="coming-soon" style="color:var(--error);">Error loading blogs.</p>`;
        noBlogsMessage.style.display = 'none';
      }
    }

    function renderBlogPosts(posts) {
      blogPostsContainer.innerHTML = '';
      if (posts.length === 0 && currentPage === 1) {
        noBlogsMessage.style.display = 'block';
        return;
      } else {
        noBlogsMessage.style.display = 'none';
      }

      posts.forEach(post => {
        const postCard = document.createElement('div');
        postCard.classList.add('blog-post-card');
        const postDate = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : 'Unknown Date';

        postCard.innerHTML = `
          <h3>${post.title}</h3>
          <div class="blog-author-info" data-author-id="${post.authorId}">
            <img src="${post.authorPfpUrl || 'https://placehold.co/40x40/00ccff/000000?text=PFP'}" alt="${post.authorName}'s PFP" class="blog-author-pfp">
            <span class="blog-author-name">${post.authorName || post.authorEmail.split('@')[0]}</span>
          </div>
          <p class="blog-meta">Posted on ${postDate}</p>
          ${post.imageUrl ? `<img src="${post.imageUrl}" alt="${post.title}" class="blog-image" onerror="this.onerror=null;this.src='https://placehold.co/400x200/cccccc/333333?text=Image+Not+Found';">` : ''}
          <p class="blog-content-text">${post.content}</p>
        `;
        blogPostsContainer.appendChild(postCard);
      });

      // Add event listeners for clickable author info
      blogPostsContainer.querySelectorAll('.blog-author-info').forEach(authorInfoDiv => {
        authorInfoDiv.addEventListener('click', (e) => {
          const authorId = e.currentTarget.dataset.authorId;
          if (authorId && currentUserId) { // Ensure user is logged in to view profiles
            switchSection('myProfileSection', 'myProfileTab', authorId);
          } else if (!currentUserId) {
            showMessage('Please log in to view user profiles.', 'info');
          }
        });
      });
    }

    async function updatePaginationControls(currentDocsCount) {
      currentPageDisplay.textContent = `Page ${currentPage}`;
      prevPageButton.disabled = (currentPage === 1);

      const blogsColRef = collection(db, `artifacts/${appId}/public/blogs`);
      let hasNextPage = false;
      if (lastVisibleBlog) {
        const nextQueryCheck = query(blogsColRef, orderBy("timestamp", "desc"), startAfter(lastVisibleBlog), limit(1));
        const nextSnapshotCheck = await getDocs(nextQueryCheck);
        hasNextPage = !nextSnapshotCheck.empty;
      } else {
        const totalDocsQuery = query(blogsColRef, orderBy("timestamp", "desc"));
        const totalDocsSnapshot = await getDocs(totalDocsQuery);
        hasNextPage = totalDocsSnapshot.docs.length > (currentPage * postsPerPage);
      }
      nextPageButton.disabled = !hasNextPage;
    }

    prevPageButton.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        fetchBlogPosts(currentPage);
      }
    });

    nextPageButton.addEventListener('click', () => {
      currentPage++;
      fetchBlogPosts(currentPage);
    });

    // --- Admin Bulletin Logic ---
    submitBulletinPostButton.addEventListener('click', async () => {
      if (!isAdmin) {
        showMessage('You do not have permission to post bulletins.', 'error');
        return;
      }
      const title = bulletinTitleInput.value.trim();
      const content = bulletinContentInput.value.trim();

      if (!title || !content) {
        showMessage('Bulletin title and content cannot be empty.', 'error');
        return;
      }

      const sanitizedTitle = sanitizeContent(title);
      const sanitizedContent = sanitizeContent(content);

      const bulletinsColRef = collection(db, `artifacts/${appId}/public/bulletins`);
      try {
        await addDoc(bulletinsColRef, {
          title: sanitizedTitle,
          content: sanitizedContent,
          authorEmail: auth.currentUser.email,
          timestamp: new Date()
        });
        showMessage('Bulletin posted successfully!', 'success');
        bulletinTitleInput.value = '';
        bulletinContentInput.value = '';
      } catch (error) {
        console.error("Error posting bulletin:", error);
        showMessage(`Failed to post bulletin: ${error.message}`, 'error');
      }
    });

    async function deleteBulletin(docId) {
      if (!isAdmin) {
        showMessage('You do not have permission to delete bulletins.', 'error');
        return;
      }
      const bulletinDocRef = doc(db, `artifacts/${appId}/public/bulletins`, docId);
      try {
        await deleteDoc(bulletinDocRef);
        showMessage('Bulletin deleted successfully!', 'success');
      } catch (error) {
        console.error("Error deleting bulletin:", error);
        showMessage(`Failed to delete bulletin: ${error.message}`, 'error');
      }
    }

    function fetchBulletins() {
      const bulletinsColRef = collection(db, `artifacts/${appId}/public/bulletins`);
      const q = query(bulletinsColRef, orderBy("timestamp", "desc"));

      onSnapshot(q, (snapshot) => {
        const bulletins = [];
        snapshot.forEach(doc => {
          bulletins.push({
            id: doc.id,
            ...doc.data()
          });
        });
        renderBulletins(bulletins);
      }, (error) => {
        console.error("Error fetching real-time bulletins:", error);
        bulletinsContainer.innerHTML = `<p class="coming-soon" style="color:var(--error);">Error loading bulletins.</p>`;
      });
    }

    function renderBulletins(bulletins) {
      bulletinsContainer.innerHTML = '';
      if (bulletins.length === 0) {
        noBulletinsMessage.style.display = 'block';
        return;
      } else {
        noBulletinsMessage.style.display = 'none';
      }

      bulletins.forEach(bulletin => {
        const bulletinItem = document.createElement('div');
        bulletinItem.classList.add('post-item');
        const postDate = bulletin.timestamp ? new Date(bulletin.timestamp.toDate()).toLocaleString() : 'Unknown Date';

        bulletinItem.innerHTML = `
          <h3>${bulletin.title}</h3>
          <p class="blog-meta">Posted by ${bulletin.authorEmail ? bulletin.authorEmail.split('@')[0] : 'Anonymous'} on ${postDate}</p>
          <p>${bulletin.content}</p>
          ${isAdmin ? `<button class="delete-button" data-id="${bulletin.id}">Delete</button>` : ''}
        `;
        bulletinsContainer.appendChild(bulletinItem);
      });

      if (isAdmin) {
        bulletinsContainer.querySelectorAll('.delete-button').forEach(button => {
          button.addEventListener('click', (e) => {
            const docId = e.target.dataset.id;
            deleteBulletin(docId);
          });
        });
      }
    }

    // --- Admin Changelog Logic ---
    submitChangelogPostButton.addEventListener('click', async () => {
      if (!isAdmin) {
        showMessage('You do not have permission to post changelogs.', 'error');
        return;
      }
      const title = changelogTitleInput.value.trim();
      const content = changelogContentInput.value.trim();

      if (!title || !content) {
        showMessage('Changelog title and content cannot be empty.', 'error');
        return;
      }

      const sanitizedTitle = sanitizeContent(title);
      const sanitizedContent = sanitizeContent(content);

      const changelogsColRef = collection(db, `artifacts/${appId}/public/changelogs`);
      try {
        await addDoc(changelogsColRef, {
          title: sanitizedTitle,
          content: sanitizedContent,
          authorEmail: auth.currentUser.email,
          timestamp: new Date()
        });
        showMessage('Changelog posted successfully!', 'success');
        changelogTitleInput.value = '';
        changelogContentInput.value = '';
      } catch (error) {
        console.error("Error posting changelog:", error);
        showMessage(`Failed to post changelog: ${error.message}`, 'error');
      }
    });

    async function deleteChangelog(docId) {
      if (!isAdmin) {
        showMessage('You do not have permission to delete changelogs.', 'error');
        return;
      }
      const changelogDocRef = doc(db, `artifacts/${appId}/public/changelogs`, docId);
      try {
        await deleteDoc(changelogDocRef);
        showMessage('Changelog deleted successfully!', 'success');
      } catch (error) {
        console.error("Error deleting changelog:", error);
        showMessage(`Failed to delete changelog: ${error.message}`, 'error');
      }
    }

    function fetchChangelogs() {
      const changelogsColRef = collection(db, `artifacts/${appId}/public/changelogs`);
      const q = query(changelogsColRef, orderBy("timestamp", "desc"));

      onSnapshot(q, (snapshot) => {
        const changelogs = [];
        snapshot.forEach(doc => {
          changelogs.push({
            id: doc.id,
            ...doc.data()
          });
        });
        renderChangelogs(changelogs);
      }, (error) => {
        console.error("Error fetching real-time changelogs:", error);
        changelogsContainer.innerHTML = `<p class="coming-soon" style="color:var(--error);">Error loading changelogs.</p>`;
      });
    }

    function renderChangelogs(changelogs) {
      changelogsContainer.innerHTML = '';
      if (changelogs.length === 0) {
        noChangelogsMessage.style.display = 'block';
        return;
      } else {
        noChangelogsMessage.style.display = 'none';
      }

      changelogs.forEach(changelog => {
        const changelogItem = document.createElement('div');
        changelogItem.classList.add('post-item');
        const postDate = changelog.timestamp ? new Date(changelog.timestamp.toDate()).toLocaleString() : 'Unknown Date';

        changelogItem.innerHTML = `
          <h3>${changelog.title}</h3>
          <p class="blog-meta">Posted by ${changelog.authorEmail ? changelog.authorEmail.split('@')[0] : 'Anonymous'} on ${postDate}</p>
          <p>${changelog.content}</p>
          ${isAdmin ? `<button class="delete-button" data-id="${changelog.id}">Delete</button>` : ''}
        `;
        changelogsContainer.appendChild(changelogItem);
      });

      if (isAdmin) {
        changelogsContainer.querySelectorAll('.delete-button').forEach(button => {
          button.addEventListener('click', (e) => {
            const docId = e.target.dataset.id;
            deleteChangelog(docId);
          });
        });
      }
    }

    // --- Canvas Background Logic ---
    let canvas, ctx, w, h;

    function initCanvasBackground() {
      canvas = document.getElementById("backgroundCanvas");
      ctx = canvas.getContext("2d");
      resizeResetCanvas();
    }

    function resizeResetCanvas() {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, w, h);
    }

    window.addEventListener("DOMContentLoaded", initCanvasBackground);
    window.addEventListener("resize", resizeResetCanvas);
  </script>
</body>

</html>
