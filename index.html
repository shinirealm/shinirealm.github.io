<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shinigami Realm</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <style>
    /* --- CSS Variables for Theming --- */
    :root {
      --primary: #00ccff;
      /* Bright Cyan */
      --primary-dark: #0099cc;
      /* Darker Cyan */
      --secondary: #00ff88;
      /* Vibrant Green */
      --secondary-dark: #00e676;
      /* Darker Vibrant Green */
      --background: #0a0a0a;
      /* Deep Dark Background */
      --card-bg: #1a1a1a;
      /* Slightly Lighter Dark for Cards */
      --text: #e0f7ff;
      /* Light Blue-White for Primary Text */
      --text-secondary: #b0b0b0;
      /* Grey for Secondary Text */
      --border: rgba(0, 204, 255, 0.3);
      /* Semi-transparent Primary Border */
      --mythical: #ff00ff;
      /* Magenta for Mythical Rarity */
      --legendary: #ffaa00;
      /* Orange for Legendary Rarity */
      --rare: #5555ff;
      /* Blue for Rare Rarity */
      --uncommon: #55ff55;
      /* Green for Uncommon Rarity */
      --common: #e0f7ff;
      /* Light Blue-White for Common Rarity */
      --error: #ff4d4d;
      /* Red for Error Messages */
      --claim-ready: #00ff88;
      /* Bright Green for Claim Button */
      --claim-ready-shadow: rgba(0, 255, 136, 0.5);
      /* Green Shadow for Claim Button */
      --warning: #ffcc00;
      /* Yellow for Warning Messages */
      --accept-color: #28a745;
      /* Dark Green for Accept Button */
      --decline-color: #dc3545;
      /* Dark Red for Decline Button */
      --success-msg-bg: rgba(0, 255, 136, 0.2);
      /* Light Green for Success Message Background */
      --error-msg-bg: rgba(255, 77, 77, 0.2);
      /* Light Red for Error Message Background */
      --info-msg-bg: rgba(0, 204, 255, 0.2);
      /* Light Cyan for Info Message Background */
    }

    /* --- Global Styles --- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }

    body {
      background: linear-gradient(to bottom, var(--background) 0%, #050505 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      overflow-x: hidden;
      line-height: 1.6;
      /* Add padding-bottom to prevent fixed bar from overlapping footer */
      padding-bottom: 70px;
      /* Adjust this value if the total-display height changes significantly */
    }

    /* --- Canvas Background --- */
    #backgroundCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.2;
      /* Subtler background */
      background-color: #000;
      /* Fallback */
    }

    /* --- Header & Navigation --- */
    header {
      background-color: var(--card-bg);
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: flex-start;
      /* Align items to the start */
      align-items: center;
      flex-wrap: wrap;
      position: relative;
      z-index: 10;
      box-shadow: 0 4px 20px rgba(0, 204, 255, 0.4);
      /* Stronger shadow */
    }

    .logo {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
      text-shadow: 0 0 8px var(--primary), 0 0 15px rgba(0, 204, 255, 0.6);
      text-decoration: none;
      transition: text-shadow 0.3s ease;
      cursor: pointer;
      /* Added for redirect */
    }

    .logo:hover {
      text-shadow: 0 0 10px var(--primary), 0 0 20px rgba(0, 204, 255, 0.8);
    }

    /* Realm Coin Display in Header (Left Side) */
    .realm-coin-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background-color: rgba(0, 255, 136, 0.1);
      border: 1px solid var(--secondary);
      border-radius: 20px;
      padding: 0.4rem 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
      margin-left: 1.5rem;
      /* Space from logo */
    }

    .realm-coin-display:hover {
      background-color: rgba(0, 255, 136, 0.2);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
    }

    .realm-coin-icon {
      font-size: 1.2rem;
      color: var(--secondary);
      text-shadow: 0 0 5px var(--secondary);
    }

    .realm-coin-amount {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--text);
    }

    /* Spacer to push hamburger to the right */
    .header-spacer {
      flex-grow: 1;
    }

    /* Hamburger Icon */
    .nav-toggle {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 30px;
      height: 24px;
      /* Adjusted height for 3 bars */
      background: none;
      border: none;
      cursor: pointer;
      z-index: 11;
      transition: transform 0.3s ease;
      padding: 0;
      /* Ensure no padding affects height */
    }

    .nav-toggle span {
      display: block;
      height: 4px;
      /* Height of each bar */
      background-color: var(--primary);
      border-radius: 3px;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
      box-shadow: 0 0 6px var(--primary);
      width: 100%;
      /* Ensure bars take full width */
    }

    .nav-toggle.active span:nth-child(1) {
      transform: translateY(10px) rotate(45deg);
      /* Move down and rotate */
    }

    .nav-toggle.active span:nth-child(2) {
      opacity: 0;
      /* Hide middle bar */
    }

    .nav-toggle.active span:nth-child(3) {
      transform: translateY(-10px) rotate(-45deg);
      /* Move up and rotate */
    }

    /* Navigation Content (Vertical List) */
    nav {
      display: none;
      /* Hidden by default */
      flex-direction: column;
      position: absolute;
      top: 100%;
      /* Position below header */
      right: 0;
      /* Align to the right */
      width: 100%;
      /* Full width on mobile */
      max-width: 300px;
      /* Max width for desktop dropdown */
      background-color: var(--card-bg);
      border-top: 1px solid var(--border);
      box-shadow: 0 8px 20px rgba(0, 204, 255, 0.3);
      animation: slideDown 0.3s ease-out forwards;
      padding: 1.5rem 2rem;
      gap: 1rem;
      /* Space between nav items */
    }

    nav.active {
      display: flex;
      /* Show when active */
    }

    nav ul {
      list-style: none;
      display: flex;
      flex-direction: column;
      /* Always vertical */
      gap: 1rem;
      width: 100%;
      align-items: flex-start;
      /* Align links to the left */
    }

    nav a {
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease, text-shadow 0.3s ease, transform 0.2s ease;
      padding: 0.6rem 0;
      white-space: nowrap;
      position: relative;
      width: 100%;
      /* Make links take full width for better click area */
      text-align: left;
      /* Align text to left */
    }

    nav a:hover,
    nav a.active {
      color: var(--primary);
      text-shadow: 0 0 6px var(--primary);
      transform: translateY(-2px);
    }

    nav a.active::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 2px;
      background-color: var(--primary);
      box-shadow: 0 0 8px var(--primary);
      animation: underlineGrow 0.3s forwards;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes underlineGrow {
      from {
        transform: scaleX(0);
      }
      to {
        transform: scaleX(1);
      }
    }

    /* Auth Status & Buttons within Nav (Hamburger Menu) */
    .nav-utility-items {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(0, 204, 255, 0.1);
      align-items: flex-start;
      /* Align to left */
    }

    .auth-status {
      color: var(--text-secondary);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      /* Ensure it doesn't overflow */
      text-align: left;
    }

    .nav-utility-items button {
      background-color: var(--primary);
      color: var(--background);
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 6px 15px rgba(0, 204, 255, 0.4);
      text-decoration: none;
      display: inline-block;
      text-align: center;
      letter-spacing: 0.5px;
      width: auto;
      /* Allow buttons to size naturally */
    }

    .nav-utility-items button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0, 204, 255, 0.6);
    }


    /* --- Main Content Area --- */
    main {
      flex-grow: 1;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    section {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      /* More rounded corners */
      padding: 2.5rem;
      /* More padding */
      margin-bottom: 2.5rem;
      /* More margin */
      box-shadow: 0 8px 25px rgba(0, 204, 255, 0.2);
      /* Stronger shadow */
      animation: fadeIn 0.6s ease-out;
      display: none;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      /* Add transition for hover */
    }

    section:hover {
      transform: translateY(-5px);
      /* Lift on hover */
      box-shadow: 0 12px 35px rgba(0, 204, 255, 0.3);
      /* Enhance shadow on hover */
    }

    section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h1,
    h2,
    h3 {
      color: var(--primary);
      margin-bottom: 1.2rem;
      text-shadow: 0 0 8px rgba(0, 204, 255, 0.4);
      font-weight: 700;
    }

    h1 {
      font-size: 2.8rem;
    }

    h2 {
      font-size: 2rem;
    }

    h3 {
      font-size: 1.6rem;
    }

    p {
      line-height: 1.8;
      margin-bottom: 1.2rem;
      color: var(--text);
    }

    /* --- Buttons --- */
    .button,
    button {
      background-color: var(--primary);
      color: var(--background);
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      /* More rounded */
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 6px 15px rgba(0, 204, 255, 0.4);
      /* Stronger shadow */
      text-decoration: none;
      display: inline-block;
      text-align: center;
      letter-spacing: 0.5px;
    }

    .button:hover,
    button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-3px);
      /* More lift */
      box-shadow: 0 10px 25px rgba(0, 204, 255, 0.6);
      /* Stronger hover shadow */
    }

    .button:active,
    button:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(0, 204, 255, 0.3);
    }

    .secondary-button {
      background-color: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
      box-shadow: none;
      /* Remove default shadow */
    }

    .secondary-button:hover {
      background-color: rgba(0, 204, 255, 0.1);
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.4);
      /* Add subtle glow on hover */
    }

    .danger-button {
      background-color: var(--decline-color);
      box-shadow: 0 6px 15px rgba(220, 53, 69, 0.4);
    }

    .danger-button:hover {
      background-color: #c82333;
      box-shadow: 0 10px 25px rgba(220, 53, 69, 0.6);
    }

    /* --- Forms & Inputs --- */
    form {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      /* More space between fields */
      margin-top: 1.8rem;
    }

    form label {
      font-weight: bold;
      color: var(--primary);
      font-size: 1.05rem;
    }

    form input[type="text"],
    form input[type="email"],
    form input[type="password"],
    form input[type="number"],
    form input[type="url"],
    form textarea {
      background-color: rgba(26, 26, 26, 0.8);
      /* Slightly transparent card-bg */
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.9rem;
      color: var(--text);
      font-size: 1rem;
      width: 100%;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    form input[type="text"]:focus,
    form input[type="email"]:focus,
    form input[type="password"]:focus,
    form input[type="number"]:focus,
    form input[type="url"]:focus,
    form textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 12px rgba(0, 204, 255, 0.6);
    }

    #auth-section {
      text-align: center;
    }

    #auth-form {
      max-width: 450px;
      /* Slightly wider */
      margin: 0 auto;
      padding: 2.5rem;
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 204, 255, 0.2);
    }

    #login-form,
    #register-form {
      display: none;
    }

    #login-form.active,
    #register-form.active {
      display: flex;
    }

    #auth-mode-toggle {
      margin-top: 1.5rem;
      font-size: 1rem;
      color: var(--text-secondary);
      cursor: pointer;
      text-decoration: underline;
      transition: color 0.3s ease;
    }

    #auth-mode-toggle:hover {
      color: var(--primary);
    }

    #admin-panel {
      margin-top: 2.5rem;
      text-align: left;
    }

    /* --- Message Boxes --- */
    .message-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 550px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      /* More space between messages */
    }

    .message {
      padding: 1.2rem;
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: slideInFromTop 0.4s ease-out forwards;
    }

    @keyframes slideInFromTop {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.success {
      background-color: var(--success-msg-bg);
      border: 1px solid var(--claim-ready);
      color: var(--claim-ready);
    }

    .message.error {
      background-color: var(--error-msg-bg);
      border: 1px solid var(--error);
      color: var(--error);
    }

    .message.info {
      background-color: var(--info-msg-bg);
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .message.warning {
      background-color: rgba(255, 204, 0, 0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    .message-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      /* Larger close button */
      color: inherit;
      cursor: pointer;
      margin-left: 1.5rem;
      transition: transform 0.2s ease;
    }

    .message-close:hover {
      transform: scale(1.2);
    }

    /* --- Trade Calculator Specific Styles --- */
    .fruit-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      /* Slightly larger cards */
      gap: 1.8rem;
      /* More space */
      margin-top: 2rem;
    }

    .fruit-card {
      background-color: var(--background);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.15);
    }

    .fruit-card:hover {
      transform: translateY(-8px);
      /* More lift */
      box-shadow: 0 0 25px rgba(0, 204, 255, 0.3);
      /* Stronger glow */
      background-color: rgba(26, 26, 26, 0.9);
      /* Darken slightly */
    }

    .fruit-card img {
      max-width: 110px;
      /* Slightly larger images */
      height: auto;
      margin-bottom: 1rem;
      border-radius: 8px;
      /* Rounded image corners */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .fruit-name {
      font-weight: bold;
      font-size: 1.25rem;
      /* Larger font */
      margin-bottom: 0.6rem;
      color: var(--primary);
    }

    .fruit-rarity {
      font-size: 0.95rem;
      margin-bottom: 0.8rem;
      padding: 0.3rem 0.8rem;
      border-radius: 5px;
      display: inline-block;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .rarity-common {
      background-color: rgba(224, 247, 255, 0.1);
      color: var(--common);
      border: 1px solid rgba(224, 247, 255, 0.3);
    }

    .rarity-uncommon {
      background-color: rgba(85, 255, 85, 0.1);
      color: var(--uncommon);
      border: 1px solid rgba(85, 255, 85, 0.3);
    }

    .rarity-rare {
      background-color: rgba(85, 85, 255, 0.1);
      color: var(--rare);
      border: 1px solid rgba(85, 85, 255, 0.3);
    }

    .rarity-legendary {
      background-color: rgba(255, 170, 0, 0.1);
      color: var(--legendary);
      border: 1px solid rgba(255, 170, 0, 0.3);
    }

    .rarity-mythical {
      background-color: rgba(255, 0, 255, 0.1);
      color: var(--mythical);
      border: 1px solid rgba(255, 0, 255, 0.3);
    }

    .fruit-values p {
      font-size: 1rem;
      margin-bottom: 0.3rem;
      color: var(--text-secondary);
    }

    .fruit-quantity-control {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 1rem;
    }

    .fruit-quantity-control button {
      background-color: var(--primary-dark);
      color: var(--text);
      border: none;
      padding: 0.4rem 0.9rem;
      border-radius: 50%;
      /* Circular buttons */
      cursor: pointer;
      font-size: 1.4rem;
      line-height: 1;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 204, 255, 0.3);
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }

    .fruit-quantity-control button:hover {
      background-color: var(--primary);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 204, 255, 0.5);
    }

    .fruit-quantity-control span {
      margin: 0 1rem;
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--primary);
      min-width: 30px;
      text-align: center;
    }

    /* Floating Total Display Styles - Bottom Bar, Centered Content */
    .total-display {
      background: rgba(10, 10, 10, 0.98);
      /* More opaque for a solid bar */
      padding: 1rem 2rem;
      /* Adjusted padding for bar height */
      border-top: 2px solid var(--primary);
      /* Top border for bar effect */
      border-radius: 0;
      /* Remove rounded corners for bar effect */
      box-shadow: 0 -5px 20px rgba(0, 204, 255, 0.6);
      /* Shadow pointing upwards */
      display: none;
      /* HIDDEN BY DEFAULT, SHOWN ONLY WHEN TRADE CALCULATOR IS ACTIVE */
      justify-content: center;
      /* Center content horizontally */
      align-items: center;
      /* Center content vertically */
      position: fixed;
      /* Make it float relative to the viewport */
      bottom: 0;
      /* Position at the very bottom */
      left: 0;
      /* Align to the left edge */
      width: 100%;
      /* Make it a full-width bar */
      z-index: 50;
      /* Ensure it's on top */
      flex-direction: row;
      /* Default to row for better bar layout */
      gap: 2rem;
      /* Space between the two total values */
      transition: opacity 0.3s ease-in-out;
      /* Smooth transitions */
    }

    .total-display p {
      font-size: 1.2rem;
      /* Slightly smaller for bar fit */
      margin-bottom: 0;
      color: var(--text);
      white-space: nowrap;
      /* Prevent text wrapping */
    }

    .total-display strong {
      font-size: 1.8rem;
      /* Adjusted for bar fit */
      color: var(--secondary);
      text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
    }

    /* Media query for smaller screens to stack content if needed */
    @media (max-width: 600px) {
      .total-display {
        flex-direction: column;
        /* Stack items vertically on smaller screens */
        gap: 0.5rem;
        /* Reduce gap when stacked */
        padding: 0.8rem 1rem;
        /* Adjust padding for smaller height */
      }
      .total-display p {
        font-size: 1rem;
      }
      .total-display strong {
        font-size: 1.5rem;
      }
    }


    /* --- Daily Claim & Leaderboard --- */
    #daily-claim-button {
      display: block;
      margin: 2.5rem auto 1.5rem;
      width: fit-content;
      font-size: 1.5rem;
      padding: 1.2rem 3rem;
      border-radius: 10px;
    }

    #daily-claim-status {
      text-align: center;
      font-size: 1.2rem;
      color: var(--text-secondary);
      margin-top: 1.2rem;
      font-weight: 500;
    }

    #daily-claim-status.claim-ready {
      color: var(--claim-ready);
      font-weight: bold;
      text-shadow: 0 0 10px var(--claim-ready-shadow);
      animation: pulse-green 1.8s infinite alternate;
    }

    @keyframes pulse-green {
      0% {
        transform: scale(1);
        box-shadow: 0 0 10px var(--claim-ready-shadow);
      }
      50% {
        transform: scale(1.03);
        box-shadow: 0 0 25px var(--claim-ready-shadow);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 10px var(--claim-ready-shadow);
      }
    }

    #daily-claim-button.claimed {
      background-color: var(--primary-dark);
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
    }

    .countdown-display {
      font-family: 'Consolas', 'Monaco', monospace;
      /* Monospaced font for countdown */
      font-size: 1.3em;
      color: var(--primary);
      text-shadow: 0 0 5px var(--primary);
    }

    #leaderboard-list {
      list-style: none;
      padding: 0;
      margin-top: 2rem;
    }

    .leaderboard-item {
      background-color: var(--background);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.2rem 1.8rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.2rem;
      box-shadow: 0 4px 15px rgba(0, 204, 255, 0.1);
      transition: transform 0.2s ease, background-color 0.2s ease;
    }

    .leaderboard-item:hover {
      transform: translateX(8px);
      background-color: rgba(26, 26, 26, 0.9);
    }

    .leaderboard-item span {
      font-weight: bold;
    }

    .leaderboard-item .rank {
      color: var(--primary);
      font-size: 1.4rem;
      min-width: 40px;
    }

    .leaderboard-item .name {
      flex-grow: 1;
      margin: 0 1.5rem;
      text-align: left;
      color: var(--text);
    }

    .leaderboard-item .coins {
      color: var(--secondary);
      font-size: 1.3rem;
      text-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
    }

    /* --- Post Items (Changelogs, Bulletins, Blogs) --- */
    .post-item {
      background-color: var(--background);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.1);
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .post-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 0 30px rgba(0, 204, 255, 0.2);
    }

    .post-item h3 {
      color: var(--primary);
      margin-bottom: 0.8rem;
      font-size: 1.8rem;
    }

    .post-item p {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
      word-wrap: break-word;
    }

    .blog-meta {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .blog-meta .pfp-small {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--secondary);
      cursor: pointer;
    }

    .blog-meta .author-name {
      font-weight: bold;
      color: var(--secondary);
      cursor: pointer;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .blog-meta .author-name:hover {
      color: var(--secondary-dark);
      text-decoration: underline;
    }

    .delete-button {
      background-color: var(--decline-color);
      color: white;
      border: none;
      padding: 0.7rem 1.4rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      position: absolute;
      bottom: 1.5rem;
      right: 1.5rem;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
    }

    .delete-button:hover {
      background-color: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(220, 53, 69, 0.5);
    }

    .add-form-container {
      margin-top: 2.5rem;
      padding: 2rem;
      background-color: var(--background);
      border: 1px solid var(--primary);
      border-radius: 12px;
      box-shadow: 0 0 25px rgba(0, 204, 255, 0.4);
    }

    /* Blog Pagination Controls */
    .blog-pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(0, 204, 255, 0.1);
    }

    .blog-pagination button {
      background-color: var(--primary-dark);
      color: var(--text);
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 204, 255, 0.3);
    }

    .blog-pagination button:hover:not(:disabled) {
      background-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 204, 255, 0.5);
    }

    .blog-pagination button:disabled {
      background-color: #333;
      color: #777;
      cursor: not-allowed;
      box-shadow: none;
    }

    .blog-pagination span {
      font-size: 1.1rem;
      color: var(--text-secondary);
    }

    /* --- Footer --- */
    footer {
      background-color: var(--card-bg);
      color: var(--text-secondary);
      text-align: center;
      padding: 1.8rem;
      border-top: 1px solid var(--border);
      margin-top: 2.5rem;
      position: relative;
      z-index: 10;
      font-size: 1rem;
    }

    .email-verify-banner {
      background-color: var(--warning);
      color: var(--background);
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 2rem;
      border-radius: 10px;
      display: none;
      font-size: 1.1rem;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
    }

    .email-verify-banner.active {
      display: block;
    }

    .email-verify-banner button {
      background-color: var(--background);
      color: var(--warning);
      border: 1px solid var(--background);
      margin-left: 1.5rem;
      padding: 0.7rem 1.4rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s, color 0.3s, transform 0.2s;
      box-shadow: none;
    }

    .email-verify-banner button:hover {
      background-color: var(--warning);
      color: var(--background);
      transform: translateY(-2px);
    }

    /* --- Home Section Specifics (New Channels Grid) --- */
    #home-section .main-title {
      font-size: 3.5rem;
      font-weight: 700;
      color: var(--primary);
      text-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
      margin-bottom: 2rem;
      animation: glow 2s infinite alternate;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary);
      }
      to {
        text-shadow: 0 0 20px var(--primary), 0 0 30px var(--primary-dark);
      }
    }

    #home-section .clan-description {
      background-color: var(--background);
      padding: 1.8rem 2.5rem;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 204, 255, 0.1);
      line-height: 1.6;
      font-size: 1.2rem;
      max-width: 900px;
      margin: 2.5rem auto;
      text-align: center;
      border: 1px solid rgba(0, 204, 255, 0.2);
    }

    .home-channels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      margin-top: 3rem;
    }

    .channel-card {
      background-color: var(--card-bg);
      padding: 2rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 6px 20px rgba(0, 204, 255, 0.15);
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
      text-align: left;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .channel-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 40px rgba(0, 204, 255, 0.4);
      background-color: #2a2a2a;
    }

    .channel-card h3 {
      color: var(--secondary);
      font-size: 1.6rem;
      margin-bottom: 0.8rem;
      border-bottom: 2px solid rgba(0, 255, 136, 0.4);
      padding-bottom: 0.8rem;
      text-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
    }

    .channel-card p {
      color: var(--text-secondary);
      font-size: 1rem;
      flex-grow: 1;
      margin-bottom: 0;
    }

    .coming-soon {
      color: var(--primary);
      font-style: italic;
      font-weight: 600;
      font-size: 1.3rem;
      text-align: center;
      margin-top: 1rem;
    }

    /* --- Responsive Adjustments --- */
    @media (max-width: 768px) {
      header {
        padding: 1rem 1.5rem;
      }

      .logo {
        font-size: 1.6rem;
      }

      /* Hamburger always visible, but nav content hidden by default */
      .nav-toggle {
        display: flex;
        /* Ensure it's always visible */
      }

      nav {
        /* This nav element is the vertical menu, hidden by default */
        display: none;
        flex-direction: column;
        width: 100%;
        background-color: var(--card-bg);
        position: absolute;
        top: 100%;
        left: 0;
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border);
        box-shadow: 0 8px 20px rgba(0, 204, 255, 0.3);
      }

      nav.active {
        display: flex;
      }

      nav ul {
        align-items: flex-start;
        /* Align links to the left */
        gap: 0.8rem;
      }

      .realm-coin-display {
        margin-left: 0.5rem;
        /* Adjust margin for smaller screens */
      }

      .nav-utility-items {
        align-items: flex-start;
        /* Align to left */
      }


      main {
        padding: 1rem;
      }

      section {
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      h1 {
        font-size: 2.2rem;
      }

      h2 {
        font-size: 1.6rem;
      }

      h3 {
        font-size: 1.3rem;
      }

      .fruit-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1rem;
      }

      .fruit-card img {
        max-width: 90px;
      }

      .fruit-name {
        font-size: 1.1rem;
      }

      .fruit-quantity-control button {
        width: 30px;
        height: 30px;
        font-size: 1.2rem;
      }

      .fruit-quantity-control span {
        font-size: 1.1rem;
        margin: 0 0.6rem;
      }

      /* Total display on small screens: remains fixed and centered */
      .total-display {
        padding: 0.8rem 1rem;
        /* Adjusted padding for smaller height */
      }

      .total-display p {
        font-size: 1rem;
      }

      .total-display strong {
        font-size: 1.5rem;
      }

      #daily-claim-button {
        font-size: 1.2rem;
        padding: 1rem 2rem;
      }

      #daily-claim-status {
        font-size: 1rem;
      }

      .leaderboard-item {
        font-size: 1rem;
        padding: 0.8rem 1rem;
      }

      .leaderboard-item .rank {
        font-size: 1.2rem;
      }

      .leaderboard-item .coins {
        font-size: 1.1rem;
      }

      .post-item {
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .post-item h3 {
        font-size: 1.5rem;
      }

      .email-verify-banner {
        padding: 1rem;
        font-size: 1rem;
        flex-direction: column;
        gap: 0.8rem;
      }

      .email-verify-banner button {
        margin-left: 0;
        margin-top: 0.5rem;
      }

      #home-section .main-title {
        font-size: 2.5rem;
      }

      #home-section .clan-description {
        font-size: 1rem;
        padding: 1.5rem 2rem;
      }

      .home-channels-grid {
        grid-template-columns: 1fr;
      }

      .channel-card {
        padding: 1.5rem;
      }

      .channel-card h3 {
        font-size: 1.4rem;
      }

      .channel-card p {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <canvas id="backgroundCanvas"></canvas>

  <header>
    <a href="#" class="logo" id="shinigami-realm-logo">Shinigami Realm</a>
    <div class="realm-coin-display" onclick="displaySection('daily-realm-coin-section')">
      <span class="realm-coin-icon">ðŸ’°</span>
      <span class="realm-coin-amount" id="current-realm-coin">0</span>
    </div>
    <div class="header-spacer"></div> <button class="nav-toggle" id="nav-toggle">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <nav id="nav-menu">
      <ul>
        <li><a href="#home-section" class="nav-link active">Home</a></li>
        <li><a href="#about-section" class="nav-link">About Us</a></li>
        <li><a href="#changelogs-section" class="nav-link">Changelogs</a></li>
        <li><a href="#bulletins-section" class="nav-link">Bulletins</a></li>
        <li><a href="#trade-calculator-section" class="nav-link">Trade Calculator</a></li>
        <li><a href="#daily-realm-coin-section" class="nav-link">Daily Realm Coin</a></li>
        <li><a href="#shop-section" class="nav-link">Shop</a></li>
        <li><a href="#blogs-section" class="nav-link">Blogs</a></li>
        <li><a href="#giveaways-section" class="nav-link">Giveaways</a></li>
        <li id="admin-nav-item" style="display: none;"><a href="#admin-section" class="nav-link">Admin</a></li>
      </ul>
      <div class="nav-utility-items">
        <li id="auth-status-nav-item" style="display: none;">
          <p class="auth-status" id="auth-status-text"></p>
        </li>
        <li id="login-nav-item"><button id="login-nav-button">Login / Register</button></li>
        <li id="logout-nav-item" style="display: none;"><button id="logout-button">Logout</button></li>
      </div>
    </nav>
  </header>

  <main>
    <div id="message-container" class="message-container"></div>
    <div id="email-verify-banner" class="email-verify-banner">
      Please verify your email to access all features.
      <button id="send-verify-email-button">Resend Verification Email</button>
    </div>

    <section id="home-section" class="active">
      <h1 class="main-title">Welcome to Shinigami Realm</h1>
      <div class="clan-description">
        <p>Your ultimate community hub for Blox Fruits! Join us to trade, share news, track values, and connect with
          other players in the vast and exciting world of Blox Fruits. Our realm is built for transparency, fairness,
          and fun.</p>
      </div>

      <h2>Explore Our Channels</h2>
      <div class="home-channels-grid">
        <div class="channel-card" onclick="displaySection('trade-calculator-section')">
          <h3>Trade Calculator</h3>
          <p>Instantly calculate fruit values and ensure fair trades. No more guesswork!</p>
        </div>
        <div class="channel-card" onclick="displaySection('changelogs-section')">
          <h3>Changelogs</h3>
          <p>Stay updated with all the new features, bug fixes, and improvements in Shinigami Realm.</p>
        </div>
        <div class="channel-card" onclick="displaySection('bulletins-section')">
          <h3>Bulletins</h3>
          <p>Important announcements and news from the Shinigami Realm administration.</p>
        </div>
        <div class="channel-card" onclick="displaySection('daily-realm-coin-section')">
          <h3>Daily Realm Coin</h3>
          <p>Claim your daily bonus coins and boost your in-game economy. Consistency is key!</p>
        </div>
        <div class="channel-card" onclick="displaySection('blogs-section')">
          <h3>Community Blogs</h3>
          <p>Read and share amazing content from our community members. Your stories, guides, and insights matter!</p>
        </div>
        <div class="channel-card" onclick="displaySection('shop-section')">
          <h3>Shop</h3>
          <p>Discover items and upgrades for your journey. (In Progress)</p>
        </div>
        <div class="channel-card" onclick="displaySection('about-section')">
          <h3>About Us</h3>
          <p>Learn more about Shinigami Realm, our mission, and meet the dedicated staff behind the community.</p>
        </div>
        <div class="channel-card" onclick="displaySection('giveaways-section')">
          <h3>Giveaways</h3>
          <p>Participate in exciting giveaways for a chance to win amazing prizes!</p>
        </div>
        <div class="channel-card" onclick="displaySection('admin-section')" id="admin-home-card" style="display: none;">
          <h3>Admin Panel</h3>
          <p>Access administrative tools to manage content and users (Admin access only).</p>
        </div>
      </div>
    </section>

    <section id="about-section">
      <h1>About Us</h1>
      <p>Shinigami Realm is a dedicated Blox Fruits community, striving to provide valuable resources and a fun
        environment for all players.</p>
      <p>Our goal is to help you maximize your Blox Fruits experience with accurate trade values, timely updates, and
        engaging content.</p>
      <div class="staff-section">
        <h2>Our Dedicated Staff</h2>
        <div class="staff-list">
          <p><strong>Owner:</strong> mud</p>
          <p><strong>Co-Owner:</strong> aq.17d , Batman</p>
          <p><strong>Moderator:</strong> rip_gojo</p>
          <p><strong>Community Manager:</strong> GREED , chicken</p>
        </div>
      </div>
      <p style="margin-top: 1.5rem;">For support, suggestions, or to report issues, please join our Discord server:</p>
      <a href="https://discord.gg/NgbcrWSVm5" target="_blank" class="button secondary-button">Join Our Discord!</a>
    </section>

    <section id="changelogs-section">
      <h1>Changelogs</h1>
      <div id="changelogs-container">
      </div>
    </section>

    <section id="bulletins-section">
      <h1>Bulletins</h1>
      <div id="bulletins-container">
      </div>
    </section>

    <section id="trade-calculator-section">
      <h1>Blox Fruits Trade Calculator</h1>
      <p>Easily calculate the Beli and trade values of your fruits.</p>
      <input type="text" id="fruit-search" placeholder="Search for a fruit..." />
      <div id="fruit-list" class="fruit-grid">
      </div>
    </section>
    <div class="total-display">
      <p>Total Beli Value: <strong id="total-beli">0</strong></p>
      <p>Total Trade Value: <strong id="total-trade-value">0</strong></p>
    </div>

    <section id="daily-realm-coin-section">
      <h1>Daily Realm Coin</h1>
      <p>Claim your daily Realm Coins to boost your balance!</p>
      <button id="daily-claim-button">Claim Daily Realm Coin</button>
      <p id="daily-claim-status"></p>

      <h2>Top 10 Realm Coin Holders</h2>
      <ul id="leaderboard-list">
      </ul>
    </section>

    <section id="shop-section">
      <h1>Shop</h1>
      <p class="coming-soon">In Progress</p>
    </section>

    <section id="blogs-section">
      <h1>Community Blogs</h1>
      <div id="add-blog-container" class="add-form-container">
        <h2>Add New Blog Post</h2>
        <form id="add-blog-form">
          <label for="blog-title">Title:</label>
          <input type="text" id="blog-title" maxlength="100" required />
          <label for="blog-content">Content:</label>
          <textarea id="blog-content" rows="10" maxlength="2000" required></textarea>
          <button type="submit">Publish Blog Post</button>
        </form>
      </div>
      <div id="blogs-container">
      </div>
      <div id="blog-pagination-controls" class="blog-pagination" style="display: none;">
        <button id="prev-blog-page">Previous</button>
        <span id="blog-page-info">Page 1 of 1</span>
        <button id="next-blog-page">Next</button>
      </div>
    </section>

    <section id="giveaways-section">
      <h1>Giveaways</h1>
      <p class="coming-soon">Waiting for sauce..</p>
    </section>

    <section id="admin-section">
      <h1>Admin Panel</h1>
      <div id="admin-panel">
        <h2>Add New Changelog</h2>
        <form id="add-changelog-form">
          <label for="changelog-title">Title:</label>
          <input type="text" id="changelog-title" maxlength="100" required />
          <label for="changelog-content">Content:</label>
          <textarea id="changelog-content" rows="5" maxlength="1000" required></textarea>
          <button type="submit">Add Changelog</button>
        </form>

        <h2>Add New Bulletin</h2>
        <form id="add-bulletin-form">
          <label for="bulletin-title">Title:</label>
          <input type="text" id="bulletin-title" maxlength="100" required />
          <label for="bulletin-content">Content:</label>
          <textarea id="bulletin-content" rows="5" maxlength="1000" required></textarea>
          <button type="submit">Add Bulletin</button>
        </form>
      </div>
    </section>

    <section id="auth-section">
      <h1>Authentication</h1>
      <div id="auth-form">
        <form id="login-form" class="active">
          <h2>Login</h2>
          <label for="login-email">Email:</label>
          <input type="email" id="login-email" required />
          <label for="login-password">Password:</label>
          <input type="password" id="login-password" required />
          <button type="submit">Login</button>
        </form>

        <form id="register-form">
          <h2>Register</h2>
          <label for="register-display-name">Display Name:</label>
          <input type="text" id="register-display-name" maxlength="50" required />
          <label for="register-email">Email:</label>
          <input type="email" id="register-email" required />
          <label for="register-password">Password:</label>
          <input type="password" id="register-password" required />
          <button type="submit">Register</button>
        </form>
        <p id="auth-mode-toggle">Switch to <span id="toggle-text">Register</span></p>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Shinigami Realm. All rights reserved.</p>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase Configuration ---
    // IMPORTANT: These are your actual Firebase project settings.
    const firebaseConfig = {
      apiKey: "AIzaSyDa22uXbbmUb2CWU9AEbvqb90nsLZeul4M",
      authDomain: "shinigami-realm-c5b79.firebaseapp.com",
      projectId: "shinigami-realm-c5b79",
      storageBucket: "shinigami-realm-c5b79.firebasestorage.app",
      messagingSenderId: "540557371652",
      appId: "1:540557371652:web:67a3f100b1d4c2964b8851",
      measurementId: "G-G4YV145Q71"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Explicitly set appId for consistent data paths on GitHub Pages
    // This value MUST match the 'appId' in your firebaseConfig above AND the {appId} in your Firestore Security Rules.
    const appId = firebaseConfig.appId.split(':')[2]; // Extracts the web app ID part
    console.log('Using hardcoded appId for GitHub Pages:', appId);

    // REMINDER: This is your actual admin email!
    const ADMIN_EMAIL = "daiwikmjith90@gmail.com";
    let isAdmin = false;
    let currentUser = null;

    // REMINDER: Ensure this URL is stable or upload your own default PFP to Firebase Storage!
    const DEFAULT_PFP = "https://placehold.co/100/00ccff/000000?text=PFP";


    // --- UI Elements ---
    const navToggle = document.getElementById('nav-toggle');
    const navMenu = document.getElementById('nav-menu'); // This is now the vertical menu container
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('section');
    const messageContainer = document.getElementById('message-container');
    const emailVerifyBanner = document.getElementById('email-verify-banner');
    const sendVerifyEmailButton = document.getElementById('send-verify-email-button');

    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const authModeToggle = document.getElementById('auth-mode-toggle');
    const toggleText = document.getElementById('toggle-text');
    const logoutButton = document.getElementById('logout-button');
    const loginNavButton = document.getElementById('login-nav-button'); // New button for login/register in nav

    const adminNavItem = document.getElementById('admin-nav-item');
    const loginNavItem = document.getElementById('login-nav-item');
    const logoutNavItem = document.getElementById('logout-nav-item');
    const realmCoinDisplay = document.querySelector('.realm-coin-display'); // Moved to top level
    const authStatusNavItem = document.getElementById('auth-status-nav-item');
    const authStatusText = document.getElementById('auth-status-text');

    // Removed profile-related DOM elements
    // const updateProfileForm = document.getElementById('update-profile-form');
    // const updateDisplayNameInput = document.getElementById('update-display-name');
    // const updateProfilePicInput = document.getElementById('update-profile-pic');
    // const updateBioInput = document.getElementById('update-bio');
    // const profileAvatar = document.getElementById('profile-avatar');
    // const profileDisplayName = document.getElementById('profile-display-name');
    // const profileEmail = document.getElementById('profile-email');
    // const profileCoins = document.getElementById('profile-coins');
    // const profileLastClaim = document.getElementById('profile-last-claim');
    // const profileBioText = document.getElementById('profile-bio-text');
    const currentRealmCoin = document.getElementById('current-realm-coin'); // For nav bar display

    const addChangelogForm = document.getElementById('add-changelog-form');
    const changelogTitleInput = document.getElementById('changelog-title'); // Corrected typo
    const changelogContentInput = document.getElementById('changelog-content');
    const changelogsContainer = document.getElementById('changelogs-container');

    const addBulletinForm = document.getElementById('add-bulletin-form');
    const bulletinTitleInput = document.getElementById('bulletin-title');
    const bulletinContentInput = document.getElementById('bulletin-content');
    const bulletinsContainer = document.getElementById('bulletins-container');

    const addBlogForm = document.getElementById('add-blog-form');
    const blogTitleInput = document.getElementById('blog-title');
    const blogContentInput = document.getElementById('blog-content');
    const blogsContainer = document.getElementById('blogs-container');
    const addBlogContainer = document.getElementById('add-blog-container');
    const blogPaginationControls = document.getElementById('blog-pagination-controls');
    const prevBlogPageButton = document.getElementById('prev-blog-page');
    const nextBlogPageButton = document.getElementById('next-blog-page');
    const blogPageInfoSpan = document.getElementById('blog-page-info');

    const dailyClaimButton = document.getElementById('daily-claim-button');
    const dailyClaimStatus = document.getElementById('daily-claim-status');
    const leaderboardList = document.getElementById('leaderboard-list');

    const fruitSearchInput = document.getElementById('fruit-search');
    const fruitListContainer = document.getElementById('fruit-list');
    const totalBeliSpan = document.getElementById('total-beli');
    const totalTradeValueSpan = document.getElementById('total-trade-value');
    const totalDisplay = document.querySelector('.total-display'); // Get the total display element

    const adminHomeCard = document.getElementById('admin-home-card');
    const shinigamiRealmLogo = document.getElementById('shinigami-realm-logo'); // Added for title click


    // --- Utility Functions ---

    /**
     * Displays a temporary message to the user.
     * @param {string} msg - The message to display.
     * @param {'success'|'error'|'info'|'warning'} type - The type of message.
     */
    function showMessage(msg, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.innerHTML = `
        <span>${msg}</span>
        <button class="message-close">&times;</button>
      `;
      messageContainer.prepend(messageDiv);

      messageDiv.querySelector('.message-close').addEventListener('click', () => {
        messageDiv.remove();
      });

      setTimeout(() => {
        messageDiv.remove();
      }, 5000); // Message disappears after 5 seconds
    }

    /**
     * Displays the selected section and hides others.
     * Fetches content relevant to the section.
     * @param {string} sectionId - The ID of the section to display (e.g., 'home-section').
     */
    function displaySection(sectionId) {
      sections.forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(sectionId).classList.add('active');

      // Update active nav link
      navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === `#${sectionId}`) {
          link.classList.add('active');
        }
      });

      // Close mobile nav if open
      if (navMenu.classList.contains('active')) {
        navMenu.classList.remove('active');
        navToggle.classList.remove('active'); // Reset hamburger icon
      }

      // --- Control visibility of total-display ---
      if (sectionId === 'trade-calculator-section') {
        totalDisplay.style.display = 'flex'; // Show it when trade calculator is active
      } else {
        totalDisplay.style.display = 'none'; // Hide it for all other sections
      }
      // --- End control visibility ---

      // Load content based on section
      switch (sectionId) {
        case 'changelogs-section':
          fetchChangelogs();
          break;
        case 'bulletins-section':
          fetchBulletins();
          break;
        case 'trade-calculator-section':
          renderFruits(); // Re-render fruits on section display
          calculateTotals();
          break;
        case 'daily-realm-coin-section':
          fetchLeaderboard();
          updateDailyClaimUI();
          break;
        case 'blogs-section':
          currentBlogPage = 1; // Reset to first page when navigating to blogs
          fetchBlogs();
          break;
        case 'shop-section':
          // No specific data fetch for shop, just display the content
          break;
        case 'admin-section':
          if (!isAdmin) {
            // No showMessage here, as it's a passive navigation
            displaySection('home-section'); // Redirect if not admin
          }
          break;
        case 'giveaways-section':
          // No specific data fetch for giveaways, just display the content
          break;
      }
    }


    // --- Authentication ---

    // Handles user login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = loginForm['login-email'].value;
      const password = loginForm['login-password'].value;

      try {
        await auth.signInWithEmailAndPassword(email, password);
        showMessage('Logged in successfully!', 'success');
        loginForm.reset();
        // displaySection('home-section'); // Handled by onAuthStateChanged
      } catch (error) {
        console.error("Login Error:", error.message);
        showMessage(`Login failed: ${error.message}`, 'error');
      }
    });

    // Handles user registration
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const displayName = registerForm['register-display-name'].value;
      const email = registerForm['register-email'].value;
      const password = registerForm['register-password'].value;

      // Basic input validation
      if (displayName.trim() === '' || displayName.length > 50) {
        showMessage('Display Name is required and must be 50 characters or less.', 'error');
        return;
      }
      if (password.length < 6) { // Firebase Auth requires at least 6 characters
        showMessage('Password must be at least 6 characters long.', 'error');
        return;
      }

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // Send email verification
        await user.sendEmailVerification();
        showMessage('Registration successful! Please verify your email.', 'success');

        // Set display name in Auth (though not used for display in UI anymore, good for internal Firebase)
        await user.updateProfile({
          displayName: displayName
        });

        // Create initial currency data in Firestore (profile data is no longer stored here)
        await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('currency').doc('data').set({
          realmCoins: 0,
          lastClaimTime: null,
        });


        registerForm.reset();
        // displaySection('home-section'); // Handled by onAuthStateChanged
      } catch (error) {
        console.error("Registration Error:", error.message);
        showMessage(`Registration failed: ${error.message}`, 'error');
      }
    });

    // Toggles between login and registration forms
    authModeToggle.addEventListener('click', () => {
      if (loginForm.classList.contains('active')) {
        loginForm.classList.remove('active');
        registerForm.classList.add('active');
        toggleText.textContent = 'Login';
      } else {
        loginForm.classList.add('active');
        registerForm.classList.remove('active');
        toggleText.textContent = 'Register';
      }
    });

    // Handle Login/Register button in nav
    loginNavButton.addEventListener('click', () => {
      displaySection('auth-section');
    });

    // Send email verification
    sendVerifyEmailButton.addEventListener('click', async () => {
      if (currentUser && !currentUser.emailVerified) {
        try {
          await currentUser.sendEmailVerification();
          showMessage('Verification email sent! Please check your inbox.', 'info');
        } catch (error) {
          console.error("Email Verification Error:", error.message);
          showMessage(`Failed to send verification email: ${error.message}`, 'error');
        }
      }
    });

    // Auth state change listener
    auth.onAuthStateChanged(async user => {
      currentUser = user;
      if (user) {
        // User is signed in.
        loginNavItem.style.display = 'none';
        logoutNavItem.style.display = 'list-item';
        authStatusNavItem.style.display = 'list-item';
        // Set display name to first 5 letters of email
        authStatusText.textContent = `Logged in as: ${user.email.substring(0, 5)}`;


        // Check for admin status
        isAdmin = (user.email === ADMIN_EMAIL);
        adminNavItem.style.display = isAdmin ? 'list-item' : 'none';
        adminHomeCard.style.display = isAdmin ? 'flex' : 'none'; // Show admin card on home

        // Check email verification status
        if (!user.emailVerified) {
          emailVerifyBanner.classList.add('active');
          // If email not verified, force to auth section and prevent access to other sections
          displaySection('auth-section');
        } else {
          emailVerifyBanner.classList.remove('active');
          // If email verified, load user data and navigate to home
          // No longer fetching user profile data as it's removed
          updateDailyClaimUI(); // Update daily claim status
          fetchLeaderboard(); // Fetch leaderboard
          fetchChangelogs(); // Fetch public data
          fetchBulletins();
          fetchBlogs(); // Fetch blogs (now accessible by all verified)

          // Only navigate to home if not already on a specific section (e.g., if user refreshed on profile page)
          const currentActiveSection = document.querySelector('section.active');
          if (!currentActiveSection || currentActiveSection.id === 'auth-section') {
            displaySection('home-section');
          }
        }

      } else {
        // User is signed out.
        loginNavItem.style.display = 'list-item';
        logoutNavItem.style.display = 'none';
        authStatusNavItem.style.display = 'none';
        adminNavItem.style.display = 'none';
        adminHomeCard.style.display = 'none';
        isAdmin = false;
        emailVerifyBanner.classList.remove('active');

        // Clear display name in nav
        authStatusText.textContent = '';
        currentRealmCoin.textContent = '0'; // Reset nav bar coins

        displaySection('auth-section'); // Redirect to auth section
        fetchChangelogs(); // Still fetch public data
        fetchBulletins();
        fetchBlogs();
        fetchLeaderboard(); // Leaderboard can be public
      }
    });


    // --- User Profile Management (REMOVED) ---
    // All profile-related DOM elements and JavaScript functions for updating/fetching profiles have been removed.
    // User display name is now derived from the first 5 characters of their email.


    // --- Content Management (Admin Functions) ---

    // Add Changelog
    addChangelogForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isAdmin) {
        showMessage("Permission denied.", "error");
        return;
      }

      const title = changelogTitleInput.value.trim();
      const content = changelogContentInput.value.trim();

      // Input validation
      if (title === '' || title.length > 100) {
        showMessage('Changelog Title is required and must be 100 characters or less.', 'error');
        return;
      }
      if (content === '' || content.length > 1000) {
        showMessage('Changelog Content is required and must be 1000 characters or less.', 'error');
        return;
      }

      try {
        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('changelogs').add({
          title: title,
          content: content,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          authorEmail: currentUser ? currentUser.email : 'Admin'
        });
        showMessage('Changelog added successfully!', 'success');
        addChangelogForm.reset();
        fetchChangelogs();
      } catch (error) {
        console.error("Add Changelog Error:", error.message);
        showMessage(`Failed to add changelog: ${error.message}`, 'error');
      }
    });

    // Fetch Changelogs
    async function fetchChangelogs() {
      try {
        const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('changelogs').orderBy('timestamp', 'desc').get();
        renderChangelogs(snapshot.docs);
      } catch (error) {
        console.error("Error fetching changelogs:", error.message);
        // Removed showMessage(`Failed to load changelogs: ${error.message}`, 'error');
      }
    }

    // Render Changelogs
    function renderChangelogs(docs) {
      changelogsContainer.innerHTML = ''; // Clear existing
      if (docs.length === 0) {
        changelogsContainer.innerHTML = '<p>No changelogs yet.</p>';
        return;
      }
      docs.forEach(doc => {
        const changelog = doc.data();
        const changelogItem = document.createElement('div');
        changelogItem.classList.add('post-item');
        const postDate = changelog.timestamp ? new Date(changelog.timestamp.toDate()).toLocaleString() : 'Unknown Date';

        changelogItem.innerHTML = `
          <h3>${changelog.title}</h3>
          <p class="blog-meta">Posted by ${changelog.authorEmail ? changelog.authorEmail.substring(0, 5) : 'Anonymous'} on ${postDate}</p>
          <p>${changelog.content}</p>
          ${isAdmin ? `<button class="delete-button danger-button" data-id="${doc.id}" data-type="changelog">Delete</button>` : ''}
        `;
        changelogsContainer.appendChild(changelogItem);
      });

      if (isAdmin) {
        changelogsContainer.querySelectorAll('.delete-button').forEach(button => {
          button.addEventListener('click', (e) => {
            const docId = e.target.dataset.id;
            deleteContent('changelog', docId);
          });
        });
      }
    }

    // Add Bulletin
    addBulletinForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isAdmin) {
        showMessage("Permission denied.", "error");
        return;
      }

      const title = bulletinTitleInput.value.trim();
      const content = bulletinContentInput.value.trim();

      // Input validation
      if (title === '' || title.length > 100) {
        showMessage('Bulletin Title is required and must be 100 characters or less.', 'error');
        return;
      }
      if (content === '' || content.length > 1000) {
        showMessage('Bulletin Content is required and must be 1000 characters or less.', 'error');
        return;
      }

      try {
        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bulletins').add({
          title: title,
          content: content,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          authorEmail: currentUser ? currentUser.email : 'Admin'
        });
        showMessage('Bulletin added successfully!', 'success');
        addBulletinForm.reset();
        fetchBulletins();
      } catch (error) {
        console.error("Add Bulletin Error:", error.message);
        showMessage(`Failed to add bulletin: ${error.message}`, 'error');
      }
    });

    // Fetch Bulletins
    async function fetchBulletins() {
      try {
        const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bulletins').orderBy('timestamp', 'desc').get();
        renderBulletins(snapshot.docs);
      } catch (error) {
        console.error("Error fetching bulletins:", error.message);
        // Removed showMessage(`Failed to load bulletins: ${error.message}`, 'error');
      }
    }

    // Render Bulletins
    function renderBulletins(docs) {
      bulletinsContainer.innerHTML = ''; // Clear existing
      if (docs.length === 0) {
        bulletinsContainer.innerHTML = '<p>No bulletins yet.</p>';
        return;
      }
      docs.forEach(doc => {
        const bulletin = doc.data();
        const bulletinItem = document.createElement('div');
        bulletinItem.classList.add('post-item');
        const postDate = bulletin.timestamp ? new Date(bulletin.timestamp.toDate()).toLocaleString() : 'Unknown Date';

        bulletinItem.innerHTML = `
          <h3>${bulletin.title}</h3>
          <p class="blog-meta">Posted by ${bulletin.authorEmail ? bulletin.authorEmail.substring(0, 5) : 'Anonymous'} on ${postDate}</p>
          <p>${bulletin.content}</p>
          ${isAdmin ? `<button class="delete-button danger-button" data-id="${doc.id}" data-type="bulletin">Delete</button>` : ''}
        `;
        bulletinsContainer.appendChild(bulletinItem);
      });

      if (isAdmin) {
        bulletinsContainer.querySelectorAll('.delete-button').forEach(button => {
          button.addEventListener('click', (e) => {
            const docId = e.target.dataset.id;
            deleteContent('bulletin', docId);
          });
        });
      }
    }

    // Generic Delete Content Function
    async function deleteContent(type, docId) {
      if (!isAdmin) {
        showMessage("Permission denied.", "error");
        return;
      }

      // Custom confirmation dialog
      const confirmDelete = await new Promise(resolve => {
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
        `;
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: var(--card-bg);
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 0 15px rgba(0,204,255,0.5);
          text-align: center;
          color: var(--text);
        `;
        modalContent.innerHTML = `
          <p style="margin-bottom: 20px;">Are you sure you want to delete this ${type}?</p>
          <button id="confirmDeleteBtn" style="background-color: var(--decline-color); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Yes, Delete</button>
          <button id="cancelDeleteBtn" style="background-color: var(--primary); color: black; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
        `;
        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        document.getElementById('confirmDeleteBtn').onclick = () => {
          document.body.removeChild(modal);
          resolve(true);
        };
        document.getElementById('cancelDeleteBtn').onclick = () => {
          document.body.removeChild(modal);
          resolve(false);
        };
      });

      if (!confirmDelete) {
        showMessage(`${type.charAt(0).toUpperCase() + type.slice(1)} deletion cancelled.`, 'info');
        return;
      }

      try {
        const collectionPath = `artifacts/${appId}/public/data/${type}s`; // e.g., 'bulletins', 'changelogs'
        await db.collection(collectionPath).doc(docId).delete();
        showMessage(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully!`, 'success');
        if (type === 'changelog') fetchChangelogs();
        else if (type === 'bulletin') fetchBulletins();
        else if (type === 'blog') fetchBlogs(); // Added for blog deletion
      } catch (error) {
        console.error(`Error deleting ${type}:`, error.message);
        showMessage(`Failed to delete ${type}: ${error.message}`, 'error');
      }
    }


    // --- Blog Management ---
    let allBlogs = [];
    const blogsPerPage = 10;
    let currentBlogPage = 1;
    let totalBlogPages = 1;

    // Add Blog Post
    addBlogForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showMessage("Please login to create a blog post.", "error");
        return;
      }
      if (!currentUser.emailVerified) {
        showMessage("Please verify your email to create blog posts.", "warning");
        return;
      }

      const blogTitle = blogTitleInput.value.trim();
      const blogContent = blogContentInput.value.trim();

      // Input validation
      if (blogTitle === '' || blogTitle.length > 100) {
        showMessage('Blog Title is required and must be 100 characters or less.', 'error');
        return;
      }
      if (blogContent === '' || blogContent.length > 2000) {
        showMessage('Blog Content is required and must be 2000 characters or less.', 'error');
        return;
      }


      try {
        // Author's display name will now be derived from the first 5 letters of their email
        const authorDisplayName = currentUser.email.substring(0, 5);
        const authorPfpUrl = DEFAULT_PFP; // Default PFP since profile management is removed

        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('blogs').add({
          title: blogTitle,
          content: blogContent,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          authorUid: currentUser.uid,
          authorEmail: currentUser.email,
          authorDisplayName: authorDisplayName, // Use derived name
          authorPfpUrl: authorPfpUrl // Use default PFP
        });
        showMessage('Blog post published successfully!', 'success');
        addBlogForm.reset();
        currentBlogPage = 1; // Reset to first page after adding new blog
        fetchBlogs();
      } catch (error) {
        console.error("Add Blog Error:", error.message);
        showMessage(`Failed to publish blog post: ${error.message}`, 'error');
      }
    });

    // Fetch Blogs
    async function fetchBlogs() {
      try {
        const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('blogs').orderBy('timestamp', 'desc').get();
        allBlogs = snapshot.docs; // Store all docs for pagination
        totalBlogPages = Math.ceil(allBlogs.length / blogsPerPage);

        renderBlogs(); // Render current page of blogs
        updateBlogPaginationUI(); // Update pagination controls

        // Show/hide add blog form based on user login/verification status
        if (currentUser && currentUser.emailVerified) {
          addBlogContainer.style.display = 'block';
        } else {
          addBlogContainer.style.display = 'none';
        }
      } catch (error) {
        console.error("Error fetching blogs:", error.message);
        // Removed showMessage(`Failed to load blogs: ${error.message}`, 'error');
      }
    }

    // Render Blogs for the current page
    function renderBlogs() {
      blogsContainer.innerHTML = ''; // Clear existing
      const startIndex = (currentBlogPage - 1) * blogsPerPage;
      const endIndex = startIndex + blogsPerPage;
      const blogsToDisplay = allBlogs.slice(startIndex, endIndex);

      if (blogsToDisplay.length === 0) {
        blogsContainer.innerHTML = '<p>No blog posts yet.</p>';
        return;
      }
      blogsToDisplay.forEach(doc => {
        const blog = doc.data();
        const blogItem = document.createElement('div');
        blogItem.classList.add('post-item');
        const postDate = blog.timestamp ? new Date(blog.timestamp.toDate()).toLocaleString() : 'Unknown Date';

        const isAuthor = currentUser && blog.authorUid === currentUser.uid;
        const canDelete = isAdmin || isAuthor;

        // Use derived display name and default PFP
        const displayAuthorName = blog.authorEmail ? blog.authorEmail.substring(0, 5) : 'Anonymous';
        const displayAuthorPfp = DEFAULT_PFP;


        blogItem.innerHTML = `
          <p class="blog-meta">
            <img src="${displayAuthorPfp}" alt="Author PFP" class="pfp-small">
            Posted by <span class="author-name">${displayAuthorName}</span> on ${postDate}
          </p>
          <h3>${blog.title}</h3>
          <p>${blog.content}</p>
          ${canDelete ? `<button class="delete-button danger-button" data-id="${doc.id}" data-type="blog">Delete</button>` : ''}
        `;
        blogsContainer.appendChild(blogItem);
      });

      blogsContainer.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', (e) => {
          const docId = e.target.dataset.id;
          deleteContent('blog', docId); // Use generic deleteContent for blogs
        });
      });

      // Removed event listeners for PFP/Author Name clicks as there's no profile section
    }

    // Update Blog Pagination UI
    function updateBlogPaginationUI() {
      if (totalBlogPages > 1) {
        blogPaginationControls.style.display = 'flex';
        blogPageInfoSpan.textContent = `Page ${currentBlogPage} of ${totalBlogPages}`;
        prevBlogPageButton.disabled = (currentBlogPage === 1);
        nextBlogPageButton.disabled = (currentBlogPage === totalBlogPages);
      } else {
        blogPaginationControls.style.display = 'none';
      }
    }

    // Pagination button event listeners
    prevBlogPageButton.addEventListener('click', () => {
      if (currentBlogPage > 1) {
        currentBlogPage--;
        renderBlogs();
        updateBlogPaginationUI();
      }
    });

    nextBlogPageButton.addEventListener('click', () => {
      if (currentBlogPage < totalBlogPages) {
        currentBlogPage++;
        renderBlogs();
        updateBlogPaginationUI();
      }
    });

    // Delete Blog Post (now handled by generic deleteContent)
    // async function deleteBlogPost(docId) { ... }


    // --- Daily Realm Coin & Leaderboard ---

    // Claim Daily Realm Coin (Uses Firestore Transaction for atomicity)
    dailyClaimButton.addEventListener('click', async () => {
      if (!currentUser) {
        showMessage("Please login to claim daily Realm Coins.", "error");
        return;
      }
      if (!currentUser.emailVerified) {
        showMessage("Please verify your email to claim daily Realm Coins.", "warning");
        return;
      }

      const userId = currentUser.uid;
      const userCurrencyRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('currency').doc('data');
      const COIN_REWARD = 5; // Amount of coins per claim - UPDATED TO 5
      const COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

      try {
        await db.runTransaction(async (transaction) => {
          const userDoc = await transaction.get(userCurrencyRef);

          if (!userDoc.exists) {
            // If currency doc doesn't exist, create it with initial values
            transaction.set(userCurrencyRef, {
              realmCoins: COIN_REWARD,
              lastClaimTime: firebase.firestore.FieldValue.serverTimestamp()
            });
            showMessage(`Successfully claimed ${COIN_REWARD} Realm Coins!`, 'success');
            return; // Transaction successful
          }

          const userData = userDoc.data();
          const lastClaimTime = userData.lastClaimTime ? userData.lastClaimTime.toDate().getTime() : 0;
          const currentTime = Date.now();

          if (currentTime - lastClaimTime < COOLDOWN_MS) {
            const timeLeftMs = COOLDOWN_MS - (currentTime - lastClaimTime);
            const hours = Math.floor(timeLeftMs / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeftMs % (1000 * 60 * 60)) / (1000 * 60));
            throw new Error(`You can claim again in ${hours}h ${minutes}m.`);
          }

          // Update user's coins and last claim time
          const newRealmCoins = (userData.realmCoins || 0) + COIN_REWARD;
          transaction.update(userCurrencyRef, {
            realmCoins: newRealmCoins,
            lastClaimTime: firebase.firestore.FieldValue.serverTimestamp()
          });

          showMessage(`Successfully claimed ${COIN_REWARD} Realm Coins!`, 'success');
        });
      } catch (error) {
        console.error("Claim Daily Coin Error:", error.message);
        showMessage(`Claim failed: ${error.message}`, 'error');
      } finally {
        updateDailyClaimUI(); // Always re-check status after attempt
        fetchLeaderboard(); // Refresh leaderboard
        // No longer fetching user profile after claim as profile section is removed
      }
    });

    let claimTimerInterval = null;

    function updateDailyClaimUI() {
      if (!currentUser || !currentUser.emailVerified) {
        dailyClaimStatus.textContent = "Login & Verify Email to Claim.";
        dailyClaimButton.disabled = true;
        dailyClaimButton.classList.add('claimed');
        dailyClaimStatus.classList.remove('claim-ready');
        clearInterval(claimTimerInterval);
        currentRealmCoin.textContent = '0'; // Reset nav bar coins
        return;
      }

      db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('currency').doc('data').get().then(doc => {
        if (doc.exists) {
          const userData = doc.data();
          const lastClaimTime = userData.lastClaimTime ? userData.lastClaimTime.toDate().getTime() : 0;
          const currentTime = Date.now();
          const COOLDOWN_MS = 24 * 60 * 60 * 1000;

          currentRealmCoin.textContent = userData.realmCoins ? userData.realmCoins.toLocaleString() : '0';

          if (currentTime - lastClaimTime < COOLDOWN_MS) {
            dailyClaimButton.disabled = true;
            dailyClaimButton.classList.add('claimed');
            dailyClaimStatus.classList.remove('claim-ready');
            startClaimCooldownTimer(COOLDOWN_MS - (currentTime - lastClaimTime));
          } else {
            dailyClaimButton.disabled = false;
            dailyClaimButton.classList.remove('claimed');
            dailyClaimStatus.textContent = "Ready to claim!";
            dailyClaimStatus.classList.add('claim-ready');
            clearInterval(claimTimerInterval);
          }
        } else {
          // User currency doc not found, assume never claimed
          dailyClaimButton.disabled = false;
          dailyClaimButton.classList.remove('claimed');
          dailyClaimStatus.textContent = "Ready to claim!";
          dailyClaimStatus.classList.add('claim-ready');
          clearInterval(claimTimerInterval);
          currentRealmCoin.textContent = '0'; // Default if no currency doc
        }
      }).catch(error => {
        console.error("Error updating daily claim UI:", error.message);
        // Removed showMessage("Failed to load claim status.", "error");
        dailyClaimButton.disabled = true; // Disable on error
      });
    }

    function startClaimCooldownTimer(initialTimeLeftMs) {
      clearInterval(claimTimerInterval); // Clear any existing timer
      let timeLeft = initialTimeLeftMs;

      if (timeLeft <= 0) {
        updateDailyClaimUI(); // Immediately update if already expired
        return;
      }

      claimTimerInterval = setInterval(() => {
        timeLeft -= 1000; // Decrement by 1 second

        if (timeLeft <= 0) {
          clearInterval(claimTimerInterval);
          updateDailyClaimUI(); // Update UI to "Ready to claim!"
        } else {
          const hours = Math.floor(timeLeft / (1000 * 60 * 60));
          const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
          dailyClaimStatus.innerHTML = `You can claim again in: <span class="countdown-display">${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</span>`;
        }
      }, 1000);
    }

    // Fetch Leaderboard
    async function fetchLeaderboard() {
      try {
        // Fetch all user documents to get their UIDs
        const usersSnapshot = await db.collection(`artifacts`).doc(appId).collection('users').get();
        let allUsersData = [];

        // For each user, fetch their currency sub-collection
        for (const userDoc of usersSnapshot.docs) {
          const userId = userDoc.id;
          // No longer fetching profileData, directly use email for display name
          const currencyData = (await db.collection(`artifacts/${appId}/users`).doc(userId).collection('currency').doc('data').get()).data();

          // Get email from auth if user is current user, otherwise use a placeholder or derive from UID if possible
          // For leaderboard, we'll need to fetch user's email if not current user, or rely on stored displayName if any.
          // Since profile is removed, we'll just use the UID for non-current users as a fallback.
          let displayNameForLeaderboard = 'Anonymous';
          if (currentUser && currentUser.uid === userId) {
            displayNameForLeaderboard = currentUser.email.substring(0, 5);
          } else {
            // For other users on leaderboard, we don't have their email directly without fetching their auth record.
            // For simplicity, we'll just use a generic "User-XXXX" or "Anonymous"
            // If you want actual usernames on the leaderboard, you'd need to store a public displayName field
            // in a publicly readable collection or fetch user records (which is server-side).
            // For now, let's use the first 5 chars of their email if available, otherwise "Anonymous"
            // This would require fetching their actual email if not the current user, which is not directly possible
            // from client-side Firestore rules without exposing all emails.
            // A simpler approach for leaderboard is to store displayName directly in currency or a public profile doc.
            // Since profile is removed, we'll use a generic "User-XXXX" for others or rely on blog author's email prefix if they posted.
            // For now, let's stick to 'Anonymous' for non-current users on leaderboard.
            // Or, if you want the 5-letter email prefix for ALL, you'd need to store it publicly.
            // For now, if profile is gone, and we can't fetch other users' emails, we'll use a generic name.
            // Let's assume for the leaderboard, we display the first 5 chars of their email if they have one,
            // otherwise 'Anonymous'. This would require a public field for email or displayName.
            // Given the profile removal, we'll simplify:
            displayNameForLeaderboard = `User-${userId.substring(0, 5)}`; // Fallback to UID prefix
          }


          if (currencyData) {
            allUsersData.push({
              displayName: displayNameForLeaderboard,
              realmCoins: currencyData.realmCoins || 0
            });
          }
        }

        // Sort client-side by realmCoins in descending order
        allUsersData.sort((a, b) => b.realmCoins - a.realmCoins);

        // Take top 10
        const top10 = allUsersData.slice(0, 10);

        renderLeaderboard(top10);
      } catch (error) {
        console.error("Error fetching leaderboard:", error.message);
        // Removed showMessage(`Failed to load leaderboard: ${error.message}`, 'error');
      }
    }

    // Render Leaderboard
    function renderLeaderboard(top10Users) {
      leaderboardList.innerHTML = ''; // Clear existing
      if (top10Users.length === 0) {
        leaderboardList.innerHTML = '<p>No players on the leaderboard yet. Be the first!</p>';
        return;
      }
      top10Users.forEach((userData, index) => {
        const listItem = document.createElement('li');
        listItem.classList.add('leaderboard-item');
        listItem.innerHTML = `
          <span class="rank">#${index + 1}</span>
          <span class="name">${userData.displayName}</span>
          <span class="coins">${userData.realmCoins ? userData.realmCoins.toLocaleString() : '0'} Coins</span>
        `;
        leaderboardList.appendChild(listItem);
      });
    }

    // --- Blox Fruits Trade Calculator ---
    // Updated fruits array based on user's specific list and values
    const fruits = [
      { name: "Dragon (West)", rarity: "Mythical", beli: 3500000, value: 1200000000 },
      { name: "Dragon (East)", rarity: "Mythical", beli: 3500000, value: 960000000 },
      { name: "Kitsune", rarity: "Mythical", beli: 4000000, value: 240000000 },
      { name: "Yeti", rarity: "Legendary", beli: 3800000, value: 140000000 },
      { name: "Gas", rarity: "Legendary", beli: 3600000, value: 75000000 },
      { name: "Leopard", rarity: "Legendary", beli: 5000000, value: 60000000 },
      { name: "Gravity", rarity: "Legendary", beli: 3500000, value: 45000000 }, // Beli value added as requested
      { name: "T-Rex", rarity: "Legendary", beli: 2500000, value: 20000000 },
      { name: "Control", rarity: "Legendary", beli: 3200000, value: 12000000 },
      { name: "Spirit", rarity: "Legendary", beli: 3400000, value: 10000000 },
      { name: "Mammoth", rarity: "Legendary", beli: 2700000, value: 10000000 },
      { name: "Venom", rarity: "Legendary", beli: 3000000, value: 10000000 },
      { name: "Portal", rarity: "Rare", beli: 2400000, value: 10000000 },
      { name: "Buddha", rarity: "Rare", beli: 1200000, value: 10000000 },
      { name: "Rumble", rarity: "Rare", beli: 1700000, value: 7000000 },
      { name: "Shadow", rarity: "Legendary", beli: 2900000, value: 6000000 },
      { name: "Blizzard", rarity: "Rare", beli: 2400000, value: 6000000 },
      { name: "Sound", rarity: "Rare", beli: 2000000, value: 4500000 },
      { name: "Phoenix", rarity: "Rare", beli: 1500000, value: 4000000 },
      { name: "Creation", rarity: "Rare", beli: 1600000, value: 4000000 },
      { name: "Pain", rarity: "Rare", beli: 2300000, value: 4000000 },
      { name: "Spider", rarity: "Rare", beli: 1500000, value: 1500000 },
      { name: "Diamond", rarity: "Rare", beli: 600000, value: 1500000 },
      { name: "Love", rarity: "Rare", beli: 1300000, value: 1250000 },
      { name: "Magma", rarity: "Rare", beli: 850000, value: 1150000 },
      { name: "Quake", rarity: "Rare", beli: 1000000, value: 1000000 },
      { name: "Light", rarity: "Rare", beli: 650000, value: 800000 },
      { name: "Ghost", rarity: "Uncommon", beli: 500000, value: 800000 },
      { name: "Eagle", rarity: "Uncommon", beli: 500000, value: 800000 },
      { name: "Rubber", rarity: "Rare", beli: 700000, value: 700000 },
      { name: "Ice", rarity: "Uncommon", beli: 350000, value: 550000 },
      { name: "Sand", rarity: "Uncommon", beli: 420000, value: 420000 },
      { name: "Dark", rarity: "Uncommon", beli: 400000, value: 400000 },
      { name: "Flame", rarity: "Uncommon", beli: 250000, value: 250000 },
      { name: "Spike", rarity: "Common", beli: 180000, value: 180000 },
      { name: "Smoke", rarity: "Common", beli: 100000, value: 100000 },
      { name: "Bomb", rarity: "Common", beli: 50000, value: 80000 },
      { name: "Spring", rarity: "Common", beli: 100000, value: 60000 },
      { name: "Blade", rarity: "Common", beli: 150000, value: 50000 },
      { name: "Spin", rarity: "Common", beli: 7500, value: 7500 },
      { name: "Rocket", rarity: "Common", beli: 5000, value: 5000 },
    ];


    let fruitQuantities = {};

    // Initialize quantities to 0
    fruits.forEach(fruit => {
      fruitQuantities[fruit.name] = 0;
    });

    // Render fruits to the calculator
    function renderFruits(searchTerm = '') {
      fruitListContainer.innerHTML = '';
      const filteredFruits = fruits.filter(fruit =>
        fruit.name.toLowerCase().includes(searchTerm.toLowerCase())
      );

      if (filteredFruits.length === 0) {
        fruitListContainer.innerHTML = '<p style="text-align: center; width: 100%; color: var(--text-secondary);">No fruits found matching your search.</p>';
        return;
      }

      filteredFruits.forEach(fruit => {
        const fruitCard = document.createElement('div');
        fruitCard.classList.add('fruit-card');
        const rarityClass = `rarity-${fruit.rarity.toLowerCase().replace(' ', '-')}`; // e.g., rarity-mythical

        fruitCard.innerHTML = `
          <img src="https://placehold.co/110x110/1a1a1a/e0f7ff?text=${encodeURIComponent(fruit.name.split(' ')[0])}" alt="${fruit.name} Fruit" onerror="this.onerror=null;this.src='https://placehold.co/110x110/1a1a1a/e0f7ff?text=Fruit';"/>
          <div class="fruit-name">${fruit.name}</div>
          <div class="fruit-rarity ${rarityClass}">${fruit.rarity}</div>
          <div class="fruit-values">
            <p>Beli: ${fruit.beli.toLocaleString()}</p>
            <p>Value: ${fruit.value.toLocaleString()}</p>
          </div>
          <div class="fruit-quantity-control">
            <button data-fruit="${fruit.name}" data-action="decrease">-</button>
            <span id="quantity-${fruit.name.replace(/[^a-zA-Z0-9]/g, '-')}" class="fruit-quantity">${fruitQuantities[fruit.name]}</span>
            <button data-fruit="${fruit.name}" data-action="increase">+</button>
          </div>
        `;
        fruitListContainer.appendChild(fruitCard);
      });

      // Add event listeners for quantity controls
      fruitListContainer.querySelectorAll('.fruit-quantity-control button').forEach(button => {
        button.addEventListener('click', (e) => {
          const fruitName = e.target.dataset.fruit;
          const action = e.target.dataset.action;
          updateFruitQuantity(fruitName, action);
        });
      });
    }

    function updateFruitQuantity(fruitName, action) {
      if (action === 'increase') {
        fruitQuantities[fruitName]++;
      } else if (action === 'decrease' && fruitQuantities[fruitName] > 0) {
        fruitQuantities[fruitName]--;
      }
      // FIX: Changed `fruit.name` to `fruitName` to correctly reference the quantity for the specific fruit.
      document.getElementById(`quantity-${fruitName.replace(/[^a-zA-Z0-9]/g, '-')}`).textContent = fruitQuantities[fruitName];
      calculateTotals();
    }

    function calculateTotals() {
      let totalBeli = 0;
      let totalTradeValue = 0;

      for (const fruit of fruits) {
        const quantity = fruitQuantities[fruit.name] || 0;
        totalBeli += fruit.beli * quantity;
        totalTradeValue += fruit.value * quantity;
      }

      totalBeliSpan.textContent = totalBeli.toLocaleString();
      totalTradeValueSpan.textContent = totalTradeValue.toLocaleString();
    }

    fruitSearchInput.addEventListener('input', (e) => {
      renderFruits(e.target.value);
    });


    // --- Canvas Background Logic ---
    let canvas, ctx, w, h;
    let particles = [];
    const particleCount = 100;
    const maxRadius = 3;
    const minRadius = 1;
    const maxSpeed = 0.5;

    function initCanvasBackground() {
      canvas = document.getElementById("backgroundCanvas");
      // NEW SAFETY NET: Check if canvas element exists before proceeding
      if (!canvas) {
        console.warn("Background canvas element not found. Canvas background will not be rendered.");
        return;
      }
      ctx = canvas.getContext("2d");
      resizeResetCanvas();
      createParticles();
      animateParticles();
    }

    function resizeResetCanvas() {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
      ctx.fillStyle = "#000"; // Ensure clear background
      ctx.fillRect(0, 0, w, h);
    }

    class Particle {
      constructor(x, y) {
        this.x = x;
        this.y = y;
        this.radius = Math.random() * (maxRadius - minRadius) + minRadius;
        this.color = `rgba(0, ${Math.floor(Math.random() * 100) + 155}, ${Math.floor(Math.random() * 200) + 55}, ${Math.random() * 0.5 + 0.3})`;
        this.vx = (Math.random() - 0.5) * maxSpeed;
        this.vy = (Math.random() - 0.5) * maxSpeed;
      }

      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
        ctx.fillStyle = this.color;
        ctx.fill();
      }

      update() {
        this.x += this.vx;
        this.y += this.vy;

        if (this.x - this.radius < 0 || this.x + this.radius > w) {
          this.vx *= -1;
        }
        if (this.y - this.radius < 0 || this.y + this.radius > h) {
          this.vy *= -1;
        }

        this.draw();
      }
    }

    function createParticles() {
      for (let i = 0; i < particleCount; i++) {
        particles.push(new Particle(Math.random() * w, Math.random() * h));
      }
    }

    function animateParticles() {
      requestAnimationFrame(animateParticles);
      ctx.clearRect(0, 0, w, h); // Clear frame
      ctx.fillStyle = "rgba(10, 10, 10, 0.5)"; // Semi-transparent overlay to create trails
      ctx.fillRect(0, 0, w, h);

      for (let i = 0; i < particles.length; i++) {
        particles[i].update();
      }
    }

    // --- Event Listeners and Initial Calls ---

    // Navigation Toggle for mobile (and desktop now)
    navToggle.addEventListener('click', () => {
      navMenu.classList.toggle('active');
      navToggle.classList.toggle('active'); // Toggle hamburger icon to 'X'
    });

    // Handle navigation clicks
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        if (link.id === 'logout-button') return; // Handled separately
        e.preventDefault();
        const sectionId = link.getAttribute('href').substring(1);
        displaySection(sectionId);
      });
    });

    // Redirect to homepage when Shinigami Realm title is clicked
    shinigamiRealmLogo.addEventListener('click', () => {
      displaySection('home-section');
    });

    // Initialize the canvas background
    window.addEventListener('load', initCanvasBackground);
    window.addEventListener('resize', resizeResetCanvas);

    // Initial load - display home section or auth if not logged in
    document.addEventListener('DOMContentLoaded', () => {
      // The onAuthStateChanged listener will handle initial section display
      // based on login status.
      // However, ensure necessary public data is loaded immediately.
      fetchChangelogs();
      fetchBulletins();
      fetchBlogs();
      fetchLeaderboard(); // Leaderboard can be public
      renderFruits(); // Render trade calculator fruits initially
    });
  </script>
</body>

</html>
