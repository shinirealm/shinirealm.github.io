<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shinigami Realm</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* --- CSS Variables for Theming --- */
    :root {
      --primary: #00ccff;
      /* Bright Cyan */
      --primary-dark: #0099cc;
      /* Darker Cyan */
      --secondary: #00ff88;
      /* Vibrant Green */
      --secondary-dark: #00e676;
      /* Darker Vibrant Green */
      --background: #0a0a0a;
      /* Deep Dark Background */
      --card-bg: #1a1a1a;
      /* Slightly Lighter Dark for Cards */
      --text: #e0f7ff;
      /* Light Blue-White for Primary Text */
      --text-secondary: #b0b0b0;
      /* Grey for Secondary Text */
      --border: rgba(0, 204, 255, 0.3);
      /* Semi-transparent Primary Border */
      --mythical: #ff00ff;
      /* Magenta for Mythical Rarity */
      --legendary: #ffaa00;
      /* Orange for Legendary Rarity */
      --rare: #5555ff;
      /* Blue for Rare Rarity */
      --uncommon: #55ff55;
      /* Green for Uncommon Rarity */
      --common: #e0f7ff;
      /* Light Blue-White for Common Rarity */
      --error: #ff4d4d;
      /* Red for Error Messages */
      --claim-ready: #00ff88;
      /* Bright Green for Claim Button */
      --claim-ready-shadow: rgba(0, 255, 136, 0.5);
      /* Green Shadow for Claim Button */
      --warning: #ffcc00;
      /* Yellow for Warning Messages */
      --accept-color: #28a745;
      /* Dark Green for Accept Button */
      --decline-color: #dc3545;
      /* Dark Red for Decline Button */
      --success-msg-bg: rgba(0, 255, 136, 0.2);
      /* Light Green for Success Message Background */
      --error-msg-bg: rgba(255, 77, 77, 0.2);
      /* Light Red for Error Message Background */
      --info-msg-bg: rgba(0, 204, 255, 0.2);
      /* Light Cyan for Info Message Background */
    }

    /* --- Global Styles --- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }

    body {
      background: linear-gradient(to bottom, var(--background) 0%, #050505 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      overflow-x: hidden;
      line-height: 1.6;
      /* Add padding-bottom to prevent fixed bar from overlapping footer */
      padding-bottom: 70px;
      /* Adjust this value if the total-display height changes significantly */
    }

    /* --- Canvas Background --- */
    #backgroundCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.2;
      /* Subtler background */
      background-color: #000;
      /* Fallback */
    }

    /* --- Header & Navigation --- */
    header {
      background-color: var(--card-bg);
      padding: 1rem 2rem;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      color: var(--primary);
      font-size: 1.8rem;
      font-weight: bold;
      text-shadow: 0 0 8px rgba(0, 204, 255, 0.5);
      transition: color 0.3s ease;
    }

    .logo img {
      height: 40px;
      width: 40px;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0, 204, 255, 0.7);
    }

    .logo:hover {
      color: var(--secondary);
      text-shadow: 0 0 10px rgba(0, 255, 136, 0.7);
    }

    .nav-links {
      display: flex;
      gap: 1.5rem;
    }

    .nav-links a {
      color: var(--text);
      text-decoration: none;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .nav-links a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 204, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .nav-links a:hover::before {
      left: 100%;
    }

    .nav-links a:hover {
      background-color: var(--primary-dark);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.6);
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid var(--primary);
      box-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .user-avatar:hover {
      border-color: var(--secondary);
      box-shadow: 0 0 15px rgba(0, 255, 136, 0.7);
    }

    .user-menu {
      position: absolute;
      top: 55px;
      right: 0;
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      min-width: 180px;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
      padding: 0.5rem 0;
    }

    .user-menu.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .user-menu a {
      display: block;
      padding: 10px 15px;
      color: var(--text);
      text-decoration: none;
      transition: background-color 0.2s ease, color 0.2s ease;
      font-size: 0.95rem;
    }

    .user-menu a:hover {
      background-color: var(--primary-dark);
      color: white;
    }

    .mobile-menu-icon {
      display: none;
      font-size: 1.8rem;
      color: var(--primary);
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .mobile-menu-icon:hover {
      color: var(--secondary);
    }

    .mobile-nav-menu {
      display: none;
      /* Hidden by default */
      flex-direction: column;
      background-color: var(--card-bg);
      position: absolute;
      top: 60px;
      left: 0;
      width: 100%;
      z-index: 999;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid var(--border);
      padding-bottom: 1rem;
    }

    .mobile-nav-menu a {
      padding: 1rem 2rem;
      color: var(--text);
      text-decoration: none;
      font-size: 1.1rem;
      transition: background-color 0.2s ease, color 0.2s ease;
      text-align: center;
    }

    .mobile-nav-menu a:hover {
      background-color: var(--primary-dark);
      color: white;
    }

    /* --- Total Display Bar (Fixed at bottom) --- */
    .total-display-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: var(--card-bg);
      border-top: 1px solid var(--border);
      box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 10px 0;
      z-index: 1000;
      height: 60px;
      /* Fixed height for the bar */
    }

    .total-display-item {
      text-align: center;
      color: var(--text);
      font-size: 0.9rem;
    }

    .total-display-item i {
      color: var(--primary);
      font-size: 1.2rem;
      margin-bottom: 5px;
    }

    .total-display-item span {
      display: block;
      font-weight: bold;
      font-size: 1.1rem;
      color: var(--secondary);
    }

    /* --- Modals (General) --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      text-align: center;
      position: relative;
      transform: translateY(-50px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-close-button {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .modal-close-button:hover {
      color: var(--primary);
    }

    .modal-title {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 1.5rem;
      text-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
    }

    .modal-input {
      width: calc(100% - 20px);
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background-color: #0a0a0a;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .modal-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
    }

    .modal-button {
      background-color: var(--primary);
      color: #0a0a0a;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.4);
    }

    .modal-button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
    }

    .modal-link-button {
      display: inline-block;
      margin-top: 15px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.95rem;
      transition: color 0.2s ease;
    }

    .modal-link-button:hover {
      color: var(--primary);
    }

    /* --- Auth Modals Specific --- */
    #signup-modal-content p,
    #login-modal-content p {
      margin-bottom: 1rem;
    }

    #signup-modal-content .modal-link-button,
    #login-modal-content .modal-link-button {
      display: block;
      margin-top: 10px;
    }

    /* --- Home Section --- */
    #home-section {
      text-align: center;
      padding: 4rem 2rem;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .hero-title {
      font-size: 4.5rem;
      color: var(--primary);
      margin-bottom: 1rem;
      text-shadow: 0 0 20px rgba(0, 204, 255, 0.7);
      animation: neon-glow 1.5s ease-in-out infinite alternate;
      line-height: 1.1;
    }

    @keyframes neon-glow {
      from {
        text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary), 0 0 30px var(--primary), 0 0 40px var(--primary);
      }

      to {
        text-shadow: 0 0 15px var(--primary), 0 0 25px var(--primary-dark), 0 0 35px var(--primary), 0 0 45px var(--primary);
      }
    }

    .hero-subtitle {
      font-size: 1.8rem;
      color: var(--text-secondary);
      margin-bottom: 2.5rem;
      max-width: 800px;
    }

    .cta-buttons button {
      background-color: var(--secondary);
      color: #0a0a0a;
      padding: 15px 35px;
      border: none;
      border-radius: 10px;
      font-size: 1.3rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
      margin: 0 15px;
      box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .cta-buttons button:hover {
      background-color: var(--secondary-dark);
      transform: translateY(-3px);
      box-shadow: 0 0 30px rgba(0, 255, 136, 0.8);
    }

    .cta-buttons button:first-child {
      background-color: var(--primary);
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
    }

    .cta-buttons button:first-child:hover {
      background-color: var(--primary-dark);
      box-shadow: 0 0 30px rgba(0, 204, 255, 0.8);
    }

    /* --- Blog Section --- */
    #blog-section {
      padding: 3rem 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    #blog-section h2 {
      font-size: 3rem;
      color: var(--primary);
      text-align: center;
      margin-bottom: 2.5rem;
      text-shadow: 0 0 15px rgba(0, 204, 255, 0.6);
    }

    .blog-post-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
    }

    .blog-post-card {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .blog-post-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 204, 255, 0.5);
    }

    .blog-post-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-bottom: 1px solid var(--border);
    }

    .blog-post-content {
      padding: 1.5rem;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .blog-post-content h3 {
      font-size: 1.7rem;
      color: var(--primary);
      margin-bottom: 0.8rem;
    }

    .blog-post-meta {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .blog-post-meta span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .blog-post-meta i {
      color: var(--secondary);
    }

    .blog-post-content p {
      font-size: 1rem;
      color: var(--text);
      line-height: 1.6;
      flex-grow: 1;
    }

    .blog-post-actions {
      margin-top: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .blog-post-actions .read-more-btn {
      background-color: var(--primary);
      color: #0a0a0a;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease;
      flex-grow: 1;
      text-align: center;
    }

    .blog-post-actions .read-more-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .blog-post-actions .delete-btn {
      background-color: var(--error);
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }

    .blog-post-actions .delete-btn:hover {
      background-color: #cc3939;
      transform: translateY(-2px);
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 3rem;
    }

    .pagination button {
      background-color: var(--card-bg);
      color: var(--primary);
      border: 1px solid var(--border);
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }

    .pagination button:hover:not(:disabled) {
      background-color: var(--primary);
      color: #0a0a0a;
      transform: translateY(-2px);
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination span {
      font-size: 1.1rem;
      color: var(--text-secondary);
    }

    /* --- Daily Claim Section --- */
    #daily-claim-section {
      padding: 3rem 2rem;
      text-align: center;
      max-width: 800px;
      margin: 0 auto;
    }

    #daily-claim-section h2 {
      font-size: 3rem;
      color: var(--secondary);
      margin-bottom: 2.5rem;
      text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
    }

    .claim-card {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .claim-info {
      font-size: 1.2rem;
      color: var(--text);
      margin-bottom: 1.5rem;
    }

    .claim-info span {
      font-weight: bold;
      color: var(--primary);
    }

    #claim-button {
      background-color: var(--primary);
      color: #0a0a0a;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 1.4rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #claim-button.ready {
      background-color: var(--claim-ready);
      box-shadow: 0 0 20px var(--claim-ready-shadow);
    }

    #claim-button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 0 30px var(--claim-ready-shadow);
    }

    #claim-button:disabled {
      background-color: var(--text-secondary);
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
    }

    .countdown-timer {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--secondary);
      margin-top: 1rem;
      text-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
    }

    /* --- Shop Section --- */
    #shop-section {
      padding: 3rem 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    #shop-section h2 {
      font-size: 3rem;
      color: var(--primary);
      text-align: center;
      margin-bottom: 2.5rem;
      text-shadow: 0 0 15px rgba(0, 204, 255, 0.6);
    }

    .shop-item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
    }

    .shop-item-card {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      text-align: center;
      padding: 1.5rem;
      position: relative;
    }

    .shop-item-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 204, 255, 0.5);
    }

    .shop-item-card.sold-out {
      opacity: 0.7;
      pointer-events: none;
    }

    .shop-item-card.sold-out::after {
      content: "SOLD OUT";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-20deg);
      background-color: rgba(255, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1.8rem;
      font-weight: bold;
      z-index: 10;
      animation: pulse 1s infinite alternate;
    }

    @keyframes pulse {
      from {
        transform: translate(-50%, -50%) rotate(-20deg) scale(1);
        opacity: 0.8;
      }

      to {
        transform: translate(-50%, -50%) rotate(-20deg) scale(1.05);
        opacity: 1;
      }
    }

    .shop-item-card img {
      width: 100%;
      max-height: 180px;
      object-fit: contain;
      margin-bottom: 1rem;
      border-radius: 8px;
    }

    .shop-item-card h3 {
      font-size: 1.8rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .shop-item-card p {
      font-size: 1rem;
      color: var(--text);
      flex-grow: 1;
      margin-bottom: 1rem;
    }

    .shop-item-price {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--secondary);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .shop-item-price i {
      font-size: 1.3rem;
      color: var(--primary);
    }

    .buy-button {
      background-color: var(--primary);
      color: #0a0a0a;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.4);
    }

    .buy-button:hover:not(:disabled) {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
    }

    .buy-button:disabled {
      background-color: var(--text-secondary);
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
    }

    /* --- Admin Panel Section --- */
    #admin-panel-section {
      padding: 3rem 2rem;
      max-width: 900px;
      margin: 0 auto;
    }

    #admin-panel-section h2 {
      font-size: 3rem;
      color: var(--secondary);
      text-align: center;
      margin-bottom: 2.5rem;
      text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
    }

    .admin-card {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .admin-card h3 {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .admin-form-group {
      margin-bottom: 1.5rem;
    }

    .admin-form-group label {
      display: block;
      margin-bottom: 0.8rem;
      font-size: 1.1rem;
      color: var(--text-secondary);
      font-weight: bold;
    }

    .admin-input,
    .admin-textarea,
    .admin-select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background-color: #0a0a0a;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .admin-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .admin-input:focus,
    .admin-textarea:focus,
    .admin-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
    }

    .admin-button {
      background-color: var(--primary);
      color: #0a0a0a;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.4);
      width: 100%;
    }

    .admin-button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
    }

    .admin-button.danger {
      background-color: var(--error);
      box-shadow: 0 0 15px rgba(255, 77, 77, 0.4);
    }

    .admin-button.danger:hover {
      background-color: #cc3939;
      box-shadow: 0 0 20px rgba(255, 77, 77, 0.6);
    }

    .admin-blog-list,
    .admin-shop-list {
      margin-top: 2rem;
    }

    .admin-list-item {
      background-color: #111;
      border: 1px solid rgba(0, 204, 255, 0.1);
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .admin-list-item-content {
      flex-grow: 1;
    }

    .admin-list-item h4 {
      font-size: 1.3rem;
      color: var(--text);
      margin-bottom: 0.3rem;
    }

    .admin-list-item p {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .admin-list-item-actions {
      display: flex;
      gap: 10px;
    }

    .admin-list-item-actions button {
      background-color: var(--primary-dark);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
    }

    .admin-list-item-actions button:hover {
      background-color: var(--primary);
    }

    .admin-list-item-actions button.delete {
      background-color: var(--error);
    }

    .admin-list-item-actions button.delete:hover {
      background-color: #cc3939;
    }

    /* --- Notification Messages --- */
    .notification-container {
      position: fixed;
      top: 70px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 350px;
    }

    .notification-message {
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: fadeInRight 0.5s ease-out;
    }

    .notification-message.success {
      background-color: var(--success-msg-bg);
      border: 1px solid var(--claim-ready);
      color: var(--claim-ready);
    }

    .notification-message.error {
      background-color: var(--error-msg-bg);
      border: 1px solid var(--error);
      color: var(--error);
    }

    .notification-message.info {
      background-color: var(--info-msg-bg);
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .notification-message i {
      font-size: 1.3rem;
    }

    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* --- Spin the Wheel Section --- */
    #spin-the-wheel-section {
      padding: 3rem 2rem;
      max-width: 900px;
      margin: 0 auto;
      text-align: center;
    }

    #spin-the-wheel-section h2 {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 2.5rem;
      text-shadow: 0 0 15px rgba(0, 204, 255, 0.6);
    }

    .wheel-container {
      position: relative;
      width: 400px;
      height: 400px;
      margin: 0 auto 2rem;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(0, 204, 255, 0.7);
      border: 5px solid var(--primary);
    }

    #wheelCanvas {
      width: 100%;
      height: 100%;
      transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
      /* Easing for spin */
    }

    .wheel-pointer {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-bottom: 40px solid var(--error);
      z-index: 10;
    }

    .spin-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .spin-button {
      background-color: var(--secondary);
      color: #0a0a0a;
      padding: 15px 35px;
      border: none;
      border-radius: 10px;
      font-size: 1.3rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .spin-button:hover:not(:disabled) {
      background-color: var(--secondary-dark);
      transform: translateY(-3px);
      box-shadow: 0 0 30px rgba(0, 255, 136, 0.8);
    }

    .spin-button:disabled {
      background-color: var(--text-secondary);
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
    }

    .spin-cost {
      font-size: 1.1rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .spin-cost i {
      color: var(--primary);
    }

    .spin-cooldown {
      font-size: 1.2rem;
      color: var(--warning);
      font-weight: bold;
      margin-top: 1rem;
    }

    /* --- Trade Calculator Section --- */
    #trade-calculator-section {
      padding: 3rem 2rem;
      max-width: 900px;
      margin: 0 auto;
    }

    #trade-calculator-section h2 {
      font-size: 3rem;
      color: var(--primary);
      text-align: center;
      margin-bottom: 2.5rem;
      text-shadow: 0 0 15px rgba(0, 204, 255, 0.6);
    }

    .trade-calculator-container {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      padding: 2rem;
    }

    .trade-sides {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: space-around;
      margin-bottom: 2rem;
    }

    .trade-side {
      flex: 1;
      min-width: 280px;
      background-color: #111;
      border: 1px solid rgba(0, 204, 255, 0.15);
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
    }

    .trade-side h3 {
      font-size: 1.8rem;
      color: var(--secondary);
      margin-bottom: 1.5rem;
    }

    .trade-input-group {
      margin-bottom: 1rem;
    }

    .trade-input-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: bold;
    }

    .trade-input {
      width: calc(100% - 20px);
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background-color: #0a0a0a;
      color: var(--text);
      font-size: 1rem;
    }

    .trade-item-list {
      list-style: none;
      margin-top: 1.5rem;
      text-align: left;
      border-top: 1px dashed rgba(0, 204, 255, 0.2);
      padding-top: 1rem;
    }

    .trade-item-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dashed rgba(0, 204, 255, 0.1);
    }

    .trade-item-list li:last-child {
      border-bottom: none;
    }

    .trade-item-list li span {
      color: var(--text);
    }

    .trade-item-list li .remove-item-btn {
      background: none;
      border: none;
      color: var(--error);
      cursor: pointer;
      font-size: 1.1rem;
      transition: color 0.2s ease;
    }

    .trade-item-list li .remove-item-btn:hover {
      color: #ff0000;
    }

    .rarity-common {
      color: var(--common);
    }

    .rarity-uncommon {
      color: var(--uncommon);
    }

    .rarity-rare {
      color: var(--rare);
    }

    .rarity-legendary {
      color: var(--legendary);
      text-shadow: 0 0 5px rgba(255, 170, 0, 0.5);
    }

    .rarity-mythical {
      color: var(--mythical);
      text-shadow: 0 0 5px rgba(255, 0, 255, 0.5);
    }

    .trade-total-value {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--primary);
      margin-top: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .trade-total-value i {
      font-size: 1.2rem;
    }

    #calculate-trade-btn {
      background-color: var(--primary);
      color: #0a0a0a;
      padding: 15px 35px;
      border: none;
      border-radius: 10px;
      font-size: 1.3rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 1px;
      width: 100%;
      margin-top: 2rem;
    }

    #calculate-trade-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-3px);
      box-shadow: 0 0 30px rgba(0, 204, 255, 0.8);
    }

    .trade-result {
      margin-top: 2rem;
      padding: 1.5rem;
      border-radius: 10px;
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--text);
      text-align: center;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }

    .trade-result.fair {
      background-color: rgba(0, 255, 136, 0.2);
      border: 1px solid var(--secondary);
      color: var(--secondary);
    }

    .trade-result.unfair {
      background-color: rgba(255, 77, 77, 0.2);
      border: 1px solid var(--error);
      color: var(--error);
    }

    .trade-result.uneven {
      background-color: rgba(255, 204, 0, 0.2);
      border: 1px solid var(--warning);
      color: var(--warning);
    }

    /* --- Footer --- */
    footer {
      background-color: #050505;
      color: var(--text-secondary);
      text-align: center;
      padding: 1.5rem 2rem;
      font-size: 0.9rem;
      border-top: 1px solid var(--border);
    }

    footer p {
      margin-bottom: 0.5rem;
    }

    .social-links a {
      color: var(--text-secondary);
      font-size: 1.5rem;
      margin: 0 10px;
      transition: color 0.2s ease;
    }

    .social-links a:hover {
      color: var(--primary);
    }

    /* --- Responsive Design --- */
    @media (max-width: 900px) {
      .hero-title {
        font-size: 3.5rem;
      }

      .hero-subtitle {
        font-size: 1.5rem;
      }

      .cta-buttons button {
        padding: 12px 25px;
        font-size: 1.1rem;
        margin: 0 10px;
      }

      #blog-section h2,
      #daily-claim-section h2,
      #shop-section h2,
      #admin-panel-section h2,
      #spin-the-wheel-section h2,
      #trade-calculator-section h2 {
        font-size: 2.5rem;
      }

      .shop-item-card h3 {
        font-size: 1.6rem;
      }
    }

    @media (max-width: 768px) {
      .nav-links {
        display: none;
      }

      .mobile-menu-icon {
        display: block;
      }

      .mobile-nav-menu.active {
        display: flex;
      }

      header {
        padding: 1rem 1rem;
      }

      .hero-title {
        font-size: 2.8rem;
      }

      .hero-subtitle {
        font-size: 1.2rem;
      }

      .cta-buttons {
        flex-direction: column;
        gap: 15px;
      }

      .cta-buttons button {
        width: 80%;
        margin: 0 auto;
      }

      .blog-post-grid,
      .shop-item-grid,
      .trade-sides {
        grid-template-columns: 1fr;
      }

      .modal-content {
        width: 95%;
        padding: 1.5rem;
      }

      .total-display-bar {
        height: auto;
        padding: 8px 0;
        flex-wrap: wrap;
      }

      .total-display-item {
        flex-basis: 30%;
        margin: 5px 0;
        font-size: 0.8rem;
      }

      .total-display-item span {
        font-size: 1rem;
      }

      .notification-container {
        top: 60px;
        right: 10px;
        max-width: 90%;
      }

      .wheel-container {
        width: 300px;
        height: 300px;
      }
    }

    @media (max-width: 480px) {
      .hero-title {
        font-size: 2rem;
      }

      .hero-subtitle {
        font-size: 1rem;
      }

      #blog-section h2,
      #daily-claim-section h2,
      #shop-section h2,
      #admin-panel-section h2,
      #spin-the-wheel-section h2,
      #trade-calculator-section h2 {
        font-size: 2rem;
      }

      .modal-title {
        font-size: 1.8rem;
      }

      .modal-button,
      .admin-button {
        padding: 10px 20px;
        font-size: 1rem;
      }
    }
  </style>
</head>

<body>
  <canvas id="backgroundCanvas"></canvas>

  <header>
    <a href="#" class="logo">
      <img src="https://via.placeholder.com/40" alt="Shinigami Realm Logo">
      Shinigami Realm
    </a>
    <nav class="nav-links">
      <a href="#home-section">Home</a>
      <a href="#blog-section">Blog</a>
      <a href="#daily-claim-section">Daily Claim</a>
      <a href="#shop-section">Shop</a>
      <a href="#spin-the-wheel-section">Spin Wheel</a>
      <a href="#trade-calculator-section">Trade Calc</a>
    </nav>
    <div class="user-profile">
      <img id="user-avatar" class="user-avatar" src="https://via.placeholder.com/40" alt="User Avatar"
        style="display: none;">
      <div id="user-menu" class="user-menu">
        <span id="user-display-name"
          style="display: block; padding: 10px 15px; color: var(--primary); font-weight: bold; border-bottom: 1px solid var(--border);"></span>
        <a href="#" id="admin-panel-link" style="display: none;">Admin Panel</a>
        <a href="#" id="logout-button">Logout</a>
      </div>
      <i class="fas fa-bars mobile-menu-icon"></i>
    </div>
  </header>

  <nav class="mobile-nav-menu">
    <a href="#home-section">Home</a>
    <a href="#blog-section">Blog</a>
    <a href="#daily-claim-section">Daily Claim</a>
    <a href="#shop-section">Shop</a>
    <a href="#spin-the-wheel-section">Spin Wheel</a>
    <a href="#trade-calculator-section">Trade Calc</a>
  </nav>

  <div id="login-modal-overlay" class="modal-overlay">
    <div id="login-modal-content" class="modal-content">
      <button class="modal-close-button">&times;</button>
      <h2 class="modal-title">Login to Shinigami Realm</h2>
      <p id="login-message" style="color: var(--error); margin-bottom: 10px;"></p>
      <input type="email" id="login-email" class="modal-input" placeholder="Email" required>
      <input type="password" id="login-password" class="modal-input" placeholder="Password" required>
      <button id="login-submit" class="modal-button">Login</button>
      <a href="#" id="forgot-password-link" class="modal-link-button">Forgot Password?</a>
      <a href="#" id="show-signup-modal" class="modal-link-button">Don't have an account? Sign Up</a>
    </div>
  </div>

  <div id="signup-modal-overlay" class="modal-overlay">
    <div id="signup-modal-content" class="modal-content">
      <button class="modal-close-button">&times;</button>
      <h2 class="modal-title">Join Shinigami Realm</h2>
      <p id="signup-message" style="color: var(--error); margin-bottom: 10px;"></p>
      <input type="text" id="signup-username" class="modal-input" placeholder="Username" required>
      <input type="email" id="signup-email" class="modal-input" placeholder="Email" required>
      <input type="password" id="signup-password" class="modal-input" placeholder="Password" required>
      <input type="password" id="signup-confirm-password" class="modal-input" placeholder="Confirm Password" required>
      <button id="signup-submit" class="modal-button">Sign Up</button>
      <a href="#" id="show-login-modal" class="modal-link-button">Already have an account? Login</a>
    </div>
  </div>

  <div id="reset-password-modal-overlay" class="modal-overlay">
    <div id="reset-password-modal-content" class="modal-content">
      <button class="modal-close-button">&times;</button>
      <h2 class="modal-title">Reset Password</h2>
      <p id="reset-password-message" style="color: var(--error); margin-bottom: 10px;"></p>
      <input type="email" id="reset-email" class="modal-input" placeholder="Enter your email" required>
      <button id="reset-password-submit" class="modal-button">Send Reset Link</button>
      <a href="#" id="back-to-login-from-reset" class="modal-link-button">Back to Login</a>
    </div>
  </div>

  <main>
    <section id="home-section">
      <h1 class="hero-title">Shinigami Realm</h1>
      <p class="hero-subtitle">Unleash your inner Shinigami. Explore, battle, and collect powerful items in a world beyond
        life and death.</p>
      <div class="cta-buttons">
        <button id="explore-button">Explore the Realm</button>
        <button id="join-now-button">Join Now</button>
      </div>
    </section>

    <section id="blog-section">
      <h2>Latest News from the Soul Society</h2>
      <div class="blog-post-grid" id="blog-post-grid">
        </div>
      <div class="pagination">
        <button id="prev-page-button" disabled>Previous</button>
        <span id="page-info">Page 1</span>
        <button id="next-page-button">Next</button>
      </div>
    </section>

    <section id="daily-claim-section" style="display: none;">
      <h2>Daily Realm Coin Claim</h2>
      <div class="claim-card">
        <p class="claim-info">Claim your <span>100 Realm Coins</span> daily!</p>
        <button id="claim-button">Claim Now</button>
        <p id="countdown-timer" class="countdown-timer" style="display: none;"></p>
        <p id="claim-status" style="margin-top: 10px; color: var(--text-secondary);"></p>
      </div>
    </section>

    <section id="shop-section" style="display: none;">
      <h2>Shinigami Emporium</h2>
      <div class="shop-item-grid" id="shop-item-grid">
        </div>
    </section>

    <section id="spin-the-wheel-section" style="display: none;">
      <h2>Spin the Wheel of Fortune</h2>
      <div class="wheel-container">
        <canvas id="wheelCanvas" width="400" height="400"></canvas>
        <div class="wheel-pointer"></div>
      </div>
      <div class="spin-controls">
        <p id="spin-reward-info" style="color: var(--secondary); font-size: 1.1rem;"></p>
        <button id="spin-button" class="spin-button">Spin for Free</button>
        <p id="spin-cost" class="spin-cost">Next Spin: <i class="fas fa-coins"></i> <span
            id="current-spin-cost">100</span></p>
        <p id="spin-cooldown" class="spin-cooldown" style="display: none;"></p>
      </div>
    </section>

    <section id="trade-calculator-section" style="display: none;">
      <h2>Trade Value Calculator</h2>
      <div class="trade-calculator-container">
        <div class="trade-sides">
          <div class="trade-side">
            <h3>Your Offer</h3>
            <div class="trade-input-group">
              <label for="your-item-name">Item Name:</label>
              <input type="text" id="your-item-name" class="trade-input" placeholder="e.g., Kido Scroll">
            </div>
            <div class="trade-input-group">
              <label for="your-item-value">Item Value (Coins):</label>
              <input type="number" id="your-item-value" class="trade-input" value="0">
            </div>
            <div class="trade-input-group">
              <label for="your-item-rarity">Rarity:</label>
              <select id="your-item-rarity" class="trade-input">
                <option value="common">Common</option>
                <option value="uncommon">Uncommon</option>
                <option value="rare">Rare</option>
                <option value="legendary">Legendary</option>
                <option value="mythical">Mythical</option>
              </select>
            </div>
            <button id="add-your-item-btn" class="modal-button"
              style="width: auto; padding: 10px 20px;">Add Item</button>
            <ul id="your-items-list" class="trade-item-list"></ul>
            <p class="trade-total-value">Total: <i class="fas fa-coins"></i> <span id="your-total-value">0</span></p>
          </div>

          <div class="trade-side">
            <h3>Their Offer</h3>
            <div class="trade-input-group">
              <label for="their-item-name">Item Name:</label>
              <input type="text" id="their-item-name" class="trade-input" placeholder="e.g., Bankai Fragment">
            </div>
            <div class="trade-input-group">
              <label for="their-item-value">Item Value (Coins):</label>
              <input type="number" id="their-item-value" class="trade-input" value="0">
            </div>
            <div class="trade-input-group">
              <label for="their-item-rarity">Rarity:</label>
              <select id="their-item-rarity" class="trade-input">
                <option value="common">Common</option>
                <option value="uncommon">Uncommon</option>
                <option value="rare">Rare</option>
                <option value="legendary">Legendary</option>
                <option value="mythical">Mythical</option>
              </select>
            </div>
            <button id="add-their-item-btn" class="modal-button"
              style="width: auto; padding: 10px 20px;">Add Item</button>
            <ul id="their-items-list" class="trade-item-list"></ul>
            <p class="trade-total-value">Total: <i class="fas fa-coins"></i> <span id="their-total-value">0</span></p>
          </div>
        </div>
        <button id="calculate-trade-btn">Calculate Trade Fairness</button>
        <div id="trade-result" class="trade-result" style="display: none;"></div>
      </div>
    </section>

    <section id="admin-panel-section" style="display: none;">
      <h2>Admin Control Panel</h2>

      <div class="admin-card">
        <h3>Add New Blog Post</h3>
        <div class="admin-form-group">
          <label for="blog-title">Title:</label>
          <input type="text" id="blog-title" class="admin-input" required>
        </div>
        <div class="admin-form-group">
          <label for="blog-image-url">Image URL:</label>
          <input type="url" id="blog-image-url" class="admin-input" placeholder="e.g., https://example.com/image.jpg">
        </div>
        <div class="admin-form-group">
          <label for="blog-content">Content:</label>
          <textarea id="blog-content" class="admin-textarea" rows="5" required></textarea>
        </div>
        <button id="add-blog-post-button" class="admin-button">Add Blog Post</button>
      </div>

      <div class="admin-card">
        <h3>Manage Blog Posts</h3>
        <div id="admin-blog-list" class="admin-blog-list">
          </div>
      </div>

      <div class="admin-card">
        <h3>Add New Shop Item</h3>
        <div class="admin-form-group">
          <label for="shop-item-name">Item Name:</label>
          <input type="text" id="shop-item-name" class="admin-input" required>
        </div>
        <div class="admin-form-group">
          <label for="shop-item-description">Description:</label>
          <textarea id="shop-item-description" class="admin-textarea" rows="3" required></textarea>
        </div>
        <div class="admin-form-group">
          <label for="shop-item-image-url">Image URL:</label>
          <input type="url" id="shop-item-image-url" class="admin-input"
            placeholder="e.g., https://example.com/item.png">
        </div>
        <div class="admin-form-group">
          <label for="shop-item-price">Price (Coins):</label>
          <input type="number" id="shop-item-price" class="admin-input" required>
        </div>
        <div class="admin-form-group">
          <label for="shop-item-stock">Stock:</label>
          <input type="number" id="shop-item-stock" class="admin-input" value="1" required>
        </div>
        <button id="add-shop-item-button" class="admin-button">Add Shop Item</button>
      </div>

      <div class="admin-card">
        <h3>Manage Shop Items</h3>
        <div id="admin-shop-list" class="admin-shop-list">
          </div>
      </div>

      <div class="admin-card">
        <h3>Send Realm Coins to a User</h3>
        <p style="color: var(--info-msg-bg); margin-bottom: 1rem;">
          <i class="fas fa-info-circle"></i> This action will add Realm Coins to a specific user's account.
        </p>
        <div class="admin-form-group">
          <label for="admin-recipient-display-name">Recipient Display Name:</label>
          <input type="text" id="admin-recipient-display-name" class="admin-input" placeholder="Enter username"
            required>
        </div>
        <div class="admin-form-group">
          <label for="admin-send-coins-amount-input">Amount to Send:</label>
          <input type="number" id="admin-send-coins-amount-input" class="admin-input" value="100" min="1" required>
        </div>
        <button id="admin-send-coins-to-user-button" class="admin-button">Send Coins to User</button>
      </div>

      <div class="admin-card">
        <h3>Other Admin Tools</h3>
        <p style="color: var(--text-secondary);">More administrative features can be added here.</p>
        </div>
    </section>
  </main>

  <div class="notification-container" id="notification-container"></div>

  <div class="total-display-bar">
    <div class="total-display-item">
      <i class="fas fa-coins"></i>
      <span id="total-coins">0</span>
    </div>
    <div class="total-display-item">
      <i class="fas fa-gem"></i>
      <span id="total-gems">0</span>
    </div>
    <div class="total-display-item">
      <i class="fas fa-scroll"></i>
      <span id="total-items">0</span>
    </div>
  </div>

  <footer>
    <p>&copy; 2023 Shinigami Realm. All rights reserved.</p>
    <div class="social-links">
      <a href="#"><i class="fab fa-facebook"></i></a>
      <a href="#"><i class="fab fa-twitter"></i></a>
      <a href="#"><i class="fab fa-instagram"></i></a>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      sendPasswordResetEmail,
      updateProfile,
      signInWithCustomToken, // Added for Canvas environment
      signInAnonymously // Added for Canvas environment fallback
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      collection,
      query,
      orderBy,
      limit,
      startAfter,
      endBefore,
      limitToLast,
      deleteDoc,
      increment,
      getDocs,
      serverTimestamp,
      runTransaction,
      where
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // Your Firebase configuration
    // Use the global variable __firebase_config provided by the Canvas environment
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserId = null;
    let isAdmin = false;
    let lastVisibleBlogPost = null;
    let firstVisibleBlogPost = null;
    let currentPage = 1;
    const POSTS_PER_PAGE = 3; // Number of blog posts per page

    // --- Utility Functions ---

    // Function to display notification messages
    function displayMessage(message, type = 'info', duration = 5000) {
      const container = document.getElementById('notification-container');
      const messageElement = document.createElement('div');
      messageElement.classList.add('notification-message', type);
      messageElement.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i> <span>${message}</span>`;
      container.appendChild(messageElement);

      setTimeout(() => {
        messageElement.remove();
      }, duration);
    }

    // Function to format time for cooldowns
    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor((totalSeconds % 86400) / 3600); // Max 23 hours
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;

      // Only show hours if greater than 0
      if (hours > 0) {
        return [hours, minutes, seconds]
          .map(unit => String(unit).padStart(2, '0'))
          .join(':');
      } else {
        return [minutes, seconds]
          .map(unit => String(unit).padStart(2, '0'))
          .join(':');
      }
    }

    // --- Modals (Login/Signup/Reset) ---
    const loginModalOverlay = document.getElementById('login-modal-overlay');
    const loginModalCloseBtn = loginModalOverlay.querySelector('.modal-close-button');
    const loginEmailInput = document.getElementById('login-email');
    const loginPasswordInput = document.getElementById('login-password');
    const loginSubmitButton = document.getElementById('login-submit');
    const loginMessage = document.getElementById('login-message');
    const showSignupModalLink = document.getElementById('show-signup-modal');
    const forgotPasswordLink = document.getElementById('forgot-password-link');

    const signupModalOverlay = document.getElementById('signup-modal-overlay');
    const signupModalCloseBtn = signupModalOverlay.querySelector('.modal-close-button');
    const signupUsernameInput = document.getElementById('signup-username');
    const signupEmailInput = document.getElementById('signup-email');
    const signupPasswordInput = document.getElementById('signup-password');
    const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
    const signupSubmitButton = document.getElementById('signup-submit');
    const signupMessage = document.getElementById('signup-message');
    const showLoginModalLink = document.getElementById('show-login-modal');

    const resetPasswordModalOverlay = document.getElementById('reset-password-modal-overlay');
    const resetPasswordModalCloseBtn = resetPasswordModalOverlay.querySelector('.modal-close-button');
    const resetEmailInput = document.getElementById('reset-email');
    const resetPasswordSubmitButton = document.getElementById('reset-password-submit');
    const resetPasswordMessage = document.getElementById('reset-password-message');
    const backToLoginFromResetLink = document.getElementById('back-to-login-from-reset');

    function openModal(modalOverlay) {
      modalOverlay.classList.add('active');
    }

    function closeModal(modalOverlay) {
      modalOverlay.classList.remove('active');
      // Clear messages and inputs when closing
      if (modalOverlay === loginModalOverlay) {
        loginMessage.textContent = '';
        loginEmailInput.value = '';
        loginPasswordInput.value = '';
      } else if (modalOverlay === signupModalOverlay) {
        signupMessage.textContent = '';
        signupUsernameInput.value = '';
        signupEmailInput.value = '';
        signupPasswordInput.value = '';
        signupConfirmPasswordInput.value = '';
      } else if (modalOverlay === resetPasswordModalOverlay) {
        resetPasswordMessage.textContent = '';
        resetEmailInput.value = '';
      }
    }

    loginModalCloseBtn.addEventListener('click', () => closeModal(loginModalOverlay));
    signupModalCloseBtn.addEventListener('click', () => closeModal(signupModalOverlay));
    resetPasswordModalCloseBtn.addEventListener('click', () => closeModal(resetPasswordModalOverlay));

    // Close modal if overlay is clicked
    loginModalOverlay.addEventListener('click', (e) => {
      if (e.target === loginModalOverlay) closeModal(loginModalOverlay);
    });
    signupModalOverlay.addEventListener('click', (e) => {
      if (e.target === signupModalOverlay) closeModal(signupModalOverlay);
    });
    resetPasswordModalOverlay.addEventListener('click', (e) => {
      if (e.target === resetPasswordModalOverlay) closeModal(resetPasswordModalOverlay);
    });

    // Toggle between login and signup modals
    showSignupModalLink.addEventListener('click', (e) => {
      e.preventDefault();
      closeModal(loginModalOverlay);
      openModal(signupModalOverlay);
    });

    showLoginModalLink.addEventListener('click', (e) => {
      e.preventDefault();
      closeModal(signupModalOverlay);
      openModal(loginModalOverlay);
    });

    forgotPasswordLink.addEventListener('click', (e) => {
      e.preventDefault();
      closeModal(loginModalOverlay);
      openModal(resetPasswordModalOverlay);
    });

    backToLoginFromResetLink.addEventListener('click', (e) => {
      e.preventDefault();
      closeModal(resetPasswordModalOverlay);
      openModal(loginModalOverlay);
    });

    // --- Authentication ---
    loginSubmitButton.addEventListener('click', async () => {
      const email = loginEmailInput.value;
      const password = loginPasswordInput.value;
      loginMessage.textContent = ''; // Clear previous messages

      if (!email || !password) {
        loginMessage.textContent = 'Please enter both email and password.';
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        displayMessage('Logged in successfully!', 'success');
        closeModal(loginModalOverlay);
      } catch (error) {
        console.error("Login error:", error);
        switch (error.code) {
          case 'auth/invalid-email':
            loginMessage.textContent = 'Invalid email address format.';
            break;
          case 'auth/user-not-found':
            loginMessage.textContent = 'No user found with this email.';
            break;
          case 'auth/wrong-password':
            loginMessage.textContent = 'Incorrect password.';
            break;
          case 'auth/invalid-credential': // Generic error for wrong email/password in newer Firebase versions
            loginMessage.textContent = 'Invalid email or password.';
            break;
          default:
            loginMessage.textContent = 'Login failed: ' + error.message;
            break;
        }
      }
    });

    signupSubmitButton.addEventListener('click', async () => {
      const username = signupUsernameInput.value;
      const email = signupEmailInput.value;
      const password = signupPasswordInput.value;
      const confirmPassword = signupConfirmPasswordInput.value;
      signupMessage.textContent = ''; // Clear previous messages

      if (!username || !email || !password || !confirmPassword) {
        signupMessage.textContent = 'Please fill in all fields.';
        return;
      }
      if (password.length < 6) {
        signupMessage.textContent = 'Password should be at least 6 characters.';
        return;
      }
      if (password !== confirmPassword) {
        signupMessage.textContent = 'Passwords do not match.';
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Set display name
        await updateProfile(user, {
          displayName: username,
          photoURL: `https://api.multiavatar.com/${username}.png?apikey=a539097e88c0494584` // Dynamic avatar
        });

        // Create user document in Firestore
        await setDoc(doc(db, "users", user.uid), {
          username: username,
          email: email,
          createdAt: serverTimestamp(),
          realmCoins: 0, // Initial coins
          totalGems: 0,
          totalItems: 0,
          isAdmin: false, // Default to false
          lastClaimed: null, // For daily claim
          lastFreeSpin: null, // For free spin
          lastPaidSpin: null, // For paid spin
          inventory: [], // User's inventory
          spinWheelCooldowns: {
            freeSpin: null,
            paidSpin: null
          }
        });

        displayMessage('Account created successfully! Welcome to Shinigami Realm!', 'success');
        closeModal(signupModalOverlay);
      } catch (error) {
        console.error("Signup error:", error);
        switch (error.code) {
          case 'auth/email-already-in-use':
            signupMessage.textContent = 'This email is already registered.';
            break;
          case 'auth/invalid-email':
            signupMessage.textContent = 'Invalid email address format.';
            break;
          case 'auth/weak-password':
            signupMessage.textContent = 'Password is too weak. It should be at least 6 characters.';
            break;
          default:
            signupMessage.textContent = 'Signup failed: ' + error.message;
            break;
        }
      }
    });

    resetPasswordSubmitButton.addEventListener('click', async () => {
      const email = resetEmailInput.value;
      resetPasswordMessage.textContent = '';

      if (!email) {
        resetPasswordMessage.textContent = 'Please enter your email address.';
        return;
      }

      try {
        await sendPasswordResetEmail(auth, email);
        displayMessage('Password reset email sent! Check your inbox.', 'success');
        closeModal(resetPasswordModalOverlay);
      } catch (error) {
        console.error("Password reset error:", error);
        switch (error.code) {
          case 'auth/invalid-email':
            resetPasswordMessage.textContent = 'Invalid email address format.';
            break;
          case 'auth/user-not-found':
            resetPasswordMessage.textContent = 'No user found with this email.';
            break;
          default:
            resetPasswordMessage.textContent = 'Password reset failed: ' + error.message;
            break;
        }
      }
    });

    document.getElementById('logout-button').addEventListener('click', async () => {
      try {
        await signOut(auth);
        displayMessage('Logged out successfully.', 'info');
        // UI updates handled by onAuthStateChanged
      } catch (error) {
        console.error("Logout error:", error);
        displayMessage('Error logging out: ' + error.message, 'error');
      }
    });

    // --- Auth State Changes ---
    const userAvatar = document.getElementById('user-avatar');
    const userMenu = document.getElementById('user-menu');
    const userDisplayName = document.getElementById('user-display-name');
    const adminPanelLink = document.getElementById('admin-panel-link');
    const homeSection = document.getElementById('home-section');
    const dailyClaimSection = document.getElementById('daily-claim-section');
    const shopSection = document.getElementById('shop-section');
    const adminPanelSection = document.getElementById('admin-panel-section');
    const spinTheWheelSection = document.getElementById('spin-the-wheel-section');
    const tradeCalculatorSection = document.getElementById('trade-calculator-section');
    const exploreButton = document.getElementById('explore-button');
    const joinNowButton = document.getElementById('join-now-button');

    // Hide all sections by default
    function hideAllSections() {
      homeSection.style.display = 'none';
      dailyClaimSection.style.display = 'none';
      shopSection.style.display = 'none';
      adminPanelSection.style.display = 'none';
      spinTheWheelSection.style.display = 'none';
      tradeCalculatorSection.style.display = 'none';
      document.getElementById('blog-section').style.display = 'none';
    }

    function showSection(sectionElement) {
      hideAllSections();
      sectionElement.style.display = 'block';
    }

    // Initial display based on hash
    function handleHashChange() {
      const hash = window.location.hash;
      if (hash === '#blog-section') showSection(document.getElementById('blog-section'));
      else if (hash === '#daily-claim-section') showSection(dailyClaimSection);
      else if (hash === '#shop-section') showSection(shopSection);
      else if (hash === '#admin-panel-section') showSection(adminPanelSection);
      else if (hash === '#spin-the-wheel-section') showSection(spinTheWheelSection);
      else if (hash === '#trade-calculator-section') showSection(tradeCalculatorSection);
      else showSection(homeSection); // Default to home
    }

    // Call on load and on hash change
    window.addEventListener('hashchange', handleHashChange);

    // Firebase Authentication for Canvas environment
    async function initializeAuthAndFirestore() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Signed in with custom token.");
            } else {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            }
        } catch (error) {
            console.error("Firebase authentication error:", error);
            displayMessage("Authentication failed. Please refresh the page.", "error");
        }
    }

    // Call this function once when the app loads
    initializeAuthAndFirestore();


    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserId = user.uid;
        userAvatar.src = user.photoURL || 'https://via.placeholder.com/40'; // Fallback avatar
        userAvatar.style.display = 'block';
        userDisplayName.textContent = user.displayName || 'Guest';

        // Fetch user data from Firestore
        const userDocRef = doc(db, 'users', user.uid);
        const userDocSnap = await getDoc(userDocRef);

        if (userDocSnap.exists()) {
          const userData = userDocSnap.data();
          isAdmin = userData.isAdmin || false; // Set admin status

          document.getElementById('total-coins').textContent = userData.realmCoins.toLocaleString();
          document.getElementById('total-gems').textContent = userData.totalGems.toLocaleString();
          document.getElementById('total-items').textContent = userData.inventory.length.toLocaleString();

          // Show/hide sections based on login status and admin status
          exploreButton.style.display = 'none';
          joinNowButton.style.display = 'none';
          dailyClaimSection.style.display = 'block';
          shopSection.style.display = 'block';
          spinTheWheelSection.style.display = 'block';
          tradeCalculatorSection.style.display = 'block';
          document.getElementById('blog-section').style.display = 'block'; // Always show blog

          if (isAdmin) {
            adminPanelLink.style.display = 'block';
            adminPanelSection.style.display = 'block'; // Initially show if admin
          } else {
            adminPanelLink.style.display = 'none';
            adminPanelSection.style.display = 'none';
          }
          // Ensure correct section is shown based on hash after login
          handleHashChange();

          // Initialize daily claim and spin wheel UI after user data is loaded
          setupDailyClaim();
          setupSpinTheWheel();
        } else {
          // If user doc doesn't exist (shouldn't happen with new sign-up flow), force logout or create doc
          console.warn("User document not found for:", user.uid);
          displayMessage("User data missing. Please try logging in again.", "error");
          await signOut(auth); // Force logout
        }

      } else {
        currentUserId = null;
        isAdmin = false;
        userAvatar.style.display = 'none';
        userDisplayName.textContent = '';
        adminPanelLink.style.display = 'none';

        // Show login/signup buttons and hide user-specific sections
        exploreButton.style.display = 'inline-block';
        joinNowButton.style.display = 'inline-block';
        document.getElementById('total-coins').textContent = '0';
        document.getElementById('total-gems').textContent = '0';
        document.getElementById('total-items').textContent = '0';

        // Force home section and hide others when logged out
        hideAllSections();
        homeSection.style.display = 'block';
        // Open login modal automatically if not on home/blog
        if (window.location.hash && window.location.hash !== '#home-section' && window.location.hash !== '#blog-section') {
          openModal(loginModalOverlay);
        }
      }
      setupBlogPosts(); // Always load blog posts
      setupShopItems(); // Always load shop items
      renderAdminBlogPosts(); // Always attempt to render for admin
      renderAdminShopItems(); // Always attempt to render for admin
    });

    userAvatar.addEventListener('click', () => {
      if (currentUserId) {
        userMenu.classList.toggle('active');
      } else {
        openModal(loginModalOverlay);
      }
    });

    // Close user menu if clicked outside
    document.addEventListener('click', (e) => {
      if (!userAvatar.contains(e.target) && !userMenu.contains(e.target)) {
        userMenu.classList.remove('active');
      }
    });

    // Mobile menu toggle
    const mobileMenuIcon = document.querySelector('.mobile-menu-icon');
    const mobileNavMenu = document.querySelector('.mobile-nav-menu');

    mobileMenuIcon.addEventListener('click', () => {
      mobileNavMenu.classList.toggle('active');
    });

    // Close mobile menu when a link is clicked
    mobileNavMenu.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        mobileNavMenu.classList.remove('active');
      });
    });

    // Handle navigation clicks for sections
    document.querySelectorAll('nav a').forEach(link => {
      link.addEventListener('click', (e) => {
        const targetId = link.getAttribute('href').substring(1);
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          if (!currentUserId && (targetId === 'daily-claim-section' || targetId === 'shop-section' || targetId === 'admin-panel-section' || targetId === 'spin-the-wheel-section' || targetId === 'trade-calculator-section')) {
            e.preventDefault(); // Prevent hash change
            openModal(loginModalOverlay);
            displayMessage('Please log in to access this section.', 'info');
            return;
          }
          if (targetId === 'admin-panel-section' && !isAdmin) {
            e.preventDefault(); // Prevent hash change
            displayMessage('You do not have permission to access the Admin Panel.', 'error');
            return;
          }
          showSection(targetSection);
        }
      });
    });

    // Initial check for sections to display
    window.addEventListener('load', handleHashChange);

    // Initial CTA button actions
    exploreButton.addEventListener('click', (e) => {
      e.preventDefault();
      window.location.hash = '#blog-section';
    });

    joinNowButton.addEventListener('click', (e) => {
      e.preventDefault();
      openModal(signupModalOverlay);
    });

    // --- Blog Post Management ---
    const blogPostGrid = document.getElementById('blog-post-grid');
    const prevPageButton = document.getElementById('prev-page-button');
    const nextPageButton = document.getElementById('next-page-button');
    const pageInfo = document.getElementById('page-info');

    async function setupBlogPosts() {
      await fetchBlogPosts();
    }

    async function fetchBlogPosts(direction = 'next') {
      const blogPostsRef = collection(db, 'blogPosts');
      let q;

      if (direction === 'next' && lastVisibleBlogPost) {
        q = query(blogPostsRef, orderBy('createdAt', 'desc'), startAfter(lastVisibleBlogPost), limit(POSTS_PER_PAGE));
      } else if (direction === 'prev' && firstVisibleBlogPost) {
        q = query(blogPostsRef, orderBy('createdAt', 'desc'), endBefore(firstVisibleBlogPost), limitToLast(POSTS_PER_PAGE));
      } else {
        q = query(blogPostsRef, orderBy('createdAt', 'desc'), limit(POSTS_PER_PAGE));
      }

      try {
        const documentSnapshots = await getDocs(q);
        if (documentSnapshots.empty) {
          displayMessage('No more blog posts.', 'info');
          return;
        }

        blogPostGrid.innerHTML = ''; // Clear current posts
        documentSnapshots.forEach(doc => {
          const post = doc.data();
          const postId = doc.id;
          const postElement = document.createElement('div');
          postElement.classList.add('blog-post-card');
          postElement.innerHTML = `
            ${post.imageUrl ? `<img src="${post.imageUrl}" alt="${post.title}">` : ''}
            <div class="blog-post-content">
              <h3>${post.title}</h3>
              <div class="blog-post-meta">
                <span><i class="far fa-calendar-alt"></i> ${post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'N/A'}</span>
                <span><i class="fas fa-user-edit"></i> ${post.author || 'Admin'}</span>
              </div>
              <p>${post.content.substring(0, 150)}...</p>
              <div class="blog-post-actions">
                  <button class="read-more-btn" data-id="${postId}">Read More</button>
                  ${isAdmin ? `<button class="delete-btn" data-id="${postId}"><i class="fas fa-trash"></i> Delete</button>` : ''}
              </div>
            </div>
          `;
          blogPostGrid.appendChild(postElement);
        });

        lastVisibleBlogPost = documentSnapshots.docs[documentSnapshots.docs.length - 1];
        firstVisibleBlogPost = documentSnapshots.docs[0];

        // Update pagination buttons
        prevPageButton.disabled = documentSnapshots.docs.length < POSTS_PER_PAGE || (direction === 'prev' && documentSnapshots.docs.length === 0);
        nextPageButton.disabled = documentSnapshots.docs.length < POSTS_PER_PAGE;

        // Check if there are truly no more next pages
        const nextQuery = query(blogPostsRef, orderBy('createdAt', 'desc'), startAfter(lastVisibleBlogPost), limit(1));
        const nextSnapshot = await getDocs(nextQuery);
        nextPageButton.disabled = nextSnapshot.empty;

        // Check if there are truly no more previous pages
        const prevQuery = query(blogPostsRef, orderBy('createdAt', 'desc'), endBefore(firstVisibleBlogPost), limit(1));
        const prevSnapshot = await getDocs(prevQuery);
        prevPageButton.disabled = prevSnapshot.empty;

        if (direction === 'next') {
          currentPage++;
        } else if (direction === 'prev') {
          currentPage--;
        }
        if (documentSnapshots.empty && currentPage > 1) { // If no posts on "next" page, revert page number
          currentPage--;
        }
        if (currentPage < 1) currentPage = 1; // Ensure page number doesn't go below 1
        pageInfo.textContent = `Page ${currentPage}`;

        // Re-attach event listeners for dynamically added buttons
        document.querySelectorAll('.read-more-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            const postId = e.target.dataset.id;
            // In a real app, you'd open a modal or navigate to a full blog post page
            displayMessage(`Reading post: ${postId} (Feature not fully implemented)`, 'info');
          });
        });
        document.querySelectorAll('.delete-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const postId = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this blog post?')) {
              await deleteBlogPost(postId);
            }
          });
        });

      } catch (error) {
        console.error("Error fetching blog posts:", error);
        displayMessage('Error loading blog posts.', 'error');
      }
    }

    prevPageButton.addEventListener('click', () => fetchBlogPosts('prev'));
    nextPageButton.addEventListener('click', () => fetchBlogPosts('next'));

    // Admin Add Blog Post
    const addBlogPostButton = document.getElementById('add-blog-post-button');
    const blogTitleInput = document.getElementById('blog-title');
    const blogImageUrlInput = document.getElementById('blog-image-url');
    const blogContentInput = document.getElementById('blog-content');

    addBlogPostButton.addEventListener('click', async () => {
      const title = blogTitleInput.value.trim();
      const imageUrl = blogImageUrlInput.value.trim();
      const content = blogContentInput.value.trim();

      if (!title || !content) {
        displayMessage('Blog title and content are required.', 'error');
        return;
      }

      try {
        await setDoc(doc(collection(db, 'blogPosts')), {
          title: title,
          imageUrl: imageUrl,
          content: content,
          author: auth.currentUser.displayName || 'Admin',
          createdAt: serverTimestamp()
        });
        displayMessage('Blog post added successfully!', 'success');
        blogTitleInput.value = '';
        blogImageUrlInput.value = '';
        blogContentInput.value = '';
        await fetchBlogPosts(); // Refresh blog list
        renderAdminBlogPosts(); // Refresh admin list
      } catch (error) {
        console.error("Error adding blog post:", error);
        displayMessage('Failed to add blog post: ' + error.message, 'error');
      }
    });

    // Admin Delete Blog Post
    async function deleteBlogPost(postId) {
      try {
        await deleteDoc(doc(db, 'blogPosts', postId));
        displayMessage('Blog post deleted successfully!', 'success');
        await fetchBlogPosts(); // Refresh blog list
        renderAdminBlogPosts(); // Refresh admin list
      } catch (error) {
        console.error("Error deleting blog post:", error);
        displayMessage('Failed to delete blog post: ' + error.message, 'error');
      }
    }

    // Render Admin Blog Posts for management
    const adminBlogList = document.getElementById('admin-blog-list');
    async function renderAdminBlogPosts() {
      if (!isAdmin) {
        adminBlogList.innerHTML = '<p style="color: var(--warning);">You are not authorized to view this content.</p>';
        return;
      }
      try {
        const q = query(collection(db, 'blogPosts'), orderBy('createdAt', 'desc'));
        const querySnapshot = await getDocs(q);
        adminBlogList.innerHTML = ''; // Clear current list

        if (querySnapshot.empty) {
          adminBlogList.innerHTML = '<p>No blog posts found.</p>';
          return;
        }

        querySnapshot.forEach(doc => {
          const post = doc.data();
          const postId = doc.id;
          const listItem = document.createElement('div');
          listItem.classList.add('admin-list-item');
          listItem.innerHTML = `
            <div class="admin-list-item-content">
              <h4>${post.title}</h4>
              <p>${new Date(post.createdAt.toDate()).toLocaleDateString()} by ${post.author}</p>
            </div>
            <div class="admin-list-item-actions">
              <button class="delete" data-id="${postId}"><i class="fas fa-trash"></i> Delete</button>
            </div>
          `;
          adminBlogList.appendChild(listItem);
        });

        // Attach delete event listeners for admin list
        adminBlogList.querySelectorAll('.delete').forEach(button => {
          button.addEventListener('click', async (e) => {
            const postId = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this blog post?')) {
              await deleteBlogPost(postId);
            }
          });
        });
      } catch (error) {
        console.error("Error rendering admin blog posts:", error);
        displayMessage('Error loading admin blog list.', 'error');
      }
    }

    // --- Daily Claim System ---
    const claimButton = document.getElementById('claim-button');
    const countdownTimerDisplay = document.getElementById('countdown-timer');
    const claimStatusDisplay = document.getElementById('claim-status');
    const CLAIM_INTERVAL_MS = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
    let countdownInterval = null;

    async function setupDailyClaim() {
      if (!currentUserId) return; // Only run if logged in

      const userDocRef = doc(db, 'users', currentUserId);
      const userDocSnap = await getDoc(userDocRef);
      if (!userDocSnap.exists()) return;

      const userData = userDocSnap.data();
      const lastClaimedTimestamp = userData.lastClaimed ? userData.lastClaimed.toDate().getTime() : 0;
      const now = Date.now();
      const timeElapsed = now - lastClaimedTimestamp;

      if (countdownInterval) {
        clearInterval(countdownInterval); // Clear previous interval
      }

      if (timeElapsed >= CLAIM_INTERVAL_MS) {
        // Ready to claim
        claimButton.disabled = false;
        claimButton.classList.add('ready');
        claimButton.textContent = 'Claim Now!';
        countdownTimerDisplay.style.display = 'none';
        claimStatusDisplay.textContent = 'Your daily reward is ready!';
      } else {
        // Cooldown active
        claimButton.disabled = true;
        claimButton.classList.remove('ready');
        claimButton.textContent = 'Claim Cooldown';
        countdownTimerDisplay.style.display = 'block';
        claimStatusDisplay.textContent = 'Come back later!';

        const updateCountdown = () => {
          const remainingTime = CLAIM_INTERVAL_MS - (Date.now() - lastClaimedTimestamp);
          if (remainingTime <= 0) {
            clearInterval(countdownInterval);
            setupDailyClaim(); // Re-evaluate status
          } else {
            countdownTimerDisplay.textContent = `Next claim in: ${formatTime(remainingTime)}`;
          }
        };

        updateCountdown();
        countdownInterval = setInterval(updateCountdown, 1000);
      }
    }

    claimButton.addEventListener('click', async () => {
      if (!currentUserId || claimButton.disabled) return;

      claimButton.disabled = true; // Prevent double click
      claimStatusDisplay.textContent = 'Processing claim...';

      try {
        await runTransaction(db, async (transaction) => {
          const userDocRef = doc(db, 'users', currentUserId);
          const userDocSnap = await transaction.get(userDocRef);

          if (!userDocSnap.exists()) {
            throw "User document does not exist!";
          }

          const userData = userDocSnap.data();
          const lastClaimedTimestamp = userData.lastClaimed ? userData.lastClaimed.toDate().getTime() : 0;
          const now = Date.now();
          const timeElapsed = now - lastClaimedTimestamp;

          if (timeElapsed < CLAIM_INTERVAL_MS) {
            throw "Daily reward is not ready yet.";
          }

          // Add coins and update lastClaimed timestamp
          transaction.update(userDocRef, {
            realmCoins: increment(100), // Reward 100 coins
            lastClaimed: serverTimestamp()
          });
        });

        displayMessage('Successfully claimed 100 Realm Coins!', 'success');
        // Update UI
        const userDocSnap = await getDoc(doc(db, 'users', currentUserId));
        if (userDocSnap.exists()) {
          document.getElementById('total-coins').textContent = userDocSnap.data().realmCoins.toLocaleString();
        }
        setupDailyClaim(); // Re-initialize cooldown
      } catch (error) {
        console.error("Daily claim error:", error);
        if (typeof error === 'string') {
          displayMessage(error, 'error');
        } else {
          displayMessage('Failed to claim daily reward: ' + error.message, 'error');
        }
        claimButton.disabled = false; // Re-enable if transaction failed
        setupDailyClaim(); // Re-initialize cooldown to reflect actual state
      }
    });

    // --- Shop System ---
    const shopItemGrid = document.getElementById('shop-item-grid');
    const adminShopList = document.getElementById('admin-shop-list');

    async function setupShopItems() {
      await fetchShopItems();
    }

    async function fetchShopItems() {
      try {
        const q = query(collection(db, 'shopItems'), orderBy('price', 'asc'));
        const querySnapshot = await getDocs(q);
        shopItemGrid.innerHTML = ''; // Clear current items

        if (querySnapshot.empty) {
          shopItemGrid.innerHTML = '<p style="text-align: center; width: 100%;">No items currently available in the shop.</p>';
          return;
        }

        querySnapshot.forEach(doc => {
          const item = doc.data();
          const itemId = doc.id;
          const isSoldOut = item.stock <= 0;
          const itemElement = document.createElement('div');
          itemElement.classList.add('shop-item-card');
          if (isSoldOut) {
            itemElement.classList.add('sold-out');
          }
          itemElement.innerHTML = `
            <img src="${item.imageUrl || 'https://via.placeholder.com/150'}" alt="${item.name}">
            <h3>${item.name}</h3>
            <p>${item.description}</p>
            <p class="shop-item-price"><i class="fas fa-coins"></i> ${item.price.toLocaleString()}</p>
            <p style="font-size:0.9em; color: var(--text-secondary);">Stock: ${item.stock > 0 ? item.stock : 'Sold Out'}</p>
            <button class="buy-button" data-id="${itemId}" ${isSoldOut || !currentUserId ? 'disabled' : ''}>${isSoldOut ? 'Sold Out' : 'Buy Now'}</button>
          `;
          shopItemGrid.appendChild(itemElement);
        });

        // Attach buy event listeners
        shopItemGrid.querySelectorAll('.buy-button').forEach(button => {
          button.addEventListener('click', async (e) => {
            const itemId = e.target.dataset.id;
            await buyShopItem(itemId);
          });
        });

      } catch (error) {
        console.error("Error fetching shop items:", error);
        displayMessage('Error loading shop items.', 'error');
      }
    }

    async function buyShopItem(itemId) {
      if (!currentUserId) {
        displayMessage('Please log in to purchase items.', 'error');
        openModal(loginModalOverlay);
        return;
      }

      try {
        await runTransaction(db, async (transaction) => {
          const userDocRef = doc(db, 'users', currentUserId);
          const itemDocRef = doc(db, 'shopItems', itemId);

          const userDocSnap = await transaction.get(userDocRef);
          const itemDocSnap = await transaction.get(itemDocRef);

          if (!userDocSnap.exists()) {
            throw "User data not found.";
          }
          if (!itemDocSnap.exists()) {
            throw "Item not found in shop.";
          }

          const userData = userDocSnap.data();
          const itemData = itemDocSnap.data();

          if (itemData.stock <= 0) {
            throw "Item is out of stock!";
          }
          if (userData.realmCoins < itemData.price) {
            throw "Not enough Realm Coins to purchase this item.";
          }

          // Update user's coins and inventory
          transaction.update(userDocRef, {
            realmCoins: increment(-itemData.price),
            inventory: [...userData.inventory, {
              id: itemDocSnap.id,
              name: itemData.name,
              imageUrl: itemData.imageUrl,
              purchasedAt: serverTimestamp()
            }]
          });

          // Decrease item stock
          transaction.update(itemDocRef, {
            stock: increment(-1)
          });
        });

        displayMessage('Purchase successful! Item added to your inventory.', 'success');
        // Update UI
        const userDocSnap = await getDoc(doc(db, 'users', currentUserId));
        if (userDocSnap.exists()) {
          document.getElementById('total-coins').textContent = userDocSnap.data().realmCoins.toLocaleString();
          document.getElementById('total-items').textContent = userDocSnap.data().inventory.length.toLocaleString();
        }
        fetchShopItems(); // Re-render shop to show updated stock
      } catch (error) {
        console.error("Purchase error:", error);
        if (typeof error === 'string') {
          displayMessage(error, 'error');
        } else {
          displayMessage('Purchase failed: ' + error.message, 'error');
        }
      }
    }

    // Admin Add Shop Item
    const addShopItemButton = document.getElementById('add-shop-item-button');
    const shopItemNameInput = document.getElementById('shop-item-name');
    const shopItemDescriptionInput = document.getElementById('shop-item-description');
    const shopItemImageUrlInput = document.getElementById('shop-item-image-url');
    const shopItemPriceInput = document.getElementById('shop-item-price');
    const shopItemStockInput = document.getElementById('shop-item-stock');

    addShopItemButton.addEventListener('click', async () => {
      const name = shopItemNameInput.value.trim();
      const description = shopItemDescriptionInput.value.trim();
      const imageUrl = shopItemImageUrlInput.value.trim();
      const price = parseInt(shopItemPriceInput.value);
      const stock = parseInt(shopItemStockInput.value);

      if (!name || !description || !imageUrl || isNaN(price) || price <= 0 || isNaN(stock) || stock < 0) {
        displayMessage('Please fill all fields correctly for the shop item.', 'error');
        return;
      }

      try {
        await setDoc(doc(collection(db, 'shopItems')), {
          name: name,
          description: description,
          imageUrl: imageUrl,
          price: price,
          stock: stock,
          createdAt: serverTimestamp()
        });
        displayMessage('Shop item added successfully!', 'success');
        shopItemNameInput.value = '';
        shopItemDescriptionInput.value = '';
        shopItemImageUrlInput.value = '';
        shopItemPriceInput.value = '';
        shopItemStockInput.value = '1';
        fetchShopItems(); // Refresh shop list
        renderAdminShopItems(); // Refresh admin shop list
      } catch (error) {
        console.error("Error adding shop item:", error);
        displayMessage('Failed to add shop item: ' + error.message, 'error');
      }
    });

    // Admin Delete Shop Item
    async function deleteShopItem(itemId) {
      try {
        await deleteDoc(doc(db, 'shopItems', itemId));
        displayMessage('Shop item deleted successfully!', 'success');
        fetchShopItems(); // Refresh shop list
        renderAdminShopItems(); // Refresh admin list
      } catch (error) {
        console.error("Error deleting shop item:", error);
        displayMessage('Failed to delete shop item: ' + error.message, 'error');
      }
    }

    // Render Admin Shop Items for management
    async function renderAdminShopItems() {
      if (!isAdmin) {
        adminShopList.innerHTML = '<p style="color: var(--warning);">You are not authorized to view this content.</p>';
        return;
      }
      try {
        const q = query(collection(db, 'shopItems'), orderBy('createdAt', 'desc'));
        const querySnapshot = await getDocs(q);
        adminShopList.innerHTML = ''; // Clear current list

        if (querySnapshot.empty) {
          adminShopList.innerHTML = '<p>No shop items found.</p>';
          return;
        }

        querySnapshot.forEach(doc => {
          const item = doc.data();
          const itemId = doc.id;
          const listItem = document.createElement('div');
          listItem.classList.add('admin-list-item');
          listItem.innerHTML = `
            <div class="admin-list-item-content">
              <h4>${item.name} (${item.stock} in stock)</h4>
              <p>${item.price.toLocaleString()} coins</p>
            </div>
            <div class="admin-list-item-actions">
              <button class="delete" data-id="${itemId}"><i class="fas fa-trash"></i> Delete</button>
            </div>
          `;
          adminShopList.appendChild(listItem);
        });

        // Attach delete event listeners for admin list
        adminShopList.querySelectorAll('.delete').forEach(button => {
          button.addEventListener('click', async (e) => {
            const itemId = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this shop item?')) {
              await deleteShopItem(itemId);
            }
          });
        });
      } catch (error) {
        console.error("Error rendering admin shop items:", error);
        displayMessage('Error loading admin shop list.', 'error');
      }
    }

    // --- Admin Send Realm Coins to a User ---
    const adminRecipientDisplayNameInput = document.getElementById('admin-recipient-display-name');
    const adminSendCoinsAmountInput = document.getElementById('admin-send-coins-amount-input');
    const adminSendCoinsToUserButton = document.getElementById('admin-send-coins-to-user-button');

    adminSendCoinsToUserButton.addEventListener('click', async () => {
      if (!isAdmin) {
        displayMessage('You are not authorized to perform this action.', 'error');
        return;
      }

      const recipientDisplayName = adminRecipientDisplayNameInput.value.trim();
      const amount = parseInt(adminSendCoinsAmountInput.value);

      if (!recipientDisplayName) {
        displayMessage('Please enter a recipient display name.', 'error');
        return;
      }

      if (isNaN(amount) || amount <= 0) {
        displayMessage('Please enter a valid positive number for Realm Coins.', 'error');
        return;
      }

      displayMessage(`Attempting to send ${amount} Realm Coins to ${recipientDisplayName}...`, 'info', 5000);

      try {
        await runTransaction(db, async (transaction) => {
          const usersRef = collection(db, 'users');
          // Query for a user by their username (displayName)
          // NOTE: For efficient querying by 'username', you might need to create a Firestore index.
          // Go to your Firestore console -> Indexes tab to create a single-field index on 'username'.
          const q = query(usersRef, where('username', '==', recipientDisplayName));
          const querySnapshot = await transaction.get(q);

          if (querySnapshot.empty) {
            throw new Error(`User with display name "${recipientDisplayName}" not found.`);
          }
          if (querySnapshot.docs.length > 1) {
            // This case should ideally not happen if usernames are unique, but good to handle
            throw new Error(`Multiple users found with display name "${recipientDisplayName}". Please specify a unique identifier if possible.`);
          }

          const recipientDoc = querySnapshot.docs[0];
          const recipientDocRef = recipientDoc.ref;
          const recipientData = recipientDoc.data();

          // Update recipient's coins
          transaction.update(recipientDocRef, {
            realmCoins: increment(amount)
          });
        });

        displayMessage(`Successfully sent ${amount} Realm Coins to ${recipientDisplayName}!`, 'success');
        adminRecipientDisplayNameInput.value = ''; // Clear input
        adminSendCoinsAmountInput.value = '100'; // Reset amount
      } catch (error) {
        console.error('Error sending coins to user:', error);
        displayMessage('Failed to send coins: ' + error.message, 'error');
      }
    });


    // --- Canvas Background Animation ---
    const canvas = document.getElementById('backgroundCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    const PARTICLE_COUNT = 150;
    const PARTICLE_SIZE = 1.5;
    const PARTICLE_SPEED = 0.3;
    const PARTICLE_COLOR = 'rgba(0, 204, 255, 0.7)'; // Primary color with some transparency
    const LINE_DISTANCE = 100; // Max distance for lines

    // Resize canvas to fill window
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    // Particle class
    class Particle {
      constructor(x, y) {
        this.x = x || Math.random() * canvas.width;
        this.y = y || Math.random() * canvas.height;
        this.size = Math.random() * PARTICLE_SIZE + 1;
        this.speedX = (Math.random() * PARTICLE_SPEED * 2) - PARTICLE_SPEED;
        this.speedY = (Math.random() * PARTICLE_SPEED * 2) - PARTICLE_SPEED;
      }

      update() {
        this.x += this.speedX;
        this.y += this.speedY;

        // Bounce off edges
        if (this.x > canvas.width || this.x < 0) {
          this.speedX *= -1;
        }
        if (this.y > canvas.height || this.y < 0) {
          this.speedY *= -1;
        }
      }

      draw() {
        ctx.fillStyle = PARTICLE_COLOR;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // Initialize particles
    function initParticles() {
      particles = [];
      for (let i = 0; i < PARTICLE_COUNT; i++) {
        particles.push(new Particle());
      }
    }

    // Animate particles
    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

      for (let i = 0; i < particles.length; i++) {
        particles[i].update();
        particles[i].draw();

        // Draw lines between close particles
        for (let j = i; j < particles.length; j++) {
          const p1 = particles[i];
          const p2 = particles[j];
          const distance = Math.sqrt(
            Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)
          );

          if (distance < LINE_DISTANCE) {
            ctx.strokeStyle = `rgba(0, 204, 255, ${1 - (distance / LINE_DISTANCE)})`; // Fade lines
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.stroke();
          }
        }
      }
      requestAnimationFrame(animateParticles);
    }

    // Initial setup
    window.addEventListener('resize', () => {
      resizeCanvas();
      initParticles(); // Re-initialize particles on resize
    });
    resizeCanvas();
    initParticles();
    animateParticles();


    // --- Spin the Wheel Game ---
    const wheelCanvas = document.getElementById('wheelCanvas');
    const wheelCtx = wheelCanvas.getContext('2d');
    const spinButton = document.getElementById('spin-button');
    const spinCostDisplay = document.getElementById('current-spin-cost');
    const spinCooldownDisplay = document.getElementById('spin-cooldown');
    const spinRewardInfo = document.getElementById('spin-reward-info');

    // Spin wheel segments (value, color, rarity)
    const wheelSegments = [{
      value: 50,
      color: '#00ccff',
      text: '50 Coins',
      rarity: 'common'
    }, {
      value: 0,
      color: '#ff4d4d',
      text: 'Lost Turn',
      rarity: 'common'
    }, {
      value: 150,
      color: '#00ff88',
      text: '150 Coins',
      rarity: 'uncommon'
    }, {
      value: 0,
      color: '#ff4d4d',
      text: 'Lost Turn',
      rarity: 'common'
    }, {
      value: 250,
      color: '#5555ff',
      text: '250 Coins',
      rarity: 'rare'
    }, {
      value: 0,
      color: '#ff4d4d',
      text: 'Lost Turn',
      rarity: 'common'
    }, {
      value: 500,
      color: '#ffaa00',
      text: '500 Coins',
      rarity: 'legendary'
    }, {
      value: 0,
      color: '#ff4d4d',
      text: 'Lost Turn',
      rarity: 'common'
    }, {
      value: 1000,
      color: '#ff00ff',
      text: '1000 Coins',
      rarity: 'mythical'
    }, {
      value: 0,
      color: '#ff4d4d',
      text: 'Lost Turn',
      rarity: 'common'
    }, ];
    const numSegments = wheelSegments.length;
    const arcSize = (2 * Math.PI) / numSegments;
    const wheelRadius = wheelCanvas.width / 2;

    let isSpinning = false;
    const FREE_SPIN_COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24 hours
    const PAID_SPIN_COOLDOWN_MS = 5 * 60 * 1000; // 5 minutes
    const PAID_SPIN_COST = 100;

    // Draw the wheel
    function drawWheel() {
      wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
      wheelCtx.strokeStyle = 'var(--border)';
      wheelCtx.lineWidth = 2;

      for (let i = 0; i < numSegments; i++) {
        const angle = i * arcSize;
        wheelCtx.fillStyle = wheelSegments[i].color;

        wheelCtx.beginPath();
        wheelCtx.arc(wheelRadius, wheelRadius, wheelRadius, angle, angle + arcSize);
        wheelCtx.lineTo(wheelRadius, wheelRadius);
        wheelCtx.fill();
        wheelCtx.stroke();

        wheelCtx.save();
        wheelCtx.translate(wheelRadius, wheelRadius);
        wheelCtx.rotate(angle + arcSize / 2 + Math.PI / 2);
        wheelCtx.textAlign = 'center';
        wheelCtx.fillStyle = '#0a0a0a';
        wheelCtx.font = 'bold 16px Arial';
        wheelCtx.fillText(wheelSegments[i].text, 0, -wheelRadius + 30);
        wheelCtx.restore();
      }
    }

    // Spin animation and result
    function spinWheel(resultIndex, callback) {
      isSpinning = true;
      const totalRotations = 5; // At least 5 full rotations
      // Calculate target angle to land on the center of the result segment
      // The wheel is drawn clockwise, 0deg is right. Pointer is at top (270deg).
      // So, we need to rotate to (segment start angle + half segment size) from the 270deg mark.
      const targetAngleRad = (resultIndex * arcSize) + (arcSize / 2);
      const startAngleOffset = (Math.PI / 2); // Wheel starts at 0 (right), pointer is at top (PI/2 or 90 deg clockwise)
      const normalizedTargetAngle = (2 * Math.PI - (targetAngleRad + startAngleOffset)) % (2 * Math.PI);

      const finalAngle = (totalRotations * 2 * Math.PI) + normalizedTargetAngle;

      wheelCanvas.style.transition = 'transform 4s cubic-bezier(0.25, 0.1, 0.25, 1)';
      wheelCanvas.style.transform = `rotate(${finalAngle}rad)`;

      setTimeout(() => {
        isSpinning = false;
        wheelCanvas.style.transition = 'none'; // Reset transition for next spin
        // Adjust current rotation to be ready for next spin without jumping
        const currentRotation = finalAngle % (2 * Math.PI);
        wheelCanvas.style.transform = `rotate(${currentRotation}rad)`;
        if (callback) callback();
      }, 4000);
    }

    // Determine spin type (free/paid)
    async function getSpinType() {
      if (!currentUserId) return 'none';

      const userDocRef = doc(db, 'users', currentUserId);
      const userDocSnap = await getDoc(userDocRef);
      if (!userDocSnap.exists()) return 'none';

      const userData = userDocSnap.data();
      const now = Date.now();

      const lastFreeSpinTimestamp = userData.spinWheelCooldowns?.freeSpin ? userData.spinWheelCooldowns.freeSpin.toDate().getTime() : 0;
      const freeSpinReady = (now - lastFreeSpinTimestamp) >= FREE_SPIN_COOLDOWN_MS;

      if (freeSpinReady) {
        return 'free';
      } else if (userData.realmCoins >= PAID_SPIN_COST) {
        return 'paid';
      } else {
        return 'none'; // Not enough coins, free spin not ready
      }
    }

    // Update spin button and cooldown display
    let spinCooldownInterval = null;

    async function updateSpinUI() {
      if (!currentUserId) {
        spinButton.disabled = true;
        spinButton.textContent = 'Login to Spin';
        spinCostDisplay.style.display = 'none';
        spinCooldownDisplay.style.display = 'none';
        spinRewardInfo.textContent = '';
        return;
      }

      const userDocRef = doc(db, 'users', currentUserId);
      const userDocSnap = await getDoc(userDocRef);
      const userData = userDocSnap.data();
      const now = Date.now();

      const lastFreeSpinTimestamp = userData.spinWheelCooldowns?.freeSpin ? userData.spinWheelCooldowns.freeSpin.toDate().getTime() : 0;
      const lastPaidSpinTimestamp = userData.spinWheelCooldowns?.paidSpin ? userData.spinWheelCooldowns.paidSpin.toDate().getTime() : 0;

      const freeSpinRemaining = FREE_SPIN_COOLDOWN_MS - (now - lastFreeSpinTimestamp);
      const paidSpinRemaining = PAID_SPIN_COOLDOWN_MS - (now - lastPaidSpinTimestamp);

      // Clear existing interval
      if (spinCooldownInterval) {
        clearInterval(spinCooldownInterval);
      }

      if (freeSpinRemaining <= 0) {
        // Free spin is ready
        spinButton.disabled = false;
        spinButton.textContent = 'Spin for Free!';
        spinButton.classList.add('ready');
        spinCostDisplay.style.display = 'none';
        spinCooldownDisplay.style.display = 'none';
        spinRewardInfo.textContent = 'A free spin is available!';
      } else if (userData.realmCoins >= PAID_SPIN_COST && paidSpinRemaining <= 0) {
        // Paid spin is ready
        spinButton.disabled = false;
        spinButton.textContent = 'Spin (Cost: ' + PAID_SPIN_COST + ' Coins)';
        spinButton.classList.remove('ready');
        spinCostDisplay.style.display = 'block';
        spinCostDisplay.querySelector('#current-spin-cost').textContent = PAID_SPIN_COST.toLocaleString();
        spinCooldownDisplay.style.display = 'none';
        spinRewardInfo.textContent = 'Use your coins for another spin!';
      } else {
        // Both on cooldown or not enough coins
        spinButton.disabled = true;
        spinButton.textContent = 'Spin Cooldown';
        spinButton.classList.remove('ready');
        spinCostDisplay.style.display = 'block';
        spinCostDisplay.querySelector('#current-spin-cost').textContent = PAID_SPIN_COST.toLocaleString();
        spinCooldownDisplay.style.display = 'block';

        const updateCountdown = () => {
          const now = Date.now();
          const currentFreeRemaining = FREE_SPIN_COOLDOWN_MS - (now - lastFreeSpinTimestamp);
          const currentPaidRemaining = PAID_SPIN_COOLDOWN_MS - (now - lastPaidSpinTimestamp);

          if (currentFreeRemaining <= 0) {
            clearInterval(spinCooldownInterval);
            updateSpinUI(); // Recalculate if free spin is ready
          } else if (userData.realmCoins >= PAID_SPIN_COST && currentPaidRemaining <= 0) {
            clearInterval(spinCooldownInterval);
            updateSpinUI(); // Recalculate if paid spin is ready
          } else {
            const nextReadyTime = Math.min(
              currentFreeRemaining > 0 ? currentFreeRemaining : Infinity,
              currentPaidRemaining > 0 ? currentPaidRemaining : Infinity
            );
            if (nextReadyTime === Infinity) {
              spinCooldownDisplay.textContent = 'Not enough coins for paid spin.';
              spinRewardInfo.textContent = '';
            } else {
              spinCooldownDisplay.textContent = `Next spin in: ${formatTime(nextReadyTime)}`;
              spinRewardInfo.textContent = `Need ${PAID_SPIN_COST} coins for a paid spin.`;
            }
          }
        };
        updateCountdown();
        spinCooldownInterval = setInterval(updateCountdown, 1000);
      }
    }

    async function setupSpinTheWheel() {
      drawWheel();
      await updateSpinUI();
    }

    spinButton.addEventListener('click', async () => {
      if (isSpinning || spinButton.disabled || !currentUserId) return;

      spinButton.disabled = true; // Disable during spin
      spinRewardInfo.textContent = 'Spinning...';

      const spinType = await getSpinType(); // Check again right before spin
      let cost = 0;
      let cooldownField = null;

      if (spinType === 'free') {
        cost = 0;
        cooldownField = 'freeSpin';
      } else if (spinType === 'paid') {
        cost = PAID_SPIN_COST;
        cooldownField = 'paidSpin';
      } else {
        displayMessage('Spin not ready or not enough coins.', 'error');
        spinButton.disabled = false; // Re-enable if rules prevent spin
        updateSpinUI();
        return;
      }

      try {
        await runTransaction(db, async (transaction) => {
          const userDocRef = doc(db, 'users', currentUserId);
          const userDocSnap = await transaction.get(userDocRef);

          if (!userDocSnap.exists()) {
            throw "User data not found.";
          }

          const userData = userDocSnap.data();
          const currentCoins = userData.realmCoins;

          // Double check cooldowns to prevent race conditions
          const lastSpinTimestamp = userData.spinWheelCooldowns?.[cooldownField] ? userData.spinWheelCooldowns[cooldownField].toDate().getTime() : 0;
          const now = Date.now();
          const cooldownDuration = (cooldownField === 'freeSpin') ? FREE_SPIN_COOLDOWN_MS : PAID_SPIN_COOLDOWN_MS;

          if ((now - lastSpinTimestamp) < cooldownDuration) {
            throw `Spin not ready. Cooldown active for ${cooldownField}.`;
          }

          if (cost > 0 && currentCoins < cost) {
            throw "Not enough Realm Coins for this spin!";
          }

          // Simulate spin result (random selection)
          const resultIndex = Math.floor(Math.random() * numSegments);
          const reward = wheelSegments[resultIndex].value;
          const rewardText = wheelSegments[resultIndex].text;

          // Update user's coins and cooldown
          transaction.update(userDocRef, {
            realmCoins: increment(reward - cost),
            [`spinWheelCooldowns.${cooldownField}`]: serverTimestamp(),
            // Ensure spinWheelCooldowns object exists
            spinWheelCooldowns: {
              ...(userData.spinWheelCooldowns || {}),
              [cooldownField]: serverTimestamp()
            }
          });

          // Perform the actual wheel spin animation
          spinWheel(resultIndex, async () => {
            if (reward > 0) {
              displayMessage(`Congratulations! You won ${rewardText}!`, 'success');
            } else {
              displayMessage(`Unlucky! You got ${rewardText}.`, 'info');
            }
            // Update UI after transaction completes and animation finishes
            const userDocSnapAfterSpin = await getDoc(userDocRef);
            if (userDocSnapAfterSpin.exists()) {
              document.getElementById('total-coins').textContent = userDocSnapAfterSpin.data().realmCoins.toLocaleString();
            }
            updateSpinUI(); // Re-evaluate spin button state and cooldown
          });
        });
      } catch (error) {
        console.error("Spin wheel error:", error);
        if (typeof error === 'string') {
          displayMessage(error, 'error');
        } else {
          displayMessage('Spin failed: ' + error.message, 'error');
        }
        spinButton.disabled = false; // Re-enable if transaction failed
        updateSpinUI(); // Re-evaluate spin button state and cooldown
      }
    });

    // --- Trade Calculator ---
    const yourItemNameInput = document.getElementById('your-item-name');
    const yourItemValueInput = document.getElementById('your-item-value');
    const yourItemRaritySelect = document.getElementById('your-item-rarity');
    const addYourItemBtn = document.getElementById('add-your-item-btn');
    const yourItemsList = document.getElementById('your-items-list');
    const yourTotalValueSpan = document.getElementById('your-total-value');

    const theirItemNameInput = document.getElementById('their-item-name');
    const theirItemValueInput = document.getElementById('their-item-value');
    const theirItemRaritySelect = document.getElementById('their-item-rarity');
    const addTheirItemBtn = document.getElementById('add-their-item-btn');
    const theirItemsList = document.getElementById('their-items-list');
    const theirTotalValueSpan = document.getElementById('their-total-value');

    const calculateTradeBtn = document.getElementById('calculate-trade-btn');
    const tradeResultDiv = document.getElementById('trade-result');

    let yourItems = [];
    let theirItems = [];

    const rarityColors = {
      common: 'var(--common)',
      uncommon: 'var(--uncommon)',
      rare: 'var(--rare)',
      legendary: 'var(--legendary)',
      mythical: 'var(--mythical)'
    };

    function calculateTotalValue(items) {
      return items.reduce((sum, item) => sum + item.value, 0);
    }

    function renderItems(items, listElement, totalValueSpan) {
      listElement.innerHTML = '';
      items.forEach((item, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span class="rarity-${item.rarity}">${item.name} (Value: ${item.value})</span>
          <button class="remove-item-btn" data-index="${index}">&times;</button>
        `;
        listElement.appendChild(li);
      });
      totalValueSpan.textContent = calculateTotalValue(items).toLocaleString();
    }

    function addItem(nameInput, valueInput, raritySelect, itemsArray, listElement, totalValueSpan) {
      const name = nameInput.value.trim();
      const value = parseInt(valueInput.value);
      const rarity = raritySelect.value;

      if (!name || isNaN(value) || value < 0) {
        displayMessage('Please enter a valid name and value for the item.', 'error');
        return;
      }

      itemsArray.push({
        name,
        value,
        rarity
      });
      renderItems(itemsArray, listElement, totalValueSpan);

      // Clear inputs
      nameInput.value = '';
      valueInput.value = '0';
      raritySelect.value = 'common';
    }

    function removeItem(index, itemsArray, listElement, totalValueSpan) {
      itemsArray.splice(index, 1);
      renderItems(itemsArray, listElement, totalValueSpan);
    }

    addYourItemBtn.addEventListener('click', () => {
      addItem(yourItemNameInput, yourItemValueInput, yourItemRaritySelect, yourItems, yourItemsList, yourTotalValueSpan);
    });

    addTheirItemBtn.addEventListener('click', () => {
      addItem(theirItemNameInput, theirItemValueInput, theirItemRaritySelect, theirItems, theirItemsList, theirTotalValueSpan);
    });

    yourItemsList.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-item-btn')) {
        const index = parseInt(e.target.dataset.index);
        removeItem(index, yourItems, yourItemsList, yourTotalValueSpan);
      }
    });

    theirItemsList.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-item-btn')) {
        const index = parseInt(e.target.dataset.index);
        removeItem(index, theirItems, theirItemsList, theirTotalValueSpan);
      }
    });

    calculateTradeBtn.addEventListener('click', () => {
      const yourTotal = calculateTotalValue(yourItems);
      const theirTotal = calculateTotalValue(theirItems);

      tradeResultDiv.style.display = 'block';
      tradeResultDiv.classList.remove('fair', 'unfair', 'uneven');

      if (yourTotal === theirTotal && yourTotal > 0) {
        tradeResultDiv.classList.add('fair');
        tradeResultDiv.textContent = `The trade is perfectly fair! Both sides offer ${yourTotal.toLocaleString()} coins.`;
      } else if (Math.abs(yourTotal - theirTotal) <= Math.max(yourTotal, theirTotal) * 0.10) { // Within 10% difference
        tradeResultDiv.classList.add('uneven');
        tradeResultDiv.textContent = `The trade is relatively even. Your offer: ${yourTotal.toLocaleString()}, Their offer: ${theirTotal.toLocaleString()}.`;
      } else {
        tradeResultDiv.classList.add('unfair');
        if (yourTotal > theirTotal) {
          tradeResultDiv.textContent = `The trade is unfair to them! Your offer (${yourTotal.toLocaleString()}) is much higher than theirs (${theirTotal.toLocaleString()}).`;
        } else {
          tradeResultDiv.textContent = `The trade is unfair to you! Their offer (${theirTotal.toLocaleString()}) is much higher than yours (${yourTotal.toLocaleString()}).`;
        }
      }
      displayMessage('Trade fairness calculated!', 'info');
    });


    // --- Initialization on load ---
    window.addEventListener('load', () => {
      // Setup background canvas
      resizeCanvas();
      initParticles();
      animateParticles();
      // Auth state listener handles initial setup of UI
    });
  </script>
</body>
</html>